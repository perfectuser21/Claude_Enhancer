# ╔══════════════════════════════════════════════════════════╗
# ║  Claude Enhancer 自愈系统配置文件                          ║
# ║  Self-Healing System Configuration                       ║
# ║  Version: 6.2.0                                          ║
# ╚══════════════════════════════════════════════════════════╝

# ═══════════════════════════════════════════════════════════
# 1. 系统定位约束 (System Positioning Constraints)
# ═══════════════════════════════════════════════════════════
positioning:
  # 明确定位：个人工具，不是企业级系统
  is_enterprise: false
  is_team_tool: false
  is_personal: true

  # 目标用户画像
  target_user: "编程小白 + Claude Max 20X用户"

  # 核心价值主张
  value_proposition: "AI驱动的个人开发工作流系统"

  # 禁止的声称
  forbidden_claims:
    - "企业级系统"
    - "生产级部署"
    - "团队协作平台"
    - "SaaS服务"

# ═══════════════════════════════════════════════════════════
# 2. 功能复杂度阈值 (Feature Complexity Thresholds)
# ═══════════════════════════════════════════════════════════
thresholds:
  # BDD场景数量限制
  max_bdd_scenarios: 15
  max_bdd_features: 5
  current_bdd_scenarios: 65  # 超标：65 vs 15

  # 工作流数量限制
  max_workflows: 8
  current_workflows: 15  # 超标：15 vs 8

  # Claude Hooks数量限制
  max_claude_hooks: 8
  current_claude_hooks: 29  # 超标：29 vs 8

  # 性能指标数量限制
  max_performance_metrics: 20
  current_performance_metrics: 90  # 超标：90 vs 20

  # SLO定义数量限制
  max_slo_definitions: 5
  current_slo_definitions: 15  # 超标：15 vs 5

  # 文档行数限制
  max_claude_md_lines: 400
  current_claude_md_lines: 676  # 超标：676 vs 400

  # 自动化率真实上限
  max_automation_rate: 85
  claimed_automation_rate: 95  # 虚高：95% vs 实际70%

# ═══════════════════════════════════════════════════════════
# 3. 版本管理约束 (Version Management Constraints)
# ═══════════════════════════════════════════════════════════
versioning:
  # 单一真相来源
  source_of_truth: "VERSION"

  # 当前版本（自动同步）
  current_version: "6.2.0"

  # 允许的版本号（其他视为冲突）
  allowed_versions: ["6.2.0"]

  # 版本引用位置（需自动同步）
  sync_locations:
    - "VERSION"
    - "package.json"
    - "CLAUDE.md"
    - "README.md"
    - "CHANGELOG.md"
    - ".claude/settings.json"

  # 禁止的混乱版本号
  forbidden_versions:
    - "5.3"   # 已废弃
    - "6.0"   # 已过时
    - "6.1"   # 中间版本

# ═══════════════════════════════════════════════════════════
# 4. 文档管理规则 (Documentation Management Rules)
# ═══════════════════════════════════════════════════════════
documentation:
  # 核心文档白名单（只能更新，禁止新增）
  core_files:
    - "README.md"
    - "CLAUDE.md"
    - "INSTALLATION.md"
    - "ARCHITECTURE.md"
    - "CONTRIBUTING.md"
    - "CHANGELOG.md"
    - "LICENSE.md"

  # 最大根目录文档数
  max_root_docs: 7

  # CLAUDE.md位置约束
  claude_md_locations:
    allowed: 1  # 只允许项目级
    paths:
      - "/home/xx/dev/Claude Enhancer 5.0/CLAUDE.md"  # 项目级（主）
    forbidden:
      - "/root/.claude/CLAUDE.md"  # 全局级（冲突源）

  # 文档生命周期管理
  lifecycle:
    temp:
      path: ".temp/"
      ttl_days: 7
      auto_cleanup: true
    evidence:
      path: "evidence/"
      ttl_days: 30
      auto_archive: true
    archive:
      path: "docs/_archive/"
      ttl_days: 365
      review_required: true

# ═══════════════════════════════════════════════════════════
# 5. 企业功能开关 (Enterprise Features Toggle)
# ═══════════════════════════════════════════════════════════
enterprise_features:
  # 默认全部禁用（个人工具不需要）
  canary_deployment: false
  slo_monitoring: false
  advanced_bdd: false
  performance_budgets: false
  observability: false
  chaos_engineering: false

  # 解释：为什么禁用
  rationale: "个人工具无需企业级功能，保持简单"

# ═══════════════════════════════════════════════════════════
# 6. Hooks行为规范 (Hooks Behavior Rules)
# ═══════════════════════════════════════════════════════════
hooks:
  # Hooks定位
  nature: "advisory"  # 启发性，非强制性

  # 允许的Hook类型
  allowed_types:
    - "branch_helper"           # 分支管理助手
    - "quality_gate"           # 质量检查
    - "smart_agent_selector"   # Agent选择器
    - "workflow_enforcer"      # 工作流提示
    - "pre_write_document"     # 文档写入前检查
    - "gap_scan"              # 差距扫描
    - "error_handler"         # 错误处理
    - "task_type_detector"    # 任务类型检测

  # 禁止的Hook行为
  forbidden_behaviors:
    - "硬阻止AI操作（除分支保护外）"
    - "强制要求特定工具链"
    - "限制用户选择"
    - "自动修改代码"

  # Git Hooks vs Claude Hooks
  distinction:
    git_hooks:
      nature: "mandatory"
      scope: "代码质量、分支保护"
    claude_hooks:
      nature: "advisory"
      scope: "工作流建议、提醒"

# ═══════════════════════════════════════════════════════════
# 7. 自动化率真实性 (Automation Rate Honesty)
# ═══════════════════════════════════════════════════════════
automation:
  # 真实自动化率计算
  calculation:
    total_steps: 20
    automated_steps: 14
    manual_steps: 6
    real_rate: 70  # 14/20 = 70%

  # 手动步骤清单
  manual_steps:
    - "用户触发workflow"
    - "PR approval"
    - "查看CI结果"
    - "决定是否merge"
    - "监控生产问题"
    - "手动回滚（如需要）"

  # 禁止虚高声称
  honesty_rule: "实际70%，不要声称95%"

# ═══════════════════════════════════════════════════════════
# 8. .gitignore冲突解决 (Gitignore Conflict Resolution)
# ═══════════════════════════════════════════════════════════
gitignore:
  # 冲突检测
  conflict_patterns:
    - pattern: "evidence/"
      issue: "被忽略但又需要提交"
      resolution: "移除ignore，改为保留30天"

    - pattern: ".temp/"
      issue: "临时文件应该被忽略"
      resolution: "保持ignore，7天自动清理"

  # 强制规则
  rules:
    - "证据文件必须可提交"
    - "临时文件必须被忽略"
    - "不要ignore有价值的内容"

# ═══════════════════════════════════════════════════════════
# 9. 健康检查规则 (Health Check Rules)
# ═══════════════════════════════════════════════════════════
health_checks:
  # 检查频率
  frequency:
    daily: true
    on_commit: true
    on_push: false  # 避免过于频繁

  # 检查项目
  checks:
    - id: "positioning_consistency"
      name: "定位一致性"
      severity: "critical"

    - id: "version_consistency"
      name: "版本一致性"
      severity: "critical"

    - id: "feature_complexity"
      name: "功能复杂度"
      severity: "warning"

    - id: "documentation_count"
      name: "文档数量"
      severity: "warning"

    - id: "automation_honesty"
      name: "自动化率真实性"
      severity: "info"

    - id: "gitignore_conflicts"
      name: "Gitignore冲突"
      severity: "warning"

    - id: "claude_md_duplication"
      name: "CLAUDE.md重复"
      severity: "critical"

    - id: "hooks_count"
      name: "Hooks数量"
      severity: "warning"

    - id: "workflows_count"
      name: "Workflows数量"
      severity: "warning"

  # 失败处理
  on_failure:
    action: "report"  # 仅报告，不阻止
    report_path: "evidence/health-report-{timestamp}.md"
    alert: false  # 个人项目无需告警通知

# ═══════════════════════════════════════════════════════════
# 10. 自愈行动规则 (Self-Healing Actions)
# ═══════════════════════════════════════════════════════════
self_healing:
  # 自动修复开关
  auto_fix: true

  # 允许的自动修复行为
  allowed_fixes:
    - "同步版本号"
    - "清理临时文件"
    - "归档过期证据"
    - "更新健康报告"
    - "移除重复文档（需确认）"

  # 禁止的自动修复行为
  forbidden_fixes:
    - "自动删除功能代码"
    - "自动降级功能"
    - "自动修改用户配置"
    - "自动push到远程"

  # 修复前确认规则
  confirmation_required:
    - "删除文件"
    - "修改核心配置"
    - "降级功能"

# ═══════════════════════════════════════════════════════════
# 11. 简化路线图 (Simplification Roadmap)
# ═══════════════════════════════════════════════════════════
simplification:
  # Phase 1: 清理冗余（立即执行）
  phase1:
    - "移除/root/.claude/CLAUDE.md（保留项目级）"
    - "BDD场景从65减到15"
    - "性能指标从90减到20"
    - "SLO定义从15减到5"
    - "Workflows从15减到8"
    - "Claude Hooks从29减到8"

  # Phase 2: 重新定位（7天内）
  phase2:
    - "修改所有'企业级'声称为'个人工具'"
    - "移除金丝雀部署相关代码"
    - "简化可观测性"
    - "调整自动化率声称（95%→70%）"

  # Phase 3: 文档精简（14天内）
  phase3:
    - "CLAUDE.md从676行减到400行"
    - "合并重复说明"
    - "移除过度案例"

  # Phase 4: 长期维护
  phase4:
    - "每月运行健康检查"
    - "季度评审功能必要性"
    - "持续保持简洁"

# ═══════════════════════════════════════════════════════════
# 12. AI行为约束 (AI Behavior Constraints)
# ═══════════════════════════════════════════════════════════
ai_constraints:
  # 当AI检测到违规时
  on_violation_detected:
    - "立即报告问题"
    - "提供修复建议"
    - "不要自动修复（除非明确允许）"
    - "等待用户确认"

  # AI的自我检查职责
  self_check_duties:
    - "检查定位一致性"
    - "验证版本号统一"
    - "监控功能复杂度"
    - "审查文档数量"
    - "提醒简化机会"

  # AI禁止的行为
  forbidden_ai_actions:
    - "声称企业级能力（当is_enterprise=false时）"
    - "创建超过阈值的新功能"
    - "在根目录创建新文档"
    - "使用已禁用的企业功能"

# ═══════════════════════════════════════════════════════════
# 13. 警报阈值 (Alert Thresholds)
# ═══════════════════════════════════════════════════════════
alerts:
  # 何时触发警报
  triggers:
    - condition: "bdd_scenarios > max_bdd_scenarios"
      message: "BDD场景过多，建议精简"
      severity: "warning"

    - condition: "workflows > max_workflows"
      message: "Workflow数量超标"
      severity: "warning"

    - condition: "claude_md_lines > max_claude_md_lines"
      message: "CLAUDE.md过长"
      severity: "info"

    - condition: "version_conflict_detected"
      message: "版本号不一致"
      severity: "critical"

    - condition: "multiple_claude_md_detected"
      message: "检测到重复CLAUDE.md"
      severity: "critical"

    - condition: "positioning_mismatch"
      message: "定位不一致（个人 vs 企业）"
      severity: "critical"

# ═══════════════════════════════════════════════════════════
# 14. 证据收集 (Evidence Collection)
# ═══════════════════════════════════════════════════════════
evidence:
  # 收集的证据类型
  types:
    - "健康检查报告"
    - "版本一致性验证"
    - "功能复杂度快照"
    - "文档结构分析"

  # 证据存储
  storage:
    path: "evidence/"
    format: "markdown"
    naming: "health-{check-type}-{timestamp}.md"

  # 证据保留
  retention:
    keep_days: 30
    archive_after: 30
    final_delete: 365

# ═══════════════════════════════════════════════════════════
# 15. 配置元信息 (Configuration Metadata)
# ═══════════════════════════════════════════════════════════
metadata:
  config_version: "1.0.0"
  last_updated: "2025-10-13"
  author: "Claude + Max 20X User"
  purpose: "保持Claude Enhancer健康、简洁、诚实"

  # 配置变更历史
  changelog:
    - version: "1.0.0"
      date: "2025-10-13"
      changes: "初始版本，定义自愈系统架构"

# ═══════════════════════════════════════════════════════════
# 使用说明 (Usage Instructions)
# ═══════════════════════════════════════════════════════════
#
# 1. 本配置文件是自愈系统的单一真相来源
# 2. 所有检查脚本应读取此配置
# 3. 阈值可调整，但需通过PR
# 4. AI应在每次操作前检查此配置
# 5. 定期运行: ./scripts/health-checker.sh
