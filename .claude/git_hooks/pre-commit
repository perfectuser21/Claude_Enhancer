#!/bin/bash
# Git pre-commit hook - ç¡¬é—¸é—¨æ£€æŸ¥

echo "ğŸ”’ Pre-commit Gate: æ­£åœ¨æ‰§è¡Œè´¨é‡æ£€æŸ¥..."

# æ£€æŸ¥å½“å‰é˜¶æ®µ
CURRENT_PHASE=$(cat .phase/current 2>/dev/null || echo "P1")

if [[ "$CURRENT_PHASE" < "P5" ]]; then
    echo "âŒ å½“å‰åœ¨$CURRENT_PHASEé˜¶æ®µï¼Œè¿˜ä¸èƒ½æäº¤ä»£ç "
    echo "ğŸ“ è¯·å…ˆå®ŒæˆP1-P4é˜¶æ®µ"
    exit 1
fi

# è¿è¡Œlintæ£€æŸ¥
echo "ğŸ” ä»£ç æ ¼å¼æ£€æŸ¥..."

# Pythonæ–‡ä»¶
if git diff --cached --name-only | grep -q '\.py$'; then
    # æ£€æŸ¥blackæ˜¯å¦å­˜åœ¨
    if command -v black &> /dev/null; then
        git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | xargs black --check --quiet
        if [ $? -ne 0 ]; then
            echo "âš ï¸  Pythonä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼Œè¯·è¿è¡Œ: black ."
            exit 1
        fi
    fi
    
    # æ£€æŸ¥flake8
    if command -v flake8 &> /dev/null; then
        git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | xargs flake8
        if [ $? -ne 0 ]; then
            echo "âš ï¸  Pythonä»£ç æœ‰è¯­æ³•é—®é¢˜"
            exit 1
        fi
    fi
fi

# JavaScript/TypeScriptæ–‡ä»¶
if git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx)$'; then
    if command -v eslint &> /dev/null; then
        git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' | xargs eslint
        if [ $? -ne 0 ]; then
            echo "âš ï¸  JavaScript/TypeScriptä»£ç æœ‰é—®é¢˜"
            exit 1
        fi
    fi
fi

# å®‰å…¨æ£€æŸ¥ - é¿å…æäº¤æ•æ„Ÿä¿¡æ¯
echo "ğŸ” å®‰å…¨æ£€æŸ¥..."

# æ£€æŸ¥å¸¸è§çš„æ•æ„Ÿæ¨¡å¼
SENSITIVE_PATTERNS=(
    "password.*=.*['\"]\w"
    "api[_-]?key.*=.*['\"]\w"
    "secret.*=.*['\"]\w"
    "token.*=.*['\"]\w"
    "BEGIN RSA PRIVATE KEY"
    "BEGIN DSA PRIVATE KEY"
    "BEGIN EC PRIVATE KEY"
    "BEGIN OPENSSH PRIVATE KEY"
    "AWS[A-Z0-9]{16,}"
)

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    if git diff --cached | grep -iE "$pattern"; then
        echo "ğŸš« æ£€æµ‹åˆ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯: $pattern"
        echo "ğŸ’¡ å¦‚æœè¿™æ˜¯æµ‹è¯•æ•°æ®ï¼Œè¯·ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶"
        exit 1
    fi
done

# æ–‡ä»¶å¤§å°æ£€æŸ¥
echo "ğŸ“ æ–‡ä»¶å¤§å°æ£€æŸ¥..."
MAX_FILE_SIZE=10485760  # 10MB

for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        file_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
        if [ "$file_size" -gt "$MAX_FILE_SIZE" ]; then
            echo "âŒ æ–‡ä»¶ $file è¶…è¿‡10MBé™åˆ¶"
            echo "ğŸ’¡ è¯·ä½¿ç”¨Git LFSæˆ–å‹ç¼©æ–‡ä»¶"
            exit 1
        fi
    fi
done

# æ‰§è¡Œvalidate
echo "âœ… éªŒè¯å½“å‰é˜¶æ®µ..."
python .workflow/executor/executor.py validate --phase "$CURRENT_PHASE" >/dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "âŒ $CURRENT_PHASE é˜¶æ®µéªŒè¯æœªé€šè¿‡"
    echo "ğŸ’¡ è¯·è¿è¡Œ: python .workflow/executor/executor.py validate"
    exit 1
fi

echo "âœ… Pre-commit æ£€æŸ¥é€šè¿‡"
exit 0