#!/bin/bash
# Performance-Optimized Document Quality Hooks Installer
# æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£è´¨é‡æ£€æŸ¥Hookså®‰è£…å™¨

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# å®‰è£…é…ç½®
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
CLAUDE_DIR="$REPO_ROOT/.claude"
HOOKS_DIR="$REPO_ROOT/.git/hooks"
CONFIG_DIR="$CLAUDE_DIR/config"
SCRIPTS_DIR="$CLAUDE_DIR/scripts"

echo -e "${BLUE}ðŸš€ Installing Performance-Optimized Document Quality Hooks${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# æ£€æŸ¥å‰ç½®æ¡ä»¶
check_prerequisites() {
    echo "ðŸ” Checking prerequisites..."

    # æ£€æŸ¥Gitä»“åº“
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        echo -e "${RED}âŒ Not in a Git repository${NC}"
        exit 1
    fi

    # æ£€æŸ¥Python
    if ! command -v python3 &> /dev/null; then
        echo -e "${YELLOW}âš ï¸ Python3 not found, some optimizations will be disabled${NC}"
    fi

    # æ£€æŸ¥bcï¼ˆç”¨äºŽæµ®ç‚¹è¿ç®—ï¼‰
    if ! command -v bc &> /dev/null; then
        echo -e "${YELLOW}âš ï¸ bc not found, installing...${NC}"
        # å°è¯•å®‰è£…bc
        if command -v apt-get &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y bc
        elif command -v yum &> /dev/null; then
            sudo yum install -y bc
        elif command -v brew &> /dev/null; then
            brew install bc
        else
            echo -e "${YELLOW}âš ï¸ Please install 'bc' manually for performance timing${NC}"
        fi
    fi

    echo -e "${GREEN}âœ… Prerequisites checked${NC}"
}

# åˆ›å»ºç›®å½•ç»“æž„
create_directories() {
    echo "ðŸ“ Creating directory structure..."

    mkdir -p "$CLAUDE_DIR"/{hooks,config,scripts,cache}
    mkdir -p "$HOOKS_DIR"

    echo -e "${GREEN}âœ… Directories created${NC}"
}

# å®‰è£…æ€§èƒ½ä¼˜åŒ–Hooks
install_performance_hooks() {
    echo "ðŸ”§ Installing performance-optimized hooks..."

    # å¤åˆ¶ä¸»Hookè„šæœ¬
    local hook_script="$CLAUDE_DIR/hooks/performance_optimized_hooks.sh"
    if [[ -f "$hook_script" ]]; then
        chmod +x "$hook_script"
    else
        echo -e "${RED}âŒ Hook script not found: $hook_script${NC}"
        exit 1
    fi

    # å®‰è£…Pre-commit Hook
    cat > "$HOOKS_DIR/pre-commit" << 'EOF'
#!/bin/bash
# Performance-Optimized Pre-commit Hook
# Auto-generated by Claude Enhancer

CLAUDE_DIR="$(git rev-parse --show-toplevel)/.claude"
HOOK_SCRIPT="$CLAUDE_DIR/hooks/performance_optimized_hooks.sh"

if [[ -f "$HOOK_SCRIPT" ]]; then
    exec "$HOOK_SCRIPT" "pre-commit" "$@"
else
    echo "âš ï¸ Performance hooks not found, using basic checks..."
    # Fallback to basic checks
    exit 0
fi
EOF

    # å®‰è£…Pre-push Hook
    cat > "$HOOKS_DIR/pre-push" << 'EOF'
#!/bin/bash
# Performance-Optimized Pre-push Hook
# Auto-generated by Claude Enhancer

CLAUDE_DIR="$(git rev-parse --show-toplevel)/.claude"
HOOK_SCRIPT="$CLAUDE_DIR/hooks/performance_optimized_hooks.sh"

if [[ -f "$HOOK_SCRIPT" ]]; then
    exec "$HOOK_SCRIPT" "pre-push" "$@"
else
    echo "âš ï¸ Performance hooks not found, using basic checks..."
    # Fallback to basic checks
    exit 0
fi
EOF

    # è®¾ç½®æ‰§è¡Œæƒé™
    chmod +x "$HOOKS_DIR/pre-commit"
    chmod +x "$HOOKS_DIR/pre-push"

    echo -e "${GREEN}âœ… Performance hooks installed${NC}"
}

# å®‰è£…Pythonä¾èµ–
install_python_dependencies() {
    echo "ðŸ Installing Python dependencies..."

    if command -v python3 &> /dev/null; then
        # æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„PythonåŒ…
        local packages=("asyncio" "pathlib" "dataclasses" "typing")
        local missing_packages=()

        for package in "${packages[@]}"; do
            if ! python3 -c "import $package" 2>/dev/null; then
                missing_packages+=("$package")
            fi
        done

        if [[ ${#missing_packages[@]} -gt 0 ]]; then
            echo "Installing missing packages: ${missing_packages[*]}"
            # è¿™äº›æ˜¯æ ‡å‡†åº“åŒ…ï¼Œåº”è¯¥å·²ç»å­˜åœ¨
            echo -e "${YELLOW}âš ï¸ Some standard library modules seem missing${NC}"
        fi

        # å°è¯•å®‰è£…å¯é€‰çš„æ€§èƒ½å¢žå¼ºåŒ…
        optional_packages=("numpy" "psutil")
        for package in "${optional_packages[@]}"; do
            if ! python3 -c "import $package" 2>/dev/null; then
                echo "Installing optional package: $package"
                pip3 install "$package" 2>/dev/null || echo "âš ï¸ Failed to install $package (optional)"
            fi
        done

        echo -e "${GREEN}âœ… Python dependencies checked${NC}"
    else
        echo -e "${YELLOW}âš ï¸ Python3 not available, skipping Python dependencies${NC}"
    fi
}

# åˆ›å»ºé…ç½®æ–‡ä»¶
create_config_files() {
    echo "âš™ï¸ Creating configuration files..."

    # æ€§èƒ½é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
    local perf_config="$CONFIG_DIR/performance_config.yaml"
    if [[ ! -f "$perf_config" ]]; then
        echo -e "${YELLOW}âš ï¸ Performance config not found, creating default...${NC}"
        # è¿™é‡Œåº”è¯¥æœ‰é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œä½†ç”±äºŽé•¿åº¦é™åˆ¶ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŸºæœ¬ç‰ˆæœ¬
        cat > "$perf_config" << 'EOF'
# Basic Performance Configuration
performance:
  mode: "balanced"
  max_workers: 4
  enable_caching: true

timeouts:
  pre_commit_seconds: 2
  pre_push_seconds: 5
  ci_deep_minutes: 2

cache:
  enabled: true
  directory: "/tmp/claude_doc_cache"
  ttl_hours: 24
EOF
    fi

    # çŽ¯å¢ƒé…ç½®
    local env_file="$CLAUDE_DIR/.env"
    cat > "$env_file" << 'EOF'
# Claude Enhancer Performance Environment Variables
CLAUDE_PERFORMANCE_MODE=balanced
CLAUDE_MAX_JOBS=4
CLAUDE_CACHE_ENABLED=true
CLAUDE_TIMEOUT_PRECOMMIT=2
CLAUDE_TIMEOUT_PREPUSH=5
EOF

    echo -e "${GREEN}âœ… Configuration files created${NC}"
}

# ä¼˜åŒ–Gité…ç½®
optimize_git_config() {
    echo "ðŸ”§ Optimizing Git configuration..."

    # è®¾ç½®Gité…ç½®ä»¥æé«˜æ€§èƒ½
    git config --local core.precomposeunicode true
    git config --local core.quotepath false

    # ä¼˜åŒ–å·®å¼‚æ£€æµ‹
    git config --local diff.algorithm patience

    echo -e "${GREEN}âœ… Git configuration optimized${NC}"
}

# åˆ›å»ºæ€§èƒ½æµ‹è¯•è„šæœ¬
create_performance_test() {
    echo "ðŸ§ª Creating performance test script..."

    cat > "$SCRIPTS_DIR/test_performance.sh" << 'EOF'
#!/bin/bash
# Performance Test Script for Document Quality Hooks

CLAUDE_DIR="$(git rev-parse --show-toplevel)/.claude"
HOOK_SCRIPT="$CLAUDE_DIR/hooks/performance_optimized_hooks.sh"

echo "ðŸš€ Running performance benchmark..."

if [[ -f "$HOOK_SCRIPT" ]]; then
    "$HOOK_SCRIPT" benchmark
else
    echo "âŒ Hook script not found"
    exit 1
fi
EOF

    chmod +x "$SCRIPTS_DIR/test_performance.sh"

    echo -e "${GREEN}âœ… Performance test script created${NC}"
}

# éªŒè¯å®‰è£…
verify_installation() {
    echo "ðŸ” Verifying installation..."

    local issues=0

    # æ£€æŸ¥Hooksæ˜¯å¦å­˜åœ¨ä¸”å¯æ‰§è¡Œ
    for hook in "pre-commit" "pre-push"; do
        local hook_file="$HOOKS_DIR/$hook"
        if [[ -f "$hook_file" && -x "$hook_file" ]]; then
            echo "âœ… $hook hook: OK"
        else
            echo "âŒ $hook hook: Missing or not executable"
            ((issues++))
        fi
    done

    # æ£€æŸ¥é…ç½®æ–‡ä»¶
    local config_file="$CONFIG_DIR/performance_config.yaml"
    if [[ -f "$config_file" ]]; then
        echo "âœ… Performance config: OK"
    else
        echo "âŒ Performance config: Missing"
        ((issues++))
    fi

    # æ£€æŸ¥ä¸»Hookè„šæœ¬
    local main_script="$CLAUDE_DIR/hooks/performance_optimized_hooks.sh"
    if [[ -f "$main_script" && -x "$main_script" ]]; then
        echo "âœ… Main hook script: OK"
    else
        echo "âŒ Main hook script: Missing or not executable"
        ((issues++))
    fi

    if [[ $issues -eq 0 ]]; then
        echo -e "${GREEN}âœ… Installation verification passed${NC}"
        return 0
    else
        echo -e "${RED}âŒ Installation verification failed ($issues issues)${NC}"
        return 1
    fi
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜Ž
show_usage_info() {
    echo ""
    echo -e "${BLUE}ðŸ“š Usage Information${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ðŸŽ¯ Performance Modes:"
    echo "  export CLAUDE_PERFORMANCE_MODE=fast      # < 1s pre-commit, < 3s pre-push"
    echo "  export CLAUDE_PERFORMANCE_MODE=balanced  # < 2s pre-commit, < 5s pre-push (default)"
    echo "  export CLAUDE_PERFORMANCE_MODE=thorough  # < 5s pre-commit, < 10s pre-push"
    echo ""
    echo "ðŸ”§ Configuration:"
    echo "  Edit: $CONFIG_DIR/performance_config.yaml"
    echo "  Env:  $CLAUDE_DIR/.env"
    echo ""
    echo "ðŸ§ª Testing:"
    echo "  Run performance test: $SCRIPTS_DIR/test_performance.sh"
    echo "  Benchmark hooks:      $CLAUDE_DIR/hooks/performance_optimized_hooks.sh benchmark"
    echo ""
    echo "ðŸ“Š Monitoring:"
    echo "  Cache directory: /tmp/claude_doc_cache"
    echo "  Logs: Check git hook output during commits/pushes"
    echo ""
    echo "ðŸš€ Quick Test:"
    echo "  git add ."
    echo "  git commit -m 'Test performance hooks'"
    echo ""
}

# ä¸»å®‰è£…æµç¨‹
main() {
    echo "Repository: $REPO_ROOT"
    echo "Claude Directory: $CLAUDE_DIR"
    echo ""

    check_prerequisites
    create_directories
    install_performance_hooks
    install_python_dependencies
    create_config_files
    optimize_git_config
    create_performance_test

    echo ""
    if verify_installation; then
        echo ""
        echo -e "${GREEN}ðŸŽ‰ Performance-optimized document quality hooks installed successfully!${NC}"
        show_usage_info
    else
        echo ""
        echo -e "${RED}âŒ Installation completed with issues. Please check the errors above.${NC}"
        exit 1
    fi
}

# å¸è½½åŠŸèƒ½
uninstall() {
    echo -e "${YELLOW}ðŸ—‘ï¸ Uninstalling performance hooks...${NC}"

    # ç§»é™¤Hooks
    rm -f "$HOOKS_DIR/pre-commit"
    rm -f "$HOOKS_DIR/pre-push"

    # ç§»é™¤é…ç½®ï¼ˆè¯¢é—®ç”¨æˆ·ï¼‰
    read -p "Remove configuration files? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$CLAUDE_DIR/hooks"
        rm -rf "$CLAUDE_DIR/config"
        rm -rf "$CLAUDE_DIR/scripts"
    fi

    # æ¸…ç†ç¼“å­˜
    rm -rf "/tmp/claude_doc_cache"

    echo -e "${GREEN}âœ… Uninstallation completed${NC}"
}

# å‘½ä»¤è¡Œå‚æ•°å¤„ç†
case "${1:-}" in
    "install"|"")
        main
        ;;
    "uninstall")
        uninstall
        ;;
    "verify")
        verify_installation
        ;;
    "test")
        if [[ -f "$SCRIPTS_DIR/test_performance.sh" ]]; then
            "$SCRIPTS_DIR/test_performance.sh"
        else
            echo "âŒ Performance test script not found"
            exit 1
        fi
        ;;
    *)
        echo "Usage: $0 [install|uninstall|verify|test]"
        echo ""
        echo "Commands:"
        echo "  install   - Install performance-optimized hooks (default)"
        echo "  uninstall - Remove hooks and optionally config"
        echo "  verify    - Verify installation"
        echo "  test      - Run performance benchmark"
        exit 1
        ;;
esac