#!/bin/bash
# Claude Enhancer - PrePromptå¼ºåˆ¶åˆ†æ”¯æ£€æŸ¥ï¼ˆè§„åˆ™0ï¼šPhase -1ï¼‰
# ç‰ˆæœ¬ï¼š1.0
# åˆ›å»ºæ—¥æœŸï¼š2025-10-15
# ç›®çš„ï¼šåœ¨AIæ€è€ƒä¹‹å‰æ³¨å…¥å¼ºåˆ¶è­¦å‘Šï¼Œç¡®ä¿100%éµå®ˆPhase -1åˆ†æ”¯æ£€æŸ¥

# ============================================
# è¿™æ˜¯PrePrompt Hook - åœ¨AIå¼€å§‹æ€è€ƒä¹‹å‰è¿è¡Œ
# åŠŸèƒ½ï¼š
# 1. æ£€æµ‹å½“å‰åˆ†æ”¯
# 2. å¦‚æœåœ¨main/masterï¼Œæ³¨å…¥å¼ºåˆ¶è­¦å‘Šåˆ°AIä¸Šä¸‹æ–‡
# 3. å¼ºåˆ¶AIåˆ›å»ºæ–°åˆ†æ”¯åæ‰èƒ½ç»§ç»­
# ============================================

# è·å–é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
LOG_FILE="$PROJECT_ROOT/.workflow/logs/claude_hooks.log"
mkdir -p "$(dirname "$LOG_FILE")"

# è®°å½•æ¿€æ´»
echo "$(date +'%F %T') [force_branch_check.sh v1.0] PrePrompt triggered" >> "$LOG_FILE"

# è·å–å½“å‰åˆ†æ”¯
current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

# å¦‚æœä¸åœ¨gitä»“åº“ï¼Œè·³è¿‡
if [[ -z "$current_branch" ]]; then
    exit 0
fi

# ============================================
# æ ¸å¿ƒé€»è¾‘ï¼šæ£€æµ‹main/masteråˆ†æ”¯
# ============================================

if [[ "$current_branch" == "main" ]] || [[ "$current_branch" == "master" ]]; then
    # æ£€æµ‹åˆ°ä¸»åˆ†æ”¯ - æ³¨å…¥å¼ºåˆ¶è­¦å‘Šåˆ°AIä¸Šä¸‹æ–‡

    cat <<'EOF' >&2

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                           â•‘
â•‘  âš ï¸ âš ï¸ âš ï¸  CRITICAL: ä½ æ­£åœ¨ MAIN/MASTER åˆ†æ”¯ä¸Šï¼ âš ï¸ âš ï¸ âš ï¸             â•‘
â•‘                                                                           â•‘
â•‘  ğŸ”´ è§„åˆ™0ï¼ˆPhase -1ï¼‰å¼ºåˆ¶è¦æ±‚ï¼šæ–°ä»»åŠ¡ = æ–°åˆ†æ”¯                          â•‘
â•‘                                                                           â•‘
â•‘  âŒ ä½ **ç¦æ­¢**åœ¨main/masteråˆ†æ”¯ä¸Šæ‰§è¡Œä»»ä½•Write/Editæ“ä½œ                 â•‘
â•‘                                                                           â•‘
â•‘  âœ… ä½ **å¿…é¡»**å…ˆæ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºæ–°åˆ†æ”¯ï¼š                                â•‘
â•‘                                                                           â•‘
â•‘     git checkout -b feature/ä»»åŠ¡æè¿°                                     â•‘
â•‘                                                                           â•‘
â•‘  ğŸ“‹ åˆ†æ”¯å‘½åè§„èŒƒï¼š                                                       â•‘
â•‘     â€¢ feature/xxx  - æ–°åŠŸèƒ½å¼€å‘                                         â•‘
â•‘     â€¢ bugfix/xxx   - Bugä¿®å¤                                            â•‘
â•‘     â€¢ perf/xxx     - æ€§èƒ½ä¼˜åŒ–                                           â•‘
â•‘     â€¢ docs/xxx     - æ–‡æ¡£æ›´æ–°                                           â•‘
â•‘     â€¢ experiment/xxx - å®éªŒæ€§æ”¹åŠ¨                                       â•‘
â•‘                                                                           â•‘
â•‘  ğŸ’¡ è¿™æ˜¯100%å¼ºåˆ¶è§„åˆ™ï¼Œä¸æ˜¯å»ºè®®ï¼                                        â•‘
â•‘     è¿åå°†å¯¼è‡´Hookç¡¬é˜»æ­¢ï¼ˆexit 1ï¼‰                                      â•‘
â•‘                                                                           â•‘
â•‘  ğŸ¯ æ­£ç¡®æµç¨‹ï¼š                                                           â•‘
â•‘     Phase -1: åˆ›å»ºåˆ†æ”¯ â† ä½ åœ¨è¿™é‡Œï¼ˆå¿…é¡»å…ˆå®Œæˆï¼‰                        â•‘
â•‘     Phase  0: æ¢ç´¢å‘ç°                                                  â•‘
â•‘     Phase  1: è§„åˆ’æ¶æ„                                                  â•‘
â•‘     Phase  2: ç¼–ç å®ç°                                                  â•‘
â•‘     Phase  3: æµ‹è¯•éªŒè¯                                                  â•‘
â•‘     Phase  4: ä»£ç å®¡æŸ¥                                                  â•‘
â•‘     Phase  5: å‘å¸ƒç›‘æ§                                                  â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF

    echo "$(date +'%F %T') [force_branch_check.sh v1.0] WARNING: AI on $current_branch, warning injected" >> "$LOG_FILE"

    # PrePrompt hookä¸åº”è¯¥é˜»æ­¢ï¼ˆexit 0ï¼‰ï¼Œè€Œæ˜¯æ³¨å…¥è­¦å‘Š
    # å®é™…é˜»æ­¢ç”±PreToolUse hook (branch_helper.sh) å®Œæˆ
    exit 0
else
    # åœ¨featureåˆ†æ”¯ä¸Š - é™é»˜é€šè¿‡
    echo "$(date +'%F %T') [force_branch_check.sh v1.0] PASSED: on branch $current_branch" >> "$LOG_FILE"
    exit 0
fi
