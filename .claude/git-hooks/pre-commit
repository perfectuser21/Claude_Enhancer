#!/bin/bash
# Claude Enhancer Git Hook - Pre-commit
# ç¬¬ä¸‰å±‚é˜²æŠ¤ï¼šä»£ç è´¨é‡æ£€æŸ¥

set -e

echo "ğŸ” Claude Enhancer Pre-commit Check"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# æ£€æŸ¥ç»“æœ
CHECKS_PASSED=true

# 1. æ£€æŸ¥æ˜¯å¦æœ‰æµ‹è¯•æ–‡ä»¶
echo "1. Checking for tests..."
if find . -name "*test*.py" -o -name "*test*.js" -o -name "*_test.go" | grep -q .; then
    echo -e "${GREEN}âœ… Test files found${NC}"
else
    echo -e "${YELLOW}âš ï¸  Warning: No test files found${NC}"
    # ä¸å¼ºåˆ¶å¤±è´¥ï¼Œä½†è­¦å‘Š
fi

# 2. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æ¡£
echo "2. Checking for documentation..."
if [ -f "README.md" ] || [ -f "docs/README.md" ]; then
    echo -e "${GREEN}âœ… Documentation found${NC}"
else
    echo -e "${RED}âŒ ERROR: No README.md found${NC}"
    CHECKS_PASSED=false
fi

# 3. æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆPythonï¼‰
echo "3. Checking code format..."
if command -v black &> /dev/null; then
    if black --check . 2>/dev/null; then
        echo -e "${GREEN}âœ… Python code formatted${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Python code needs formatting (run: black .)${NC}"
    fi
fi

# 4. æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨é—®é¢˜ï¼ˆç®€å•æ£€æŸ¥ï¼‰
echo "4. Security check..."
SECURITY_ISSUES=false

# æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†ç 
if grep -r "password\s*=\s*[\"']" --include="*.py" --include="*.js" . 2>/dev/null | grep -v test | grep -v example; then
    echo -e "${RED}âŒ Hardcoded passwords detected${NC}"
    SECURITY_ISSUES=true
fi

# æ£€æŸ¥æ˜¯å¦æœ‰APIå¯†é’¥
if grep -r "api_key\s*=\s*[\"']" --include="*.py" --include="*.js" . 2>/dev/null | grep -v test | grep -v example; then
    echo -e "${RED}âŒ Hardcoded API keys detected${NC}"
    SECURITY_ISSUES=true
fi

if [ "$SECURITY_ISSUES" = false ]; then
    echo -e "${GREEN}âœ… No obvious security issues${NC}"
fi

# 5. æ£€æŸ¥æäº¤å¤§å°
echo "5. Checking commit size..."
FILES_COUNT=$(git diff --cached --name-only | wc -l)
if [ $FILES_COUNT -gt 50 ]; then
    echo -e "${YELLOW}âš ï¸  Large commit: $FILES_COUNT files (consider splitting)${NC}"
else
    echo -e "${GREEN}âœ… Commit size OK: $FILES_COUNT files${NC}"
fi

# 6. æ¸…ç†åƒåœ¾æ–‡ä»¶
echo "6. Cleaning garbage files..."
CLEANUP_SCRIPT=".claude/scripts/cleanup.sh"
if [ -f "$CLEANUP_SCRIPT" ]; then
    # é™é»˜æ¸…ç†ï¼Œåªæ˜¾ç¤ºç»“æœ
    GARBAGE_COUNT=$(find . \( -name "*.pyc" -o -name "*.bak" -o -name "*.tmp" \) 2>/dev/null | wc -l)
    if [ $GARBAGE_COUNT -gt 0 ]; then
        bash "$CLEANUP_SCRIPT" > /dev/null 2>&1
        echo -e "${GREEN}âœ… Cleaned $GARBAGE_COUNT garbage files${NC}"
    else
        echo -e "${GREEN}âœ… No garbage files found${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  Cleanup script not found${NC}"
fi

# 7. æ£€æŸ¥Claude Enhanceræ ‡å‡†
echo "7. Checking Claude Enhancer standards..."

# æ£€æŸ¥æœ€è¿‘çš„æ‰§è¡Œæ—¥å¿—
if [ -f "/tmp/claude_enhancer_max_quality.log" ]; then
    # æ£€æŸ¥æœ€è¿‘æ˜¯å¦ä½¿ç”¨äº†è¶³å¤Ÿçš„agents
    LAST_AGENTS=$(tail -100 /tmp/claude_enhancer_max_quality.log 2>/dev/null | grep -c "agent" || echo "0")
    if [ "$LAST_AGENTS" -ge 5 ]; then
        echo -e "${GREEN}âœ… Multi-agent collaboration detected${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Consider using more agents for better quality${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  No Claude Enhancer execution log found${NC}"
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# æœ€ç»ˆç»“æœ
if [ "$CHECKS_PASSED" = true ] && [ "$SECURITY_ISSUES" = false ]; then
    echo -e "${GREEN}âœ… All checks passed! Proceeding with commit.${NC}"
    exit 0
else
    echo -e "${RED}âŒ Commit blocked! Please fix the issues above.${NC}"
    echo ""
    echo "Tips:"
    echo "- Add tests for your code"
    echo "- Create or update README.md"
    echo "- Remove hardcoded secrets"
    echo "- Use environment variables for sensitive data"
    exit 1
fi