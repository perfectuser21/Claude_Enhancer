#!/usr/bin/env bash
# Claude Enhancer v8.0 CLI Tool
# ç”¨æ³•: ce [command] [options]
# æ—¥æœŸ: 2025-10-27

set -euo pipefail

# CE_HOMEæ£€æµ‹
CE_HOME="${CE_HOME:-}"
if [[ -z "$CE_HOME" ]]; then
  SPEC_PATH=$(find ~ -maxdepth 3 -name "SPEC.yaml" -path "*/.workflow/*" 2>/dev/null | head -1)
  if [[ -n "$SPEC_PATH" ]]; then
    CE_HOME="$(dirname "$(dirname "$SPEC_PATH")")"
  fi
fi

if [[ -z "${CE_HOME:-}" ]]; then
  echo "âŒ é”™è¯¯: æ— æ³•æ‰¾åˆ°Claude Enhancerç›®å½•" >&2
  echo "   è¯·è®¾ç½®CE_HOMEç¯å¢ƒå˜é‡" >&2
  echo "   ç¤ºä¾‹: export CE_HOME=/home/xx/dev/Claude\\ Enhancer" >&2
  exit 1
fi

# å‘½ä»¤è·¯ç”±
COMMAND="${1:-help}"

case "$COMMAND" in
  dev)
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  ğŸš€ Claude Enhancer å¼€å‘æ¨¡å¼                              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "   é¡¹ç›®: $(basename "$PWD")"
    echo "   CE_HOME: $CE_HOME"
    echo ""
    echo "   âœ… 7-Phaseå·¥ä½œæµ: æ¿€æ´»"
    echo "   âœ… å­¦ä¹ ç³»ç»Ÿ: æ¿€æ´»"
    echo "   âœ… Auto-fix: æ¿€æ´»"
    echo "   âœ… TODOé˜Ÿåˆ—: æ¿€æ´»"
    echo ""
    echo "å‡†å¤‡å¥½äº†ï¼å¼€å§‹å’ŒClaudeå¯¹è¯è¿›è¡Œå¼€å‘ã€‚"
    echo ""
    ;;

  mode)
    SUB="${2:-status}"
    case "$SUB" in
      status)
        PWD_BASE="$(basename "$PWD")"
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“ å½“å‰æ¨¡å¼                                              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        if [[ "$PWD" == "$CE_HOME" ]] || [[ "$PWD_BASE" == "Claude Enhancer" ]] || [[ "$PWD" == *"Claude Enhancer"* ]]; then
          echo "   æ¨¡å¼: ğŸ”§ è‡ªæˆ‘è¿›åŒ–ï¼ˆå¼€å‘Claude Enhancerï¼‰"
        else
          echo "   æ¨¡å¼: ğŸš€ å¤–éƒ¨é¡¹ç›®å¼€å‘"
          echo "   é¡¹ç›®: $PWD_BASE"
        fi

        echo ""
        echo "   CE_HOME: $CE_HOME"
        echo "   7-Phaseå·¥ä½œæµ: âœ…"
        echo "   å­¦ä¹ ç³»ç»Ÿ: âœ…"
        echo ""
        ;;
      *)
        echo "âŒ æœªçŸ¥modeå­å‘½ä»¤: $SUB" >&2
        echo "   å¯ç”¨å‘½ä»¤: status" >&2
        exit 1
        ;;
    esac
    ;;

  todo)
    SUB="${2:-list}"
    case "$SUB" in
      list)
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“‹ TODOé˜Ÿåˆ—                                              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        TODO_COUNT=$(find "$CE_HOME/.todos/pending/" -name "*.json" 2>/dev/null | wc -l)

        if [[ $TODO_COUNT -eq 0 ]]; then
          echo "   (æš‚æ— å¾…åŠTODO)"
          echo ""
          echo "   æç¤º: Learning Itemsä¼šè‡ªåŠ¨è½¬æ¢ä¸ºTODO"
          echo "   è¿è¡Œ: ce learning convert"
        else
          for todo_file in "$CE_HOME/.todos/pending/"*.json; do
            [[ ! -f "$todo_file" ]] && continue

            if command -v jq >/dev/null 2>&1; then
              TODO_ID=$(jq -r '.id' "$todo_file")
              TITLE=$(jq -r '.title' "$todo_file")
              PRIORITY=$(jq -r '.priority' "$todo_file")

              # ä¼˜å…ˆçº§emoji
              PRI_EMOJI="ğŸ“"
              [[ "$PRIORITY" == "high" ]] && PRI_EMOJI="ğŸ”´"
              [[ "$PRIORITY" == "medium" ]] && PRI_EMOJI="ğŸŸ¡"

              echo "   $PRI_EMOJI [$TODO_ID] $TITLE"
            else
              echo "   - $(basename "$todo_file" .json)"
            fi
          done
        fi

        echo ""
        echo "æŸ¥çœ‹è¯¦æƒ…: ce todo show <id>"
        echo ""
        ;;

      show)
        TODO_ID="${3:-}"
        if [[ -z "$TODO_ID" ]]; then
          echo "âŒ é”™è¯¯: è¯·æŒ‡å®šTODO ID" >&2
          echo "   ç”¨æ³•: ce todo show <todo-id>" >&2
          exit 1
        fi

        TODO_FILE="$CE_HOME/.todos/pending/${TODO_ID}.json"
        if [[ ! -f "$TODO_FILE" ]]; then
          echo "âŒ é”™è¯¯: TODOä¸å­˜åœ¨: $TODO_ID" >&2
          echo "   è¿è¡Œ 'ce todo list' æŸ¥çœ‹æ‰€æœ‰TODO" >&2
          exit 1
        fi

        if command -v jq >/dev/null 2>&1; then
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“‹ TODOè¯¦æƒ…                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          jq -r '
            "   ID: \(.id)",
            "   æ ‡é¢˜: \(.title)",
            "   ä¼˜å…ˆçº§: \(.priority)",
            "   é¢„ä¼°å·¥ä½œé‡: \(.estimated_effort // "æœªçŸ¥")",
            "   çŠ¶æ€: \(.status)",
            "   åˆ›å»ºæ—¶é—´: \(.created_at)",
            "",
            "   æè¿°:",
            "   \(.description)",
            ""
          ' "$TODO_FILE"
        else
          cat "$TODO_FILE"
        fi
        ;;

      convert)
        echo "ğŸ”„ è½¬æ¢Learning Itemsä¸ºTODO..."
        bash "$CE_HOME/scripts/learning/convert_to_todo.sh"
        ;;

      *)
        echo "âŒ æœªçŸ¥todoå­å‘½ä»¤: $SUB" >&2
        echo "   å¯ç”¨å‘½ä»¤: list, show, convert" >&2
        exit 1
        ;;
    esac
    ;;

  learning)
    SUB="${2:-list}"
    case "$SUB" in
      list)
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“š Learning Items                                        â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        LEARNING_COUNT=$(find "$CE_HOME/.learning/items/" -name "*.yml" 2>/dev/null | wc -l)
        echo "   æ€»è®¡: $LEARNING_COUNTä¸ªLearning Items"
        echo ""

        echo "   æŒ‰ç±»åˆ«:"
        for cat in error_pattern performance architecture code_quality success_pattern; do
          COUNT=$(find "$CE_HOME/.learning/by_category/$cat/" -name "*.yml" 2>/dev/null | wc -l)
          CAT_NAME=""
          case "$cat" in
            error_pattern) CAT_NAME="é”™è¯¯æ¨¡å¼" ;;
            performance) CAT_NAME="æ€§èƒ½ä¼˜åŒ–" ;;
            architecture) CAT_NAME="æ¶æ„å†³ç­–" ;;
            code_quality) CAT_NAME="ä»£ç è´¨é‡" ;;
            success_pattern) CAT_NAME="æˆåŠŸæ¨¡å¼" ;;
          esac
          echo "     - $CAT_NAME ($cat): $COUNT"
        done
        echo ""
        ;;

      stats)
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ“Š å­¦ä¹ ç³»ç»Ÿç»Ÿè®¡                                          â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        if [[ -f "$CE_HOME/.learning/stats.json" ]]; then
          if command -v jq >/dev/null 2>&1; then
            jq -r '
              "æŒ‰ç±»åˆ«:",
              (.by_category | to_entries | .[] | "  - \(.key): \(.value)"),
              "",
              "æŒ‰é¡¹ç›®:",
              (.by_project | to_entries | .[] | "  - \(.key): \(.value)"),
              "",
              "æŒ‰Phase:",
              (.by_phase | to_entries | .[] | "  - \(.key): \(.value)")
            ' "$CE_HOME/.learning/stats.json"
          else
            cat "$CE_HOME/.learning/stats.json"
          fi
        else
          echo "   (æš‚æ— ç»Ÿè®¡æ•°æ®)"
        fi
        echo ""
        ;;

      capture)
        shift 2  # ç§»é™¤ 'learning' å’Œ 'capture'
        bash "$CE_HOME/scripts/learning/capture.sh" "$@"
        ;;

      convert)
        echo "ğŸ”„ è½¬æ¢Learning Itemsä¸ºTODO..."
        bash "$CE_HOME/scripts/learning/convert_to_todo.sh"
        ;;

      *)
        echo "âŒ æœªçŸ¥learningå­å‘½ä»¤: $SUB" >&2
        echo "   å¯ç”¨å‘½ä»¤: list, stats, capture, convert" >&2
        exit 1
        ;;
    esac
    ;;

  sync)
    SUB="${2:-notion}"
    case "$SUB" in
      notion)
        shift 2  # ç§»é™¤ 'sync' å’Œ 'notion'
        echo "ğŸ”„ åŒæ­¥åˆ°Notion..."
        python3 "$CE_HOME/scripts/learning/sync_notion.py" "$@"
        ;;
      *)
        echo "âŒ æœªçŸ¥syncç›®æ ‡: $SUB" >&2
        echo "   å¯ç”¨å‘½ä»¤: notion" >&2
        exit 1
        ;;
    esac
    ;;

  version|--version|-v)
    if [[ -f "$CE_HOME/VERSION" ]]; then
      VERSION=$(cat "$CE_HOME/VERSION" | tr -d '[:space:]')
      echo "Claude Enhancer v$VERSION"
    else
      echo "Claude Enhancer (ç‰ˆæœ¬æœªçŸ¥)"
    fi
    ;;

  help|--help|-h)
    cat <<'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Claude Enhancer v8.0 CLI                                 â•‘
â•‘  ç»Ÿä¸€å‘½ä»¤è¡Œå·¥å…·                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç”¨æ³•:
  ce <command> [options]

å‘½ä»¤:

  ğŸ“ æ¨¡å¼ç®¡ç†:
    ce dev                  # åœ¨å¤–éƒ¨é¡¹ç›®å¯åŠ¨CEå¼€å‘æ¨¡å¼
    ce mode status          # æŸ¥çœ‹å½“å‰æ¨¡å¼ï¼ˆè‡ªæˆ‘è¿›åŒ–/å¤–éƒ¨é¡¹ç›®ï¼‰

  ğŸ“‹ TODOç®¡ç†:
    ce todo list            # åˆ—å‡ºæ‰€æœ‰å¾…åŠTODO
    ce todo show <id>       # æŸ¥çœ‹TODOè¯¦æƒ…
    ce todo convert         # å°†Learning Itemsè½¬æ¢ä¸ºTODO

  ğŸ“š å­¦ä¹ ç³»ç»Ÿ:
    ce learning list        # åˆ—å‡ºæ‰€æœ‰Learning Items
    ce learning stats       # æŸ¥çœ‹å­¦ä¹ ç³»ç»Ÿç»Ÿè®¡
    ce learning capture     # æ•è·æ–°çš„Learning Item
    ce learning convert     # è½¬æ¢ä¸ºTODO

  ğŸ”„ åŒæ­¥:
    ce sync notion          # åŒæ­¥åˆ°Notion
    ce sync notion --dry-run  # é¢„è§ˆåŒæ­¥ï¼ˆä¸å®é™…æ‰§è¡Œï¼‰

  â„¹ï¸  å…¶ä»–:
    ce version              # æ˜¾ç¤ºç‰ˆæœ¬
    ce help                 # æ˜¾ç¤ºæ­¤å¸®åŠ©

ç¯å¢ƒå˜é‡:
  CE_HOME                   # Claude Enhancerç›®å½•è·¯å¾„
                            # (å¯é€‰ï¼Œä¼šè‡ªåŠ¨æ£€æµ‹)

ç¤ºä¾‹:

  # åœ¨å¤–éƒ¨é¡¹ç›®å¼€å‘
  cd ~/projects/my-app
  ce dev

  # æ•è·Learning Item
  ce learning capture \
    --category error_pattern \
    --description "é‡åˆ°äº†XXXé”™è¯¯" \
    --phase Phase2 \
    --solution "ä½¿ç”¨YYYè§£å†³"

  # æŸ¥çœ‹TODOé˜Ÿåˆ—
  ce todo list

  # åŒæ­¥åˆ°Notion
  ce sync notion

æ›´å¤šä¿¡æ¯: https://github.com/anthropics/claude-enhancer
EOF
    ;;

  *)
    echo "âŒ æœªçŸ¥å‘½ä»¤: $COMMAND" >&2
    echo "   è¿è¡Œ 'ce help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤" >&2
    exit 1
    ;;
esac
