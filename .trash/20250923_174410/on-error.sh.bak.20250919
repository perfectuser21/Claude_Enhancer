#!/bin/bash
# Claude Code On-error Hook - 错误时的处理

echo "❌ 检测到错误，执行Claude Enhancer错误处理..."

# 记录错误并提供修复建议
python3 -c "
import sys
import json
from datetime import datetime
sys.path.insert(0, '/home/xx/dev/Claude Enhancer')

error_msg = '''$1'''

# 分析错误类型
if 'agent' in error_msg.lower() or 'task' in error_msg.lower():
    print('💡 Claude Enhancer建议：')
    print('  1. 检查Agent选择是否正确（至少3个）')
    print('  2. 确认使用并行执行模式')
    print('  3. 验证Agent组合是否匹配任务类型')
elif 'test' in error_msg.lower() or 'fail' in error_msg.lower():
    print('💡 Claude Enhancer建议：')
    print('  1. 触发反馈循环机制')
    print('  2. 让原Agent修复代码')
    print('  3. 不要跳过测试直接提交')
elif 'commit' in error_msg.lower():
    print('💡 Claude Enhancer建议：')
    print('  1. 检查提交消息格式（feat:/fix:/docs:等）')
    print('  2. 确保测试通过')
    print('  3. 运行质量检查')

# 记录到日志
log_path = '/home/xx/dev/Claude Enhancer/.perfect21/error.log'
with open(log_path, 'a') as f:
    f.write(f'[{datetime.now().isoformat()}] {error_msg}\\n')
"

exit 0