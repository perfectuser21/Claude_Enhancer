<<<<<<< Updated upstream
# Workflow Gates v2 — 八阶段自动化（P0-P7）
# Enhanced with AI Self-Validation System (v6.0)

=======
# Workflow Gates v2 — 完整8阶段自动化 (P0-P7)
# 更新：2025-10-07 - 添加P0探索阶段和P7监控阶段
>>>>>>> Stashed changes
meta:
  subagent_invocation: "Only main Claude Code agent may invoke sub-agents. Sub-agents MUST NOT invoke sub-agents."
  merge_strategy: "squash"              # main 分支一律 squash
  post_merge_healthcheck: true          # 合并后冒烟检查
  auto_rollback_on_health_fail: true    # 健康检查失败立即回滚上一 tag

  # AI Self-Validation Settings (NEW)
  pre_write_validation:
    enabled: true
    hook: .claude/hooks/quality/pre_write_validation.sh
    blocking: true
    performance_budget_ms: 100

# Quality Gate Thresholds (for hardened CI)
quality:
  quality_min: 85          # Minimum quality score
  coverage_min: 0          # Minimum coverage (0 = disabled temporarily)
  required_signatures: 8   # Required GPG signatures for protected branches

parallel_limits:
<<<<<<< Updated upstream
  P0: 3
  P1: 4
  P2: 6
  P3: 8
  P4: 6
  P5: 4
  P6: 2
  P7: 3
=======
  P0: 3   # 探索阶段：少量专家快速验证
  P1: 4   # 规划阶段：分析师+架构师
  P2: 6   # 骨架阶段：多个模块并行搭建
  P3: 8   # 实现阶段：最多并行任务
  P4: 6   # 测试阶段：多类型测试并行
  P5: 4   # 审查阶段：专注质量审核
  P6: 2   # 发布阶段：谨慎发布
  P7: 3   # 监控阶段：观察运行状态
>>>>>>> Stashed changes

parallel_autotune:
  success_streak_add: 2    # 连续两次一次过，上限 +2（不超过阶段限额）
  fail_streak_sub: 2       # 连续两次 gate 失败，上限 -2（不低于2）

test_depth:
  pre_push: ["unit", "boundary", "smoke"]   # push 前跑的集
  nightly_ci: ["integration", "contract"]   # 夜间 CI 额外跑

phase_order: [P0, P1, P2, P3, P4, P5, P6, P7]
<<<<<<< Updated upstream

# Pre-Tool Quality Gates (NEW - AI Self-Validation)
pre_tool_gates:
  Write:
    enabled: true
    validations:
      - name: syntax_check
        hook: .claude/hooks/quality/pre_write_validation.sh
        blocking: true
        timeout_ms: 100
      - name: security_scan
        description: "Scan for hardcoded secrets and vulnerabilities"
        blocking: true
      - name: test_existence
        description: "Verify test files exist for source files"
        blocking: false  # Warning only
        exclude_patterns:
          - ".temp/**"
          - "test/**"
          - "**/*.test.*"
          - "**/*.spec.*"

  Edit:
    enabled: true
    validations:
      - name: syntax_check
        hook: .claude/hooks/quality/pre_write_validation.sh
        blocking: true
        timeout_ms: 100
      - name: security_scan
        blocking: true

phases:
  P0:
    name: "Discovery"
    allow_paths: ["docs/P0_*.md", "docs/*_DISCOVERY.md", "docs/spike/**", ".gates/**", ".phase/**"]
    must_produce:
      - "docs/P0_*_DISCOVERY.md: 包含可行性分析、技术spike、风险评估"
      - "可行性结论明确（GO/NO-GO/NEEDS-DECISION）"
      - "技术spike至少验证2个关键技术点"
      - "风险评估包含：技术风险、业务风险、时间风险"
    gates:
      - "必须存在P0发现文档"
      - "必须包含可行性结论（GO/NO-GO/NEEDS-DECISION）"
      - "技术spike验证点 >= 2"
      - "风险评估完整（技术/业务/时间三个维度）"
      - "如果结论为NO-GO，需提供替代方案或终止理由"
    on_pass:
      - "create: .gates/00.ok"
      - "set: .phase/current=P1"

  P1:
    name: "Plan"
    allow_paths: ["docs/**", ".gates/**", ".phase/**"]
=======

phases:
  P0:
    name: "Explore - 技术探索"
    description: "技术可行性验证、风险评估、原型验证"
    allow_paths:
      - "docs/SPIKE.md"
      - "docs/FEASIBILITY.md"
      - "experiments/**"
      - ".exploration/**"
    must_produce:
      - "docs/SPIKE.md: 技术探索报告，包含可行性分析"
      - "明确的GO/NO-GO决策"
      - "关键技术风险清单"
    gates:
      - "必须存在 docs/SPIKE.md"
      - "包含GO/NO-GO决策"
      - "列出3个以上技术风险"
    on_pass:
      - "create: .gates/00.ok"
      - "set: .phase/current=P1"
    recommended_agents:
      - "research-specialist"
      - "architect-consultant"
      - "risk-assessor"

  P1:
    name: "Plan - 规划"
    description: "需求分析、任务分解、影响评估"
    allow_paths:
      - "docs/PLAN.md"
>>>>>>> Stashed changes
    must_produce:
      - "docs/PLAN.md: 包含三级标题：## 任务清单, ## 受影响文件清单, ## 回滚方案"
      - "任务清单≥5条（每条以动词开头，包含具体文件/模块名）"
      - "受影响文件清单为具体路径（如 src/auth/login.ts）"
    gates:
      - "必须存在 docs/PLAN.md"
      - "必须匹配三个标题"
      - "任务清单计数 >= 5"
      - "受影响清单为路径格式"
    on_pass:
      - "create: .gates/01.ok"
      - "set: .phase/current=P2"
    recommended_agents:
      - "product-analyst"
      - "system-architect"
      - "technical-writer"
      - "risk-manager"

  P2:
<<<<<<< Updated upstream
    name: "Skeleton"
    allow_paths: ["src/**", ".claude/**", ".workflow/**", ".github/workflows/**", ".gates/**", "scripts/**", "test/**", "tests/**", "CLAUDE.md", "VERSION", "CHANGELOG.md", "docs/**", ".phase/**"]
    must_produce:
      - "根据 PLAN.md 新建目录/接口骨架；不得新增计划外目录"
      - "必要说明写入 docs/SKELETON-NOTES.md"
      - "工作流基础设施（.claude/hooks, .workflow/, .github/workflows/等）属于项目骨架"
      - "项目规范文件（CLAUDE.md）定义项目骨架的开发规范"
    gates:
      - "src/ 新增目录均在 PLAN 受影响清单内"
      - "接口文件存在且命名遵循项目规范"
      - "工作流文件修改需在SKELETON-NOTES.md中说明"
=======
    name: "Skeleton - 骨架搭建"
    description: "架构设计、目录结构、接口定义"
    allow_paths:
      - "src/**"
      - "docs/SKELETON-NOTES.md"
      - "docs/ARCHITECTURE.md"
    must_produce:
      - "根据 PLAN.md 新建目录/接口骨架；不得新增计划外目录"
      - "必要说明写入 docs/SKELETON-NOTES.md"
      - "关键接口和数据结构定义"
    gates:
      - "src/ 新增目录均在 PLAN 受影响清单内"
      - "接口文件存在且命名遵循项目规范"
      - "架构文档更新"
>>>>>>> Stashed changes
    on_pass:
      - "create: .gates/02.ok"
      - "set: .phase/current=P3"
    recommended_agents:
      - "backend-architect"
      - "frontend-architect"
      - "database-designer"
      - "api-designer"
      - "devops-engineer"
      - "technical-writer"

  P3:
<<<<<<< Updated upstream
    name: "Implement"
    allow_paths: ["src/**", ".claude/hooks/**", "scripts/**", ".gates/**", "CHANGELOG.md", ".phase/**"]
=======
    name: "Implement - 实现"
    description: "编码开发、功能实现、代码提交"
    allow_paths:
      - "src/**"
      - "docs/CHANGELOG.md"
      - "lib/**"
      - "utils/**"
>>>>>>> Stashed changes
    must_produce:
      - "实现功能代码，可构建"
      - "CHANGELOG.md 的 Unreleased 段新增本次条目（简述范围/影响）"
      - "每个 ticket 生成一段 '变更点清单'（可写在 commit message 中）"
      - "工作流hooks实现（.claude/hooks/）属于核心功能实现"
    # NEW: Enhanced gates with AI self-validation
    quality_gates:
      - name: pre_write_validation
        description: "AI validates code before writing"
        hook: .claude/hooks/quality/pre_write_validation.sh
        blocking: true
        checks:
          - syntax_validation
          - security_scan
          - test_existence
          - code_quality
    gates:
      - "构建/编译通过"
      - "CHANGELOG Unreleased 段存在新增条目"
      - "不得改动非白名单目录"
      - "所有pre-write验证通过（NEW）"
    on_pass:
      - "create: .gates/03.ok"
      - "set: .phase/current=P4"
    recommended_agents:
      - "full-stack-developer"
      - "backend-developer"
      - "frontend-developer"
      - "database-specialist"
      - "security-engineer"
      - "code-reviewer"
      - "performance-optimizer"
      - "technical-writer"

  P4:
<<<<<<< Updated upstream
    name: "Test"
    allow_paths: ["test/**", "tests/**", "docs/TEST-REPORT.md", ".gates/**", ".phase/**"]
=======
    name: "Test - 测试"
    description: "单元测试、集成测试、性能测试"
    allow_paths:
      - "tests/**"
      - "test/**"
      - "docs/TEST-REPORT.md"
      - "docs/COVERAGE-REPORT.md"
>>>>>>> Stashed changes
    must_produce:
      - "新增/改动测试 >= 2 条，且至少 1 条为边界/负例"
      - "docs/TEST-REPORT.md 列出覆盖的模块/函数与结果"
      - "测试覆盖率报告"
    gates:
      - "pre-push: unit+boundary+smoke 必须绿"
      - "报告存在并含覆盖点清单"
<<<<<<< Updated upstream
      - "测试文件也通过pre-write验证（NEW）"
=======
      - "关键路径测试覆盖"
>>>>>>> Stashed changes
    on_pass:
      - "create: .gates/04.ok"
      - "set: .phase/current=P5"
    recommended_agents:
      - "test-engineer"
      - "qa-specialist"
      - "performance-tester"
      - "security-tester"
      - "automation-engineer"
      - "technical-writer"

  P5:
<<<<<<< Updated upstream
    name: "Review"
    allow_paths: ["src/**", "docs/REVIEW.md", ".gates/**", ".phase/**"]
=======
    name: "Review - 审查"
    description: "代码审查、质量检查、安全审计"
    allow_paths:
      - "docs/REVIEW.md"
      - "docs/SECURITY-AUDIT.md"
>>>>>>> Stashed changes
    must_produce:
      - "docs/REVIEW.md 三段：风格一致性/风险清单/回滚可行性；最后一行写 'APPROVE' 或 'REWORK: …'"
      - "安全审计结果"
      - "性能分析报告"
    gates:
      - "三段齐全"
      - "存在明确结论（APPROVE/REWORK）"
      - "无Critical安全问题"
    on_pass:
      - "when: APPROVE"
      - "create: .gates/05.ok"
      - "set: .phase/current=P6"
    recommended_agents:
      - "code-reviewer"
      - "security-auditor"
      - "performance-analyst"
      - "technical-writer"

  P6:
<<<<<<< Updated upstream
    name: "Docs & Release"
    allow_paths: ["README.md", "CHANGELOG.md", "VERSION", "docs/**", ".tags/**", "tags/**", ".gates/**", ".phase/**"]
=======
    name: "Release - 发布"
    description: "文档更新、版本发布、部署准备"
    allow_paths:
      - "docs/README.md"
      - "docs/CHANGELOG.md"
      - "docs/RELEASE-NOTES.md"
      - ".tags/**"
      - "package.json"
      - "version.txt"
>>>>>>> Stashed changes
    must_produce:
      - "README.md 或 docs/README.md 必含：安装、使用、注意事项 三段"
      - "CHANGELOG.md 版本号递增并写影响面"
      - "发布 tag 与 Release Notes"
<<<<<<< Updated upstream
      - "docs/PR-*.md 包含完整的PR描述（可选）"
=======
      - "部署文档更新"
>>>>>>> Stashed changes
    gates:
      - "README 三段齐"
      - "CHANGELOG 版本号+影响面齐"
      - "打 tag 成功"
      - "post-merge healthcheck 通过（否则自动回滚上一 tag）"
    on_pass:
      - "create: .gates/06.ok"
      - "set: .phase/current=P7"
<<<<<<< Updated upstream

  P7:
    name: "Monitor"
    allow_paths: ["observability/**", "docs/**", ".gates/**", ".phase/**"]
    must_produce:
      - "observability/*_MONITOR_REPORT.md: 包含健康检查、SLO验证、完整性验证"
      - "所有关键指标验证通过"
      - "系统状态=HEALTHY"
      - "生成监控报告包含：服务健康度、SLO合规性、性能基线"
    gates:
      - "健康检查通过（所有关键服务响应正常）"
      - "SLO指标达标（可用性、延迟、错误率）"
      - "无critical issues"
      - "监控报告完整（健康检查+SLO+性能基线）"
      - "回滚演练验证通过（可选，生产环境建议）"
    on_pass:
      - "create: .gates/07.ok"
      - "set: .phase/current=DONE"
      - "notify: 系统已进入生产监控阶段，持续跟踪SLO指标"

# Validation Performance Tracking (NEW)
performance_tracking:
  enabled: true
  log_path: .temp/quality_gates/performance.log
  alert_threshold_ms: 200
  metrics:
    - validation_duration
    - blocking_count
    - pass_rate

# Reporting Configuration (NEW)
reporting:
  enabled: true
  output_path: .temp/quality_gates/reports
  formats:
    - json
    - markdown
  summary_on_failure: true
  daily_summary: true
=======
    recommended_agents:
      - "release-manager"
      - "technical-writer"

  P7:
    name: "Monitor - 监控"
    description: "生产监控、性能追踪、问题响应"
    allow_paths:
      - "docs/MONITORING.md"
      - "docs/RUNBOOK.md"
      - ".monitoring/**"
      - "dashboards/**"
    must_produce:
      - "监控指标定义（SLI/SLO/SLA）"
      - "告警规则配置"
      - "运维手册更新"
    gates:
      - "关键指标监控就位"
      - "告警通道测试通过"
      - "Runbook包含故障处理流程"
    on_pass:
      - "create: .gates/07.ok"
      - "set: .phase/current=P1"  # 循环回P1开始下一个迭代
    recommended_agents:
      - "sre-engineer"
      - "monitoring-specialist"
      - "technical-writer"

# 质量门禁配置
quality_gates:
  code_standards:
    - "所有函数必须有注释"
    - "关键逻辑必须有单元测试"
    - "安全敏感代码必须审计"

  security_baseline:
    - "无SQL注入风险"
    - "无XSS漏洞"
    - "敏感信息加密存储"
    - "权限检查完整"

  performance_baseline:
    - "API响应时间 < 200ms (P95)"
    - "数据库查询 < 100ms (P95)"
    - "页面加载 < 3s"

# 自动回滚配置
rollback_triggers:
  - "健康检查失败"
  - "错误率 > 5%"
  - "响应时间 > 2x baseline"
  - "CPU使用率 > 90%"

# 通知配置
notifications:
  on_gate_fail:
    - type: "log"
      path: ".workflow/logs/gate_failures.log"
  on_phase_complete:
    - type: "log"
      path: ".workflow/logs/phase_completion.log"
  on_rollback:
    - type: "log"
      path: ".workflow/logs/rollback.log"
    - type: "alert"
      severity: "high"
>>>>>>> Stashed changes
