# Workflow Gates v2 — 八阶段自动化（P0-P7）
# Enhanced with AI Self-Validation System (v6.0)

meta:
  subagent_invocation: "Only main Claude Code agent may invoke sub-agents. Sub-agents MUST NOT invoke sub-agents."
  merge_strategy: "squash"              # main 分支一律 squash
  post_merge_healthcheck: true          # 合并后冒烟检查
  auto_rollback_on_health_fail: true    # 健康检查失败立即回滚上一 tag

  # AI Self-Validation Settings (NEW)
  pre_write_validation:
    enabled: true
    hook: .claude/hooks/quality/pre_write_validation.sh
    blocking: true
    performance_budget_ms: 100

# Quality Gate Thresholds (for hardened CI)
quality:
  quality_min: 85          # Minimum quality score
  coverage_min: 0          # Minimum coverage (0 = disabled temporarily)
  required_signatures: 8   # Required GPG signatures for protected branches

parallel_limits:
  P0: 3
  P1: 4
  P2: 6
  P3: 8
  P4: 6
  P5: 4
  P6: 2
  P7: 3

parallel_autotune:
  success_streak_add: 2    # 连续两次一次过，上限 +2（不超过阶段限额）
  fail_streak_sub: 2       # 连续两次 gate 失败，上限 -2（不低于2）

test_depth:
  pre_push: ["unit", "boundary", "smoke"]   # push 前跑的集
  nightly_ci: ["integration", "contract"]   # 夜间 CI 额外跑

phase_order: [P0, P1, P2, P3, P4, P5, P6, P7]

# Pre-Tool Quality Gates (NEW - AI Self-Validation)
pre_tool_gates:
  Write:
    enabled: true
    validations:
      - name: syntax_check
        hook: .claude/hooks/quality/pre_write_validation.sh
        blocking: true
        timeout_ms: 100
      - name: security_scan
        description: "Scan for hardcoded secrets and vulnerabilities"
        blocking: true
      - name: test_existence
        description: "Verify test files exist for source files"
        blocking: false  # Warning only
        exclude_patterns:
          - ".temp/**"
          - "test/**"
          - "**/*.test.*"
          - "**/*.spec.*"

  Edit:
    enabled: true
    validations:
      - name: syntax_check
        hook: .claude/hooks/quality/pre_write_validation.sh
        blocking: true
        timeout_ms: 100
      - name: security_scan
        blocking: true

phases:
  P0:
    name: "Discovery"
    allow_paths: ["docs/P0_*.md", "docs/*_DISCOVERY.md", "docs/spike/**", ".gates/**", ".phase/**"]
    must_produce:
      - "docs/P0_*_DISCOVERY.md: 包含可行性分析、技术spike、风险评估"
      - "可行性结论明确（GO/NO-GO/NEEDS-DECISION）"
      - "技术spike至少验证2个关键技术点"
      - "风险评估包含：技术风险、业务风险、时间风险"
    gates:
      - "必须存在P0发现文档"
      - "必须包含可行性结论（GO/NO-GO/NEEDS-DECISION）"
      - "技术spike验证点 >= 2"
      - "风险评估完整（技术/业务/时间三个维度）"
      - "如果结论为NO-GO，需提供替代方案或终止理由"
    on_pass:
      - "create: .gates/00.ok"
      - "set: .phase/current=P1"

  P1:
    name: "Plan"
    allow_paths: ["docs/**", ".gates/**", ".phase/**"]
    must_produce:
      - "docs/PLAN.md: 包含三级标题：## 任务清单, ## 受影响文件清单, ## 回滚方案"
      - "任务清单≥5条（每条以动词开头，包含具体文件/模块名）"
      - "受影响文件清单为具体路径（如 src/auth/login.ts）"
    gates:
      - "必须存在 docs/PLAN.md"
      - "必须匹配三个标题"
      - "任务清单计数 >= 5"
      - "受影响清单为路径格式"
    on_pass:
      - "create: .gates/01.ok"
      - "set: .phase/current=P2"

  P2:
    name: "Skeleton"
    allow_paths: ["src/**", ".claude/**", ".workflow/**", ".github/workflows/**", ".gates/**", "scripts/**", "test/**", "tests/**", "CLAUDE.md", "VERSION", "CHANGELOG.md", "docs/**", ".phase/**"]
    must_produce:
      - "根据 PLAN.md 新建目录/接口骨架；不得新增计划外目录"
      - "必要说明写入 docs/SKELETON-NOTES.md"
      - "工作流基础设施（.claude/hooks, .workflow/, .github/workflows/等）属于项目骨架"
      - "项目规范文件（CLAUDE.md）定义项目骨架的开发规范"
    gates:
      - "src/ 新增目录均在 PLAN 受影响清单内"
      - "接口文件存在且命名遵循项目规范"
      - "工作流文件修改需在SKELETON-NOTES.md中说明"
    on_pass:
      - "create: .gates/02.ok"
      - "set: .phase/current=P3"

  P3:
    name: "Implement"
    allow_paths: ["src/**", ".claude/hooks/**", "scripts/**", ".gates/**", "CHANGELOG.md", ".phase/**"]
    must_produce:
      - "实现功能代码，可构建"
      - "CHANGELOG.md 的 Unreleased 段新增本次条目（简述范围/影响）"
      - "每个 ticket 生成一段 '变更点清单'（可写在 commit message 中）"
      - "工作流hooks实现（.claude/hooks/）属于核心功能实现"
    # NEW: Enhanced gates with AI self-validation
    quality_gates:
      - name: pre_write_validation
        description: "AI validates code before writing"
        hook: .claude/hooks/quality/pre_write_validation.sh
        blocking: true
        checks:
          - syntax_validation
          - security_scan
          - test_existence
          - code_quality
    gates:
      - "构建/编译通过"
      - "CHANGELOG Unreleased 段存在新增条目"
      - "不得改动非白名单目录"
      - "所有pre-write验证通过（NEW）"
    on_pass:
      - "create: .gates/03.ok"
      - "set: .phase/current=P4"

  P4:
    name: "Test"
    allow_paths: ["test/**", "tests/**", "docs/TEST-REPORT.md", ".gates/**", ".phase/**"]
    must_produce:
      - "新增/改动测试 >= 2 条，且至少 1 条为边界/负例"
      - "docs/TEST-REPORT.md 列出覆盖的模块/函数与结果"
    gates:
      - "pre-push: unit+boundary+smoke 必须绿"
      - "报告存在并含覆盖点清单"
      - "测试文件也通过pre-write验证（NEW）"
    on_pass:
      - "create: .gates/04.ok"
      - "set: .phase/current=P5"

  P5:
    name: "Review"
    allow_paths: ["src/**", "docs/REVIEW.md", ".gates/**", ".phase/**"]
    must_produce:
      - "docs/REVIEW.md 三段：风格一致性/风险清单/回滚可行性；最后一行写 'APPROVE' 或 'REWORK: …'"
    gates:
      - "三段齐全"
      - "存在明确结论（APPROVE/REWORK）"
    on_pass:
      - "when: APPROVE"
      - "create: .gates/05.ok"
      - "set: .phase/current=P6"

  P6:
    name: "Docs & Release"
    allow_paths: ["README.md", "CHANGELOG.md", "VERSION", "docs/**", ".tags/**", "tags/**", ".gates/**", ".phase/**"]
    must_produce:
      - "README.md 或 docs/README.md 必含：安装、使用、注意事项 三段"
      - "CHANGELOG.md 版本号递增并写影响面"
      - "发布 tag 与 Release Notes"
      - "docs/PR-*.md 包含完整的PR描述（可选）"
    gates:
      - "README 三段齐"
      - "CHANGELOG 版本号+影响面齐"
      - "打 tag 成功"
      - "post-merge healthcheck 通过（否则自动回滚上一 tag）"
    on_pass:
      - "create: .gates/06.ok"
      - "set: .phase/current=P7"

  P7:
    name: "Monitor"
    allow_paths: ["observability/**", "docs/**", ".gates/**", ".phase/**"]
    must_produce:
      - "observability/*_MONITOR_REPORT.md: 包含健康检查、SLO验证、完整性验证"
      - "所有关键指标验证通过"
      - "系统状态=HEALTHY"
      - "生成监控报告包含：服务健康度、SLO合规性、性能基线"
    gates:
      - "健康检查通过（所有关键服务响应正常）"
      - "SLO指标达标（可用性、延迟、错误率）"
      - "无critical issues"
      - "监控报告完整（健康检查+SLO+性能基线）"
      - "回滚演练验证通过（可选，生产环境建议）"
    on_pass:
      - "create: .gates/07.ok"
      - "set: .phase/current=DONE"
      - "notify: 系统已进入生产监控阶段，持续跟踪SLO指标"

# Validation Performance Tracking (NEW)
performance_tracking:
  enabled: true
  log_path: .temp/quality_gates/performance.log
  alert_threshold_ms: 200
  metrics:
    - validation_duration
    - blocking_count
    - pass_rate

# Reporting Configuration (NEW)
reporting:
  enabled: true
  output_path: .temp/quality_gates/reports
  formats:
    - json
    - markdown
  summary_on_failure: true
  daily_summary: true
