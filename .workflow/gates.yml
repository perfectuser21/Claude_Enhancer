# Workflow Gates v3 â€” 7 Phases Unified System
# Lockdown Mechanism Integration (v6.6)
# æ›´æ–°ï¼š2025-10-20 - 7 Phasesç³»ç»Ÿ + é”å®šæœºåˆ¶é›†æˆ

meta:
  subagent_invocation: "Only main Claude Code agent may invoke sub-agents. Sub-agents MUST NOT invoke sub-agents."
  merge_strategy: "squash"              # main åˆ†æ”¯ä¸€å¾‹ squash
  post_merge_healthcheck: true          # åˆå¹¶åå†’çƒŸæ£€æŸ¥
  auto_rollback_on_health_fail: true    # å¥åº·æ£€æŸ¥å¤±è´¥ç«‹å³å›æ»šä¸Šä¸€ tag

  # Lockdown Mechanism Integration (NEW)
  core_verification:
    enabled: true
    hook: tools/verify-core-structure.sh
    blocking: true
    fail_mode: "soft"                   # è§‚æµ‹æœŸ7å¤©ï¼Œsoftæ¨¡å¼ï¼ˆè®°å½•ä½†ä¸é˜»æ­¢ï¼‰
    strict_mode_start: "2025-10-27"     # 7å¤©åè‡ªåŠ¨åˆ‡æ¢åˆ°strictæ¨¡å¼
    performance_budget_ms: 50

  # AI Self-Validation Settings
  pre_write_validation:
    enabled: true
    hook: .claude/hooks/quality/pre_write_validation.sh
    blocking: true
    performance_budget_ms: 100

# Quality Gate Thresholds (for hardened CI)
quality:
  quality_min: 85                       # Minimum quality score
  coverage_min: 70                      # Minimum coverage (hard block at Phase 3)
  coverage_block: true                  # true = hard block, false = warning only
  coverage_tolerance: 0.005             # Â±0.5% tolerance for rounding errors
  required_signatures: 8                # Required GPG signatures for protected branches

# System Scale Limits (v8.7.0 - é˜²æ­¢æ–‡ä»¶æ•°é‡å¤±æ§)
scale_limits:
  hooks_max: 50                         # Maximum hooks in .claude/hooks/
  scripts_max: 90                       # Maximum scripts in scripts/
  docs_max: 7                           # Maximum root directory .md files
  temp_size_mb_max: 10                  # Maximum .temp/ directory size
  enforcement: "Phase 4 + Phase 7"      # When to enforce (Review + Closure)
  blocking: true                        # Hard block if exceeded
  baseline_date: "2025-10-30"           # Baseline established
  rationale: "é˜²æ­¢AIæ— é™æ·»åŠ æ–‡ä»¶ï¼Œä¿æŒç³»ç»Ÿå¯ç»´æŠ¤æ€§"

# Parallel Execution Configuration
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âš ï¸ Single Source of Truth: .claude/settings.json â†’ parallel_execution
#
# å¹¶è¡Œé™åˆ¶é…ç½®å·²ç»Ÿä¸€åˆ° settings.json ä¸­ï¼Œè¯¥æ–‡ä»¶åŒ…å«å®Œæ•´çš„è¿è¡Œæ—¶é…ç½®ï¼š
#   - max_concurrent: å¹¶è¡Œä»»åŠ¡æ•°
#   - timeout: è¶…æ—¶æ—¶é—´
#   - groups: ä»»åŠ¡åˆ†ç»„
#   - enabled: æ˜¯å¦å¯ç”¨
#
# å½“å‰é…ç½®å€¼ï¼ˆä» settings.jsonï¼‰:
#   Phase2: 4 (Implementation)
#   Phase3: 5 (Testing)
#   Phase4: 3 (Review)
#   Phase7: 3 (Closure)
#
# å¦‚éœ€ä¿®æ”¹å¹¶è¡Œé™åˆ¶ï¼Œè¯·ç¼–è¾‘: .claude/settings.json â†’ parallel_execution
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

test_depth:
  pre_push: ["unit", "boundary", "smoke"]   # push å‰è·‘çš„é›†
  nightly_ci: ["integration", "contract"]   # å¤œé—´ CI é¢å¤–è·‘

phase_order: [Phase1, Phase2, Phase3, Phase4, Phase5, Phase6, Phase7]

# Pre-Tool Quality Gates (AI Self-Validation)
pre_tool_gates:
  Write:
    enabled: true
    validations:
      - name: syntax_check
        hook: .claude/hooks/quality/pre_write_validation.sh
        blocking: true
        timeout_ms: 100
      - name: security_scan
        description: "Scan for hardcoded secrets and vulnerabilities"
        blocking: true
      - name: core_structure_check
        description: "Verify core structure not tampered (7 Phases/97 checkpoints)"
        hook: tools/verify-core-structure.sh
        blocking: true  # Will be soft for 7 days
        timeout_ms: 50
      - name: test_existence
        description: "Verify test files exist for source files"
        blocking: false  # Warning only
        exclude_patterns:
          - ".temp/**"
          - "test/**"
          - "**/*.test.*"
          - "**/*.spec.*"

  Edit:
    enabled: true
    validations:
      - name: syntax_check
        hook: .claude/hooks/quality/pre_write_validation.sh
        blocking: true
        timeout_ms: 100
      - name: security_scan
        blocking: true
      - name: core_structure_check
        hook: tools/verify-core-structure.sh
        blocking: true
        timeout_ms: 50

phases:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Phase 1: Discovery & Planningï¼ˆæ¢ç´¢ä¸è§„åˆ’ï¼‰- 33æ£€æŸ¥ç‚¹
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase1:
    name: "Discovery & Planning - æ¢ç´¢ä¸è§„åˆ’"
    description: "ç†è§£é—®é¢˜ + æŠ€æœ¯æ¢ç´¢ + å½±å“è¯„ä¼° + æ¶æ„è§„åˆ’"
    checkpoint_count: 33
    sub_phases:
      - "1.1 Branch Check (5æ£€æŸ¥ç‚¹)"
      - "1.2 Requirements Discussion (5æ£€æŸ¥ç‚¹)"
      - "1.3 Technical Discovery (8æ£€æŸ¥ç‚¹)"
      - "1.4 Impact Assessment (3æ£€æŸ¥ç‚¹)"
      - "1.5 Architecture Planning (12æ£€æŸ¥ç‚¹)"

    allow_paths:
      - "docs/P2_DISCOVERY.md"
      - "docs/ACCEPTANCE_CHECKLIST.md"
      - "docs/PLAN.md"
      - "docs/**"
      - ".workflow/impact_assessments/**"
      - ".gates/**"
      - ".phase/**"
      - "experiments/**"

    must_produce:
      - "docs/P2_DISCOVERY.md (>300è¡Œ): å¯è¡Œæ€§åˆ†æã€æŠ€æœ¯spikeã€é£é™©è¯„ä¼°"
      - "docs/ACCEPTANCE_CHECKLIST.md: å®šä¹‰'å®Œæˆ'çš„æ ‡å‡†"
      - "docs/PLAN.md (>1000è¡Œ): ä»»åŠ¡åˆ†è§£ã€æ¶æ„è®¾è®¡ã€å›æ»šæ–¹æ¡ˆ"
      - ".workflow/impact_assessments/current.json: Impact Assessmentç»“æœ"
      - "å®Œæ•´çš„é¡¹ç›®éª¨æ¶è§„åˆ’"

    gates:
      - "P2_DISCOVERY.mdåŒ…å«å¯è¡Œæ€§ç»“è®ºï¼ˆGO/NO-GO/NEEDS-DECISIONï¼‰"
      - "æŠ€æœ¯spikeéªŒè¯ç‚¹ >= 2"
      - "é£é™©è¯„ä¼°å®Œæ•´ï¼ˆæŠ€æœ¯/ä¸šåŠ¡/æ—¶é—´ä¸‰ä¸ªç»´åº¦ï¼‰"
      - "ACCEPTANCE_CHECKLIST.mdå­˜åœ¨ä¸”åŒ…å«éªŒæ”¶æ ‡å‡†"
      - "PLAN.mdä¸‰çº§æ ‡é¢˜é½å…¨ï¼šä»»åŠ¡æ¸…å•/å—å½±å“æ–‡ä»¶/å›æ»šæ–¹æ¡ˆ"
      - "ä»»åŠ¡æ¸…å• >= 5æ¡"
      - "Impact Assessmentå®Œæˆï¼ˆå½±å“åŠå¾„åˆ†æ•°è®¡ç®—ï¼‰"
      - "æ— TODOå ä½ç¬¦ï¼ˆé˜²ç©ºå£³æ£€æŸ¥ï¼‰"

    on_pass:
      - "create: .gates/01.ok"
      - "set: .phase/current=Phase2"

    recommended_agents:
      - "research-specialist"
      - "architect-consultant"
      - "risk-assessor"
      - "product-analyst"
      - "system-architect"
      - "technical-writer"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Phase 2: Implementationï¼ˆå®ç°å¼€å‘ï¼‰- 15æ£€æŸ¥ç‚¹
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase2:
    name: "Implementation - å®ç°å¼€å‘"
    description: "ç¼–ç å®ç°ã€å·¥å…·åˆ›å»ºã€Gité…ç½®"
    checkpoint_count: 15

    allow_paths:
      - "src/**"
      - "lib/**"
      - "utils/**"
      - ".claude/hooks/**"
      - "scripts/**"
      - "tools/**"
      - ".workflow/**"
      - ".github/workflows/**"
      - "CLAUDE.md"
      - "VERSION"
      - "CHANGELOG.md"
      - "docs/**"
      - ".gates/**"
      - ".phase/**"

    must_produce:
      - "å¯è¿è¡Œçš„ä»£ç å®ç°"
      - "éªŒè¯è„šæœ¬ï¼ˆworkflow_validator_v97.shç­‰ï¼‰"
      - "å·¥å…·è„šæœ¬ï¼ˆlocal_ci.sh, verify-core-structure.shç­‰ï¼‰"
      - "Git hooksé…ç½®"
      - "è§„èŒƒçš„Git commits"

    quality_gates:
      - name: pre_write_validation
        description: "AI validates code before writing"
        hook: .claude/hooks/quality/pre_write_validation.sh
        blocking: true
        checks:
          - syntax_validation
          - security_scan
          - test_existence
          - code_quality

      - name: core_structure_preservation
        description: "Verify core structure not degraded"
        hook: tools/verify-core-structure.sh
        blocking: true
        checks:
          - spec_fingerprint
          - checkpoint_count
          - quality_gates_count
          - hard_blocks_count

    gates:
      - "æ„å»º/ç¼–è¯‘é€šè¿‡"
      - "CHANGELOG.mdæ›´æ–°"
      - "ä¸å¾—æ”¹åŠ¨éç™½åå•ç›®å½•"
      - "æ‰€æœ‰pre-writeéªŒè¯é€šè¿‡"
      - "æ ¸å¿ƒç»“æ„å®Œæ•´æ€§éªŒè¯é€šè¿‡ï¼ˆ7 Phases/97æ£€æŸ¥ç‚¹ä¿æŒï¼‰"

    on_pass:
      - "create: .gates/02.ok"
      - "set: .phase/current=Phase3"

    recommended_agents:
      - "full-stack-developer"
      - "backend-architect"
      - "devops-engineer"
      - "database-specialist"
      - "security-engineer"
      - "code-reviewer"
      - "technical-writer"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Phase 3: Testingï¼ˆè´¨é‡éªŒè¯ï¼‰- 15æ£€æŸ¥ç‚¹ ğŸ”’ è´¨é‡é—¨ç¦1
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase3:
    name: "Testing - è´¨é‡éªŒè¯"
    description: "å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€BDDéªŒæ”¶"
    checkpoint_count: 15
    quality_gate: 1  # ğŸ”’ ç¬¬ä¸€é“è´¨é‡é—¨ç¦

    allow_paths:
      - "tests/**"
      - "test/**"
      - "acceptance/**"
      - "docs/TEST-REPORT.md"
      - "docs/COVERAGE-REPORT.md"
      - ".gates/**"
      - ".phase/**"

    must_produce:
      - "æ–°å¢/æ”¹åŠ¨æµ‹è¯• >= 2 æ¡ï¼Œä¸”è‡³å°‘ 1 æ¡ä¸ºè¾¹ç•Œ/è´Ÿä¾‹"
      - "docs/TEST-REPORT.md åˆ—å‡ºè¦†ç›–çš„æ¨¡å—/å‡½æ•°ä¸ç»“æœ"
      - "æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šï¼ˆâ‰¥70%ï¼‰"
      - "æ€§èƒ½benchmarkç»“æœ"

    mandatory_checks:
      - name: static_checks
        description: "è¿è¡Œ scripts/static_checks.sh"
        command: "bash scripts/static_checks.sh"
        blocking: true
        checks:
          - "Shellè¯­æ³•éªŒè¯ï¼ˆbash -nï¼‰"
          - "Shellcheck linting"
          - "ä»£ç å¤æ‚åº¦æ£€æŸ¥ï¼ˆ<150è¡Œ/å‡½æ•°ï¼‰"
          - "Hookæ€§èƒ½æµ‹è¯•ï¼ˆ<2ç§’ï¼‰"

    gates:
      - "pre-push: unit+boundary+smoke å¿…é¡»ç»¿"
      - "æµ‹è¯•è¦†ç›–ç‡ >= 70%ï¼ˆå®¹å·®Â±0.5%ï¼‰"
      - "æŠ¥å‘Šå­˜åœ¨å¹¶å«è¦†ç›–ç‚¹æ¸…å•"
      - "å…³é”®è·¯å¾„æµ‹è¯•è¦†ç›–"
      - "é™æ€æ£€æŸ¥100%é€šè¿‡ï¼ˆbash -n + shellcheckï¼‰"
      - "ä»£ç å¤æ‚åº¦åˆè§„ï¼ˆå‡½æ•°<150è¡Œï¼‰"
      - "Hookæ€§èƒ½åˆè§„ï¼ˆ<2ç§’æ‰§è¡Œï¼‰"
      - "æ— æ•æ„Ÿä¿¡æ¯æ³„éœ²"

    on_pass:
      - "create: .gates/03.ok"
      - "create: .gates/gate1.passed"
      - "set: .phase/current=Phase4"

    on_fail:
      - "block: Phase4"
      - "message: è´¨é‡é—¨ç¦1å¤±è´¥ï¼Œå¿…é¡»ä¿®å¤æ‰€æœ‰æµ‹è¯•é—®é¢˜åæ‰èƒ½ç»§ç»­"

    recommended_agents:
      - "test-engineer"
      - "qa-specialist"
      - "performance-tester"
      - "security-tester"
      - "automation-engineer"
      - "technical-writer"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Phase 4: Reviewï¼ˆä»£ç å®¡æŸ¥ï¼‰- 10æ£€æŸ¥ç‚¹ ğŸ”’ è´¨é‡é—¨ç¦2
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase4:
    name: "Review - ä»£ç å®¡æŸ¥"
    description: "äººå·¥å®¡æŸ¥ã€åˆå¹¶å‰å®¡è®¡ã€å®Œæ•´æ€§éªŒè¯"
    checkpoint_count: 10
    quality_gate: 2  # ğŸ”’ ç¬¬äºŒé“è´¨é‡é—¨ç¦

    allow_paths:
      - "src/**"
      - "docs/REVIEW.md"
      - "docs/SECURITY-AUDIT.md"
      - ".gates/**"
      - ".phase/**"

    must_produce:
      - "docs/REVIEW.md (>100è¡Œ): é£æ ¼ä¸€è‡´æ€§/é£é™©æ¸…å•/å›æ»šå¯è¡Œæ€§"
      - "ç»“è®ºï¼šAPPROVE æˆ– REWORK: åŸå› "
      - "å®‰å…¨å®¡è®¡ç»“æœ"
      - "æ€§èƒ½åˆ†ææŠ¥å‘Š"

    mandatory_checks:
      - name: pre_merge_audit
        description: "è¿è¡Œ scripts/pre_merge_audit.sh"
        command: "bash scripts/pre_merge_audit.sh"
        blocking: true
        checks:
          - "é…ç½®å®Œæ•´æ€§ï¼ˆhooksæ³¨å†Œã€æƒé™ï¼‰"
          - "é—ç•™é—®é¢˜æ‰«æï¼ˆTODO/FIXMEï¼‰"
          - "åƒåœ¾æ–‡æ¡£æ£€æµ‹ï¼ˆæ ¹ç›®å½•â‰¤7ä¸ªï¼‰"
          - "ç‰ˆæœ¬å®Œå…¨ä¸€è‡´æ€§ï¼ˆ5æ–‡ä»¶åŒ¹é…ï¼‰"
          - "ä»£ç æ¨¡å¼ä¸€è‡´æ€§"
          - "æ–‡æ¡£å®Œæ•´æ€§ï¼ˆREVIEW.md >3KBï¼‰"

      - name: manual_verification
        description: "äººå·¥éªŒè¯é¡¹"
        blocking: true
        checks:
          - "é€»è¾‘æ­£ç¡®æ€§ï¼ˆIFåˆ¤æ–­ã€returnè¯­ä¹‰ï¼‰"
          - "ä»£ç ä¸€è‡´æ€§ï¼ˆç»Ÿä¸€å®ç°æ¨¡å¼ï¼‰"
          - "Phase 1 checklistå¯¹ç…§éªŒè¯"

    gates:
      - "ä¸‰æ®µé½å…¨ï¼ˆé£æ ¼/é£é™©/å›æ»šï¼‰"
      - "å­˜åœ¨æ˜ç¡®ç»“è®ºï¼ˆAPPROVE/REWORKï¼‰"
      - "æ— Criticalå®‰å…¨é—®é¢˜"
      - "æ— Criticalè´¨é‡é—®é¢˜"
      - "ç‰ˆæœ¬å®Œå…¨ä¸€è‡´æ€§éªŒè¯é€šè¿‡"
      - "æ ¹ç›®å½•æ–‡æ¡£â‰¤7ä¸ª"
      - "Phase 1 Acceptance Checklist â‰¥90%å®Œæˆ"
      - "æ ¸å¿ƒç»“æ„å®Œæ•´æ€§éªŒè¯é€šè¿‡"

    on_pass:
      - "when: APPROVE"
      - "create: .gates/04.ok"
      - "create: .gates/gate2.passed"
      - "set: .phase/current=Phase5"

    on_fail:
      - "when: REWORK"
      - "block: Phase5"
      - "message: è´¨é‡é—¨ç¦2å¤±è´¥ï¼Œå¿…é¡»ä¿®å¤æ‰€æœ‰é—®é¢˜åæ‰èƒ½å‘å¸ƒ"

    recommended_agents:
      - "code-reviewer"
      - "security-auditor"
      - "performance-analyst"
      - "technical-writer"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Phase 5: Releaseï¼ˆå‘å¸ƒç›‘æ§ï¼‰- 15æ£€æŸ¥ç‚¹
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase5:
    name: "Release - å‘å¸ƒç›‘æ§"
    description: "æ–‡æ¡£æ›´æ–°ã€ç‰ˆæœ¬å‘å¸ƒã€éƒ¨ç½²é…ç½®"
    checkpoint_count: 15

    allow_paths:
      - "README.md"
      - "CHANGELOG.md"
      - "VERSION"
      - "docs/**"
      - ".tags/**"
      - "tags/**"
      - ".gates/**"
      - ".phase/**"
      - "package.json"
      - ".claude/settings.json"
      - ".workflow/manifest.yml"

    must_produce:
      - "README.md å¿…å«ï¼šå®‰è£…ã€ä½¿ç”¨ã€æ³¨æ„äº‹é¡¹ ä¸‰æ®µ"
      - "CHANGELOG.md ç‰ˆæœ¬å·é€’å¢å¹¶å†™å½±å“é¢"
      - "å‘å¸ƒ tag ä¸ Release Notes"
      - "éƒ¨ç½²æ–‡æ¡£æ›´æ–°"

    gates:
      - "README ä¸‰æ®µé½"
      - "CHANGELOG ç‰ˆæœ¬å·+å½±å“é¢é½"
      - "ç‰ˆæœ¬ä¸€è‡´æ€§ï¼ˆ5æ–‡ä»¶å®Œå…¨åŒ¹é…ï¼‰"
      - "æ ¹ç›®å½•æ–‡æ¡£â‰¤7ä¸ªï¼ˆè§„åˆ™1å¼ºåˆ¶ï¼‰"
      - "Phase 1 Acceptance Checklist â‰¥90%å®Œæˆ"
      - "æ‰“ tag æˆåŠŸ"
      - "post-merge healthcheck é€šè¿‡ï¼ˆå¦åˆ™è‡ªåŠ¨å›æ»šä¸Šä¸€ tagï¼‰"

    on_pass:
      - "create: .gates/05.ok"
      - "set: .phase/current=Phase6"

    recommended_agents:
      - "release-manager"
      - "technical-writer"
      - "devops-engineer"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Phase 6: Acceptanceï¼ˆéªŒæ”¶ç¡®è®¤ï¼‰- 5æ£€æŸ¥ç‚¹
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase6:
    name: "Acceptance - éªŒæ”¶ç¡®è®¤"
    description: "AIç”ŸæˆéªŒæ”¶æŠ¥å‘Š + ç”¨æˆ·ç¡®è®¤"
    checkpoint_count: 5

    allow_paths:
      - ".workflow/**"
      - "docs/**"
      - ".gates/**"
      - ".phase/**"

    must_produce:
      - ".workflow/VERIFICATION_REPORT.md: éªŒæ”¶æŠ¥å‘Š"
      - ".workflow/verification_details.log: è¯¦ç»†éªŒè¯æ—¥å¿—"
      - "æ‰€æœ‰Checklisté¡¹éªŒè¯å®Œæˆ"
      - "éªŒæ”¶æŠ¥å‘Šå±•ç¤ºç»™ç”¨æˆ·"
      - "ç­‰å¾…ç”¨æˆ·ç¡®è®¤merge"

    gates:
      - id: "checklist_exists"
        name: "éªŒæ”¶æ¸…å•å­˜åœ¨"
        check_command: "test -f docs/ACCEPTANCE_CHECKLIST.md"
        pass_condition:
          type: "exit_code"
          expected: 0
        on_fail: "Checklistä¸å­˜åœ¨ï¼Œè¯·å…ˆç”ŸæˆChecklist"

      - id: "verify_all_items"
        name: "éªŒè¯æ‰€æœ‰æ¸…å•é¡¹"
        description: "AIå¯¹ç…§Phase 1 Acceptance Checklisté€é¡¹éªŒè¯"
        pass_condition:
          type: "manual"
          required: true
        on_fail: "æœ‰éªŒæ”¶é¡¹æœªé€šè¿‡"

      - id: "report_generated"
        name: "éªŒæ”¶æŠ¥å‘Šå·²ç”Ÿæˆ"
        check_command: "test -f .workflow/VERIFICATION_REPORT.md"
        pass_condition:
          type: "exit_code"
          expected: 0
        on_fail: "éªŒæ”¶æŠ¥å‘Šæœªç”Ÿæˆ"

      - id: "pass_rate_100"
        name: "é€šè¿‡ç‡100%"
        description: "æ‰€æœ‰éªŒæ”¶é¡¹å¿…é¡»é€šè¿‡ï¼Œå­˜åœ¨criticalé—®é¢˜æ— æ³•éªŒæ”¶"
        pass_condition:
          type: "manual"
          required: true
        on_fail: "é€šè¿‡ç‡æœªè¾¾åˆ°100%ï¼Œéœ€è¦ä¿®å¤å¤±è´¥é¡¹"

      - id: "user_confirmation"
        name: "ç”¨æˆ·ç¡®è®¤"
        description: "AIè¯´'æˆ‘å·²å®Œæˆæ‰€æœ‰éªŒæ”¶é¡¹ï¼Œè¯·æ‚¨ç¡®è®¤'ï¼Œç­‰å¾…ç”¨æˆ·è¯´'æ²¡é—®é¢˜'"
        pass_condition:
          type: "manual"
          required: true
        on_fail: "ç­‰å¾…ç”¨æˆ·ç¡®è®¤"

    on_pass:
      - "create: .gates/06.ok"
      - "create: .workflow/WAITING_MERGE_CONFIRMATION"
      - "set: .phase/current=Phase7"
      - "display: .workflow/VERIFICATION_REPORT.md"
      - "prompt: è¯·æŸ¥çœ‹éªŒæ”¶æŠ¥å‘Šï¼Œç¡®è®¤åå›å¤'æ²¡é—®é¢˜'"

    recommended_agents:
      - "qa-specialist"
      - "test-engineer"
      - "technical-writer"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Phase 7: Closureï¼ˆæ”¶å°¾åˆå¹¶ï¼‰- 4æ£€æŸ¥ç‚¹
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase7:
    name: "Closure - æ”¶å°¾åˆå¹¶"
    description: "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ + æœ€ç»ˆéªŒè¯ + å‡†å¤‡åˆå¹¶"
    checkpoint_count: 4

    allow_paths:
      - ".temp/**"
      - ".workflow/**"
      - "docs/**"
      - ".gates/**"
      - ".phase/**"

    must_produce:
      - "å¹²å‡€çš„.temp/ç›®å½•ï¼ˆ<10MBï¼‰"
      - "æœ€ç»ˆç‰ˆæœ¬ä¸€è‡´æ€§éªŒè¯é€šè¿‡"
      - "æ–‡æ¡£è§„èŒƒéªŒè¯é€šè¿‡"
      - "merge-readyçŠ¶æ€"

    mandatory_checks:
      - name: version_consistency_final
        description: "æœ€ç»ˆç‰ˆæœ¬ä¸€è‡´æ€§éªŒè¯"
        command: "bash scripts/check_version_consistency.sh"
        blocking: true

    gates:
      - ".temp/ å¤§å° < 10MB"
      - "ç‰ˆæœ¬å®Œå…¨ä¸€è‡´æ€§ï¼ˆ5æ–‡ä»¶ï¼‰"
      - "æ ¹ç›®å½•æ–‡æ¡£â‰¤7ä¸ª"
      - "æ ¸å¿ƒç»“æ„å®Œæ•´æ€§éªŒè¯é€šè¿‡"
      - "ç­‰å¾…ç”¨æˆ·è¯´'merge'æ‰èƒ½åˆå¹¶"

    on_pass:
      - "create: .gates/07.ok"
      - "set: .phase/current=READY_TO_MERGE"
      - "prompt: æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œç­‰å¾…æ‚¨ç¡®è®¤'merge'ååˆå¹¶åˆ°main"

    recommended_agents:
      - "qa-specialist"
      - "technical-writer"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Quality Gates Summary (æ–°å¢å®Œæ•´å®šä¹‰)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
quality_gates:
  total_gates: 2

  gate1:
    phase: "Phase 3"
    name: "æŠ€æœ¯è´¨é‡é—¨ç¦"
    description: "è‡ªåŠ¨åŒ–æµ‹è¯•å’Œé™æ€æ£€æŸ¥ï¼Œç¡®ä¿ä»£ç è´¨é‡"
    mandatory_checks:
      - "bash scripts/static_checks.sh"
    blocking_conditions:
      - "ä»»ä½•è¯­æ³•é”™è¯¯"
      - "shellcheckè­¦å‘Š"
      - "å‡½æ•°å¤æ‚åº¦è¶…æ ‡ï¼ˆ>150è¡Œï¼‰"
      - "hookæ€§èƒ½è¶…æ ‡ï¼ˆ>2ç§’ï¼‰"
      - "æµ‹è¯•è¦†ç›–ç‡<70%"
    enforcement: "hard"  # ç¡¬é˜»æ­¢ï¼Œä»»ä½•å¤±è´¥éƒ½é˜»æ­¢è¿›å…¥Phase 4

  gate2:
    phase: "Phase 4"
    name: "ä»£ç è´¨é‡é—¨ç¦"
    description: "äººå·¥å®¡æŸ¥å’Œè‡ªåŠ¨åŒ–å®¡è®¡ï¼Œç¡®ä¿å‘å¸ƒè´¨é‡"
    mandatory_checks:
      - "bash scripts/pre_merge_audit.sh"
    blocking_conditions:
      - "å­˜åœ¨criticalå®‰å…¨é—®é¢˜"
      - "å­˜åœ¨criticalè´¨é‡é—®é¢˜"
      - "ç‰ˆæœ¬ä¸ä¸€è‡´"
      - "æ ¹ç›®å½•æ–‡æ¡£>7ä¸ª"
      - "Phase 1 checklistå®Œæˆåº¦<90%"
    enforcement: "hard"  # ç¡¬é˜»æ­¢ï¼Œä»»ä½•å¤±è´¥éƒ½é˜»æ­¢è¿›å…¥Phase 5

  code_standards:
    - "æ‰€æœ‰å‡½æ•°å¿…é¡»æœ‰æ³¨é‡Š"
    - "å…³é”®é€»è¾‘å¿…é¡»æœ‰å•å…ƒæµ‹è¯•"
    - "å®‰å…¨æ•æ„Ÿä»£ç å¿…é¡»å®¡è®¡"

  security_baseline:
    - "æ— SQLæ³¨å…¥é£é™©"
    - "æ— XSSæ¼æ´"
    - "æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨"
    - "æƒé™æ£€æŸ¥å®Œæ•´"

  performance_baseline:
    - "APIå“åº”æ—¶é—´ < 200ms (P95)"
    - "æ•°æ®åº“æŸ¥è¯¢ < 100ms (P95)"
    - "é¡µé¢åŠ è½½ < 3s"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Hard Blocks Summary (ç¡¬æ€§é˜»æ­¢æ¡ä»¶ç»Ÿè®¡)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
hard_blocks:
  total_count: 8

  by_phase:
    Phase1: 1  # åˆ†æ”¯æ£€æŸ¥å¤±è´¥
    Phase3: 2  # è¯­æ³•é”™è¯¯ + shellcheckå¤±è´¥
    Phase4: 2  # criticalé—®é¢˜ + ç‰ˆæœ¬ä¸ä¸€è‡´
    Phase5: 2  # æ–‡æ¡£è§„èŒƒ + checklistæœªå®Œæˆ
    Phase6: 1  # ç”¨æˆ·æœªç¡®è®¤

# è‡ªåŠ¨å›æ»šé…ç½®
rollback_triggers:
  - "å¥åº·æ£€æŸ¥å¤±è´¥"
  - "é”™è¯¯ç‡ > 5%"
  - "å“åº”æ—¶é—´ > 2x baseline"
  - "CPUä½¿ç”¨ç‡ > 90%"
  - "æ ¸å¿ƒç»“æ„å®Œæ•´æ€§éªŒè¯å¤±è´¥"

# Validation Performance Tracking
performance_tracking:
  enabled: true
  log_path: .temp/quality_gates/performance.log
  alert_threshold_ms: 200
  metrics:
    - validation_duration
    - blocking_count
    - pass_rate
    - core_verification_time

# Reporting Configuration
reporting:
  enabled: true
  output_path: .temp/quality_gates/reports
  formats:
    - json
    - markdown
  summary_on_failure: true
  daily_summary: true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Branch Protection Configuration (GitHubæœåŠ¡ç«¯ä¿æŠ¤)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
branch_protection:
  enabled: true
  description: "GitHubæœåŠ¡ç«¯åˆ†æ”¯ä¿æŠ¤é…ç½®ï¼ˆLayer 8é˜²æŠ¤ï¼‰"

  protected_branches:
    - main
    - master
    - production

  required_status_checks:
    strict: true  # è¦æ±‚PRå¿…é¡»åŸºäºæœ€æ–°çš„baseåˆ†æ”¯
    checks:
      - "CE Unified Gates"
      - "Quality Gate (Required Check)"
      - "ce/phase3-static-checks"
      - "ce/phase4-pre-merge-audit"
      - "ce/phase7-final-validation"
      - "Stage 3: Pre-merge Audit (Gate 2)"

  enforce_admins: true  # ç®¡ç†å‘˜ä¹Ÿå¿…é¡»éµå®ˆè§„åˆ™

  required_pull_request_reviews:
    dismiss_stale_reviews: false
    require_code_owner_reviews: false
    required_approving_review_count: 0  # ä¸ªäººé¡¹ç›®æ— éœ€å®¡æ‰¹

  restrictions: null  # ä¸é™åˆ¶ç‰¹å®šç”¨æˆ·/å›¢é˜Ÿ

  require_linear_history: false
  allow_force_pushes: false
  allow_deletions: false

  block_creations: false
  required_conversation_resolution: false

  # é…ç½®æ¥æº
  configured_via: "GitHub Branch Protection API"
  configured_date: "2025-10-29"
  rationale: "é˜²å¾¡--no-verifyç»•è¿‡ï¼Œå¼ºåˆ¶PRæµç¨‹å’ŒCIéªŒè¯"

# é€šçŸ¥é…ç½®
notifications:
  on_gate_fail:
    - type: "log"
      path: ".workflow/logs/gate_failures.log"
  on_phase_complete:
    - type: "log"
      path: ".workflow/logs/phase_completion.log"
  on_rollback:
    - type: "log"
      path: ".workflow/logs/rollback.log"
    - type: "alert"
      severity: "high"
  on_core_structure_change:
    - type: "log"
      path: ".workflow/logs/core_structure_changes.log"
    - type: "alert"
      severity: "critical"
