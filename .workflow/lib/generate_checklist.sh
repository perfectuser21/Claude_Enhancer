#!/bin/bash
# Checklistç”Ÿæˆå™¨
# æ ¹æ®éœ€æ±‚å¯¹è¯ç”ŸæˆéªŒæ”¶æ¸…å•

set -euo pipefail

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
WORKFLOW_DIR="$PROJECT_ROOT/.workflow"
REQUIREMENTS_FILE="$WORKFLOW_DIR/REQUIREMENTS_DIALOGUE.md"
CHECKLIST_FILE="$WORKFLOW_DIR/CHECKLIST.md"

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() {
    echo -e "${CYAN}[INFO]${NC} $*"
}

log_success() {
    echo -e "${GREEN}[âœ“]${NC} $*"
}

generate_checklist() {
    local feature_name="${1:-æœªå‘½ååŠŸèƒ½}"

    log_info "å¼€å§‹ç”ŸæˆéªŒæ”¶æ¸…å•..."

    # æ£€æŸ¥éœ€æ±‚å¯¹è¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [[ ! -f "$REQUIREMENTS_FILE" ]]; then
        echo "é”™è¯¯ï¼šéœ€æ±‚å¯¹è¯æ–‡ä»¶ä¸å­˜åœ¨ï¼š$REQUIREMENTS_FILE"
        echo "è¯·å…ˆå®Œæˆéœ€æ±‚æ¾„æ¸…é˜¶æ®µ"
        exit 1
    fi

    # ç”ŸæˆChecklist
    cat > "$CHECKLIST_FILE" <<EOF
# ${feature_name} éªŒæ”¶æ¸…å•

**ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
**åŸºäºå¯¹è¯**: .workflow/REQUIREMENTS_DIALOGUE.md
**åŠŸèƒ½åç§°**: ${feature_name}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ“‹ åŠŸèƒ½éªŒæ”¶æ¸…å•

$(extract_functional_checklist)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ” è´¨é‡ä¿è¯æ¸…å•

### ä»£ç è´¨é‡
[ ] ä»£ç æ„å»ºé€šè¿‡ï¼ˆæ— ç¼–è¯‘é”™è¯¯ï¼‰
[ ] æ— æ˜æ˜¾ä»£ç åå‘³é“
[ ] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
[ ] æ— æœªä½¿ç”¨çš„å¯¼å…¥å’Œå˜é‡

### æµ‹è¯•è¦†ç›–
[ ] æµ‹è¯•è¦†ç›–ç‡ â‰¥ 60%
[ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
[ ] å…³é”®åŠŸèƒ½æœ‰æµ‹è¯•ç”¨ä¾‹
[ ] è¾¹ç•Œæƒ…å†µæœ‰æµ‹è¯•

### æ€§èƒ½
[ ] æ— æ˜æ˜¾æ€§èƒ½é—®é¢˜
[ ] å…³é”®æ“ä½œå“åº”æ—¶é—´ < 500ms
[ ] æ— å†…å­˜æ³„æ¼
[ ] æ— é˜»å¡ä¸»çº¿ç¨‹çš„æ“ä½œ

### å®‰å…¨
[ ] æ— æ˜æ˜¾å®‰å…¨æ¼æ´
[ ] æ•æ„Ÿä¿¡æ¯å·²åŠ å¯†
[ ] è¾“å…¥å·²éªŒè¯
[ ] æ— SQLæ³¨å…¥é£é™©

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**æ€»è®¡**: $(count_checklist_items)é¡¹éªŒæ”¶æ ‡å‡†

**çŠ¶æ€**: â³ ç­‰å¾…éªŒè¯

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**éªŒè¯è¯´æ˜**ï¼š
- P7é˜¶æ®µä¼šè‡ªåŠ¨éªŒè¯è¿™ä¸ªæ¸…å•çš„æ¯ä¸€é¡¹
- æ‰€æœ‰é¡¹ç›®é€šè¿‡åï¼Œä¼šç”ŸæˆéªŒæ”¶æŠ¥å‘Š
- æ‚¨ç¡®è®¤åï¼Œå³å¯mergeåˆ°mainåˆ†æ”¯

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

    log_success "éªŒæ”¶æ¸…å•å·²ç”Ÿæˆ: $CHECKLIST_FILE"

    # æ˜¾ç¤ºç»Ÿè®¡
    local total_items=$(count_checklist_items)
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š Checklistç»Ÿè®¡"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "  åŠŸèƒ½éªŒæ”¶é¡¹: $(grep -c '^\[ \] [0-9]' "$CHECKLIST_FILE" || echo 0)ä¸ª"
    echo "  è´¨é‡ä¿è¯é¡¹: $(grep -c '^\[ \] [^0-9]' "$CHECKLIST_FILE" || echo 0)ä¸ª"
    echo "  æ€»è®¡: ${total_items}ä¸ª"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

extract_functional_checklist() {
    # ä»éœ€æ±‚å¯¹è¯ä¸­æå–åŠŸèƒ½æ¸…å•
    # è¿™ä¸ªå‡½æ•°ä¼šè¢«AIåœ¨å®é™…ä½¿ç”¨æ—¶è‡ªå®šä¹‰å¡«å……

    # ç¤ºä¾‹ç»“æ„ï¼ˆAIä¼šæ ¹æ®å®é™…éœ€æ±‚å¯¹è¯ç”Ÿæˆï¼‰
    cat <<'ITEMS'
### 1. æ ¸å¿ƒåŠŸèƒ½
[ ] 1.1 åŠŸèƒ½ç‚¹1ï¼ˆä»éœ€æ±‚å¯¹è¯ä¸­æå–ï¼‰
[ ] 1.2 åŠŸèƒ½ç‚¹2
[ ] 1.3 åŠŸèƒ½ç‚¹3

### 2. ç”¨æˆ·äº¤äº’
[ ] 2.1 äº¤äº’ç‚¹1
[ ] 2.2 äº¤äº’ç‚¹2

### 3. ç‰¹æ®Šæƒ…å†µå¤„ç†
[ ] 3.1 è¾¹ç•Œæƒ…å†µ1
[ ] 3.2 è¾¹ç•Œæƒ…å†µ2

### 4. å®‰å…¨è§„åˆ™
[ ] 4.1 å®‰å…¨è§„åˆ™1
[ ] 4.2 å®‰å…¨è§„åˆ™2
ITEMS
}

count_checklist_items() {
    if [[ -f "$CHECKLIST_FILE" ]]; then
        grep -c '^\[ \]' "$CHECKLIST_FILE" || echo 0
    else
        echo 0
    fi
}

# ä¿å­˜åŠŸèƒ½åç§°ä¾›åç»­ä½¿ç”¨
save_feature_name() {
    local feature_name="${1:-}"
    echo "$feature_name" > "$WORKFLOW_DIR/FEATURE_NAME.txt"
}

# ä¸»å‡½æ•°
main() {
    local feature_name="${1:-}"

    if [[ -z "$feature_name" ]]; then
        # å°è¯•ä»éœ€æ±‚æ–‡ä»¶ä¸­æå–
        if [[ -f "$REQUIREMENTS_FILE" ]]; then
            feature_name=$(head -n 1 "$REQUIREMENTS_FILE" | sed 's/^# *//' | sed 's/ *$//')
        fi

        if [[ -z "$feature_name" ]]; then
            feature_name="æœªå‘½ååŠŸèƒ½"
        fi
    fi

    save_feature_name "$feature_name"
    generate_checklist "$feature_name"
}

# å¦‚æœç›´æ¥æ‰§è¡Œè„šæœ¬
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
