name: ğŸ“‹ Documentation Quality Check

on:
  push:
    branches: [ main, develop, 'feature/**', 'docs/**' ]
    paths:
      - '**/*.md'
      - '**/*.mdx'
      - '.github/workflows/docs-quality-check.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.md'
      - '**/*.mdx'
      - '.github/workflows/docs-quality-check.yml'

# ç¡®ä¿åªæœ‰ä¸€ä¸ªworkflowå®ä¾‹è¿è¡Œ
concurrency:
  group: docs-quality-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  docs-quality-check:
    name: ğŸ” Deep Documentation Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5  # ä¸¥æ ¼æ§åˆ¶åœ¨5åˆ†é’Ÿå†…å®Œæˆ

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      # ===== ç¯å¢ƒå‡†å¤‡ (15s) =====
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§¹ Cache Setup
        uses: actions/cache@v3
        id: cache
        with:
          path: |
            ~/.npm
            ~/.cache/pip
            node_modules
            .markdownlint-cache
          key: docs-quality-${{ runner.os }}-${{ hashFiles('**/package*.json', 'requirements.txt') }}
          restore-keys: |
            docs-quality-${{ runner.os }}-

      # ===== å¹¶è¡Œå®‰è£…å·¥å…· (30s) =====
      - name: ğŸš€ Setup Node.js & Python
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: âš¡ Install Tools (Parallel)
        run: |
          # å¹¶è¡Œå®‰è£…æ‰€æœ‰å¿…éœ€å·¥å…·
          {
            npm install -g markdownlint-cli2 markdown-link-check write-good alex &
            pip install --quiet proselint textstat markdown-link-validator &
            wait
          }

          # éªŒè¯å®‰è£…
          echo "âœ… Tools installed successfully:"
          markdownlint-cli2 --version
          echo "markdown-link-check: $(markdown-link-check --version 2>/dev/null || echo 'installed')"
          echo "write-good: $(write-good --version 2>/dev/null || echo 'installed')"
          echo "alex: $(alex --version 2>/dev/null || echo 'installed')"
          proselint --version
          python -c "import textstat; print(f'textstat: {textstat.__version__}')"

      # ===== æ–‡æ¡£å‘ç°ä¸åˆ†æ (10s) =====
      - name: ğŸ” Discover Documentation Files
        id: discover
        run: |
          echo "ğŸ” Discovering documentation files..."

          # æŸ¥æ‰¾æ‰€æœ‰æ–‡æ¡£æ–‡ä»¶ï¼ˆæ’é™¤node_modulesï¼‰
          find . -type f \( -name "*.md" -o -name "*.mdx" \) \
            ! -path "./node_modules/*" \
            ! -path "./.git/*" \
            ! -path "./build/*" \
            ! -path "./dist/*" > docs_files.txt

          # ç»Ÿè®¡ä¿¡æ¯
          TOTAL_FILES=$(wc -l < docs_files.txt)
          TOTAL_SIZE=$(cat docs_files.txt | xargs du -b 2>/dev/null | awk '{sum += $1} END {print sum}' || echo "0")

          echo "ğŸ“Š Documentation Statistics:"
          echo "- Total files: $TOTAL_FILES"
          echo "- Total size: $(echo $TOTAL_SIZE | awk '{print int($1/1024)"KB"}')"

          # åˆ†ç±»æ–‡ä»¶
          grep -E "(README|readme)" docs_files.txt > readme_files.txt || touch readme_files.txt
          grep -E "(CHANGELOG|changelog)" docs_files.txt > changelog_files.txt || touch changelog_files.txt
          grep -E "docs/" docs_files.txt > docs_folder_files.txt || touch docs_folder_files.txt

          # è¾“å‡ºå˜é‡
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "total_size_kb=$(echo $TOTAL_SIZE | awk '{print int($1/1024)}')" >> $GITHUB_OUTPUT

      # ===== å¹¶è¡Œè´¨é‡æ£€æŸ¥ (60s) =====
      - name: ğŸ“ Markdown Linting
        id: markdown_lint
        run: |
          echo "ğŸ” Running markdown linting..."

          # åˆ›å»ºmarkdownlinté…ç½®
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD001": false,
            "MD003": { "style": "atx" },
            "MD007": { "indent": 2 },
            "MD013": { "line_length": 120 },
            "MD024": { "allow_different_nesting": true },
            "MD033": { "allowed_elements": ["details", "summary", "br", "img"] },
            "MD041": false
          }
          EOF

          # è¿è¡Œlintingå¹¶æ”¶é›†ç»“æœ
          if markdownlint-cli2 --config .markdownlint.json "**/*.md" "!node_modules/**" > markdown_lint.log 2>&1; then
            echo "âœ… Markdown linting passed"
            echo "lint_status=passed" >> $GITHUB_OUTPUT
            echo "lint_issues=0" >> $GITHUB_OUTPUT
          else
            ISSUES=$(wc -l < markdown_lint.log)
            echo "âš ï¸ Markdown linting found $ISSUES issues"
            echo "lint_status=failed" >> $GITHUB_OUTPUT
            echo "lint_issues=$ISSUES" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”— Link Validation
        id: link_check
        run: |
          echo "ğŸ” Checking documentation links..."

          # åˆ›å»ºé“¾æ¥æ£€æŸ¥é…ç½®
          cat > .markdown-link-check.json << 'EOF'
          {
            "timeout": "5s",
            "retryOn429": true,
            "retryCount": 2,
            "ignorePatterns": [
              {
                "pattern": "^http://localhost"
              },
              {
                "pattern": "^https://localhost"
              },
              {
                "pattern": "^#"
              }
            ],
            "replacementPatterns": [
              {
                "pattern": "^/",
                "replacement": "{{BASEURL}}/"
              }
            ]
          }
          EOF

          # å¹¶è¡Œæ£€æŸ¥é“¾æ¥
          broken_links=0
          total_links=0

          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              echo "Checking links in: $file"
              if ! markdown-link-check "$file" --config .markdown-link-check.json --quiet; then
                ((broken_links++))
              fi
              # ç»Ÿè®¡é“¾æ¥æ•°é‡
              link_count=$(grep -o '\[.*\](.*)'  "$file" 2>/dev/null | wc -l || echo 0)
              total_links=$((total_links + link_count))
            fi
          done < docs_files.txt

          echo "ğŸ”— Link check summary:"
          echo "- Total links: $total_links"
          echo "- Files with broken links: $broken_links"

          echo "total_links=$total_links" >> $GITHUB_OUTPUT
          echo "broken_links=$broken_links" >> $GITHUB_OUTPUT

      - name: âœï¸ Writing Quality Analysis
        id: writing_quality
        run: |
          echo "âœï¸ Analyzing writing quality..."

          # åˆå§‹åŒ–è®¡æ•°å™¨
          total_issues=0
          readability_scores=""

          # ä¸ºæ¯ä¸ªæ–‡æ¡£æ–‡ä»¶è¿è¡Œè´¨é‡æ£€æŸ¥
          while IFS= read -r file; do
            if [[ -f "$file" && -s "$file" ]]; then
              echo "Analyzing: $file"

              # å¯è¯»æ€§åˆ†æ
              if command -v python3 >/dev/null; then
                score=$(python3 -c "
          import textstat
          import sys
          try:
              with open('$file', 'r', encoding='utf-8') as f:
                  text = f.read()
              # ç§»é™¤markdownè¯­æ³•
              import re
              text = re.sub(r'[#*`\[\]()]', '', text)
              text = re.sub(r'!\[.*?\]\(.*?\)', '', text)
              if len(text.strip()) > 100:
                  score = textstat.flesch_reading_ease(text)
                  print(f'{score:.1f}')
              else:
                  print('N/A')
          except:
              print('N/A')
          " 2>/dev/null)

                if [[ "$score" != "N/A" ]]; then
                  readability_scores="$readability_scores$file:$score;"
                fi
              fi

              # å†™ä½œå»ºè®® (ç®€åŒ–ç‰ˆï¼Œå¿«é€Ÿæ£€æŸ¥)
              if command -v write-good >/dev/null; then
                suggestions=$(write-good "$file" 2>/dev/null | wc -l || echo 0)
                total_issues=$((total_issues + suggestions))
              fi

            fi
          done < docs_files.txt

          # è®¡ç®—å¹³å‡å¯è¯»æ€§
          avg_readability="N/A"
          if [[ -n "$readability_scores" ]]; then
            avg_readability=$(echo "$readability_scores" | tr ';' '\n' | grep ':' | cut -d':' -f2 | awk '{sum+=$1; count++} END {if(count>0) print sum/count; else print "N/A"}')
          fi

          echo "ğŸ“Š Writing quality summary:"
          echo "- Total writing suggestions: $total_issues"
          echo "- Average readability score: $avg_readability"

          echo "writing_issues=$total_issues" >> $GITHUB_OUTPUT
          echo "avg_readability=$avg_readability" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Documentation Structure Analysis
        id: structure_analysis
        run: |
          echo "ğŸ—ï¸ Analyzing documentation structure..."

          # åˆ†ææ–‡æ¡£ç»“æ„
          readme_count=$(cat readme_files.txt | wc -l)
          changelog_count=$(cat changelog_files.txt | wc -l)
          docs_folder_count=$(cat docs_folder_files.txt | wc -l)

          # æ£€æŸ¥å¿…éœ€æ–‡æ¡£
          has_main_readme=false
          has_contributing=false
          has_license=false

          if [[ -f "README.md" || -f "readme.md" ]]; then
            has_main_readme=true
          fi

          if find . -maxdepth 2 -name "CONTRIBUTING*" -o -name "contributing*" | grep -q .; then
            has_contributing=true
          fi

          if find . -maxdepth 2 -name "LICENSE*" -o -name "license*" | grep -q .; then
            has_license=true
          fi

          # åˆ†ææ ‡é¢˜å±‚æ¬¡
          heading_issues=0
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              # æ£€æŸ¥æ ‡é¢˜å±‚æ¬¡æ˜¯å¦æ­£ç¡®ï¼ˆä¸è·³çº§ï¼‰
              heading_levels=$(grep -E '^#{1,6} ' "$file" 2>/dev/null | sed 's/^#\+//' | wc -l || echo 0)
              if [[ $heading_levels -gt 0 ]]; then
                # ç®€åŒ–çš„æ ‡é¢˜æ£€æŸ¥
                first_heading=$(grep -E '^#{1,6} ' "$file" 2>/dev/null | head -1 | grep -o '^#\+' | wc -c || echo 1)
                if [[ $first_heading -gt 2 ]]; then  # ç¬¬ä¸€ä¸ªæ ‡é¢˜ä¸åº”è¯¥æ˜¯ ### å¼€å§‹
                  ((heading_issues++))
                fi
              fi
            fi
          done < docs_files.txt

          echo "ğŸ“‹ Structure analysis:"
          echo "- README files: $readme_count"
          echo "- Changelog files: $changelog_count"
          echo "- Docs folder files: $docs_folder_count"
          echo "- Has main README: $has_main_readme"
          echo "- Has contributing guide: $has_contributing"
          echo "- Has license: $has_license"
          echo "- Heading structure issues: $heading_issues"

          echo "readme_count=$readme_count" >> $GITHUB_OUTPUT
          echo "changelog_count=$changelog_count" >> $GITHUB_OUTPUT
          echo "docs_folder_count=$docs_folder_count" >> $GITHUB_OUTPUT
          echo "has_main_readme=$has_main_readme" >> $GITHUB_OUTPUT
          echo "has_contributing=$has_contributing" >> $GITHUB_OUTPUT
          echo "has_license=$has_license" >> $GITHUB_OUTPUT
          echo "heading_issues=$heading_issues" >> $GITHUB_OUTPUT

      # ===== ç”Ÿæˆè´¨é‡æŠ¥å‘Š (20s) =====
      - name: ğŸ“ˆ Generate Quality Report
        id: generate_report
        run: |
          echo "ğŸ“ˆ Generating comprehensive quality report..."

          # åˆ›å»ºè¯¦ç»†æŠ¥å‘Š
          cat > docs_quality_report.md << 'EOF'
          # ğŸ“‹ Documentation Quality Report

          ## ğŸ“Š Overview

          | Metric | Value | Status |
          |--------|-------|--------|
          | Total Documentation Files | ${{ steps.discover.outputs.total_files }} | ğŸ“„ |
          | Total Size | ${{ steps.discover.outputs.total_size_kb }}KB | ğŸ’¾ |
          | Markdown Lint Issues | ${{ steps.markdown_lint.outputs.lint_issues }} | ${{ steps.markdown_lint.outputs.lint_status == 'passed' && 'âœ…' || 'âš ï¸' }} |
          | Broken Links | ${{ steps.link_check.outputs.broken_links }} | ${{ steps.link_check.outputs.broken_links == '0' && 'âœ…' || 'âš ï¸' }} |
          | Writing Quality Issues | ${{ steps.writing_quality.outputs.writing_issues }} | ${{ steps.writing_quality.outputs.writing_issues == '0' && 'âœ…' || 'ğŸ“' }} |
          | Average Readability Score | ${{ steps.writing_quality.outputs.avg_readability }} | ğŸ“– |

          ## ğŸ—ï¸ Documentation Structure

          | Element | Count | Present |
          |---------|-------|---------|
          | README Files | ${{ steps.structure_analysis.outputs.readme_count }} | ğŸ“– |
          | Changelog Files | ${{ steps.structure_analysis.outputs.changelog_count }} | ğŸ“… |
          | Docs Folder Files | ${{ steps.structure_analysis.outputs.docs_folder_count }} | ğŸ“ |
          | Main README | - | ${{ steps.structure_analysis.outputs.has_main_readme == 'true' && 'âœ…' || 'âŒ' }} |
          | Contributing Guide | - | ${{ steps.structure_analysis.outputs.has_contributing == 'true' && 'âœ…' || 'âŒ' }} |
          | License File | - | ${{ steps.structure_analysis.outputs.has_license == 'true' && 'âœ…' || 'âŒ' }} |

          ## ğŸ¯ Quality Score

          EOF

          # è®¡ç®—ç»¼åˆè´¨é‡åˆ†æ•°
          score=100

          # æ‰£åˆ†è§„åˆ™
          if [[ "${{ steps.markdown_lint.outputs.lint_issues }}" != "0" ]]; then
            score=$((score - 10))
          fi

          if [[ "${{ steps.link_check.outputs.broken_links }}" != "0" ]]; then
            score=$((score - 15))
          fi

          if [[ "${{ steps.writing_quality.outputs.writing_issues }}" -gt 10 ]]; then
            score=$((score - 10))
          fi

          if [[ "${{ steps.structure_analysis.outputs.has_main_readme }}" != "true" ]]; then
            score=$((score - 20))
          fi

          if [[ "${{ steps.structure_analysis.outputs.heading_issues }}" -gt 0 ]]; then
            score=$((score - 5))
          fi

          # ç¡®ä¿åˆ†æ•°ä¸ä½äº0
          if [[ $score -lt 0 ]]; then
            score=0
          fi

          # ç¡®å®šç­‰çº§
          if [[ $score -ge 90 ]]; then
            grade="A+"
            emoji="ğŸ†"
          elif [[ $score -ge 80 ]]; then
            grade="A"
            emoji="ğŸ¥‡"
          elif [[ $score -ge 70 ]]; then
            grade="B"
            emoji="ğŸ¥ˆ"
          elif [[ $score -ge 60 ]]; then
            grade="C"
            emoji="ğŸ¥‰"
          else
            grade="D"
            emoji="âŒ"
          fi

          # æ·»åŠ åˆ†æ•°åˆ°æŠ¥å‘Š
          cat >> docs_quality_report.md << EOF

          ### Overall Score: ${score}/100 (Grade: ${grade}) ${emoji}

          $(if [[ $score -ge 80 ]]; then
            echo "ğŸ‰ **Excellent!** Your documentation meets high quality standards."
          elif [[ $score -ge 60 ]]; then
            echo "ğŸ‘ **Good!** Your documentation is solid with room for improvement."
          else
            echo "âš ï¸ **Needs Improvement** Your documentation needs attention to meet quality standards."
          fi)

          ## ğŸ”§ Recommendations

          EOF

          # ç”Ÿæˆå»ºè®®
          if [[ "${{ steps.markdown_lint.outputs.lint_issues }}" != "0" ]]; then
            echo "- ğŸ”§ Fix markdown linting issues for better consistency" >> docs_quality_report.md
          fi

          if [[ "${{ steps.link_check.outputs.broken_links }}" != "0" ]]; then
            echo "- ğŸ”— Update or remove broken links" >> docs_quality_report.md
          fi

          if [[ "${{ steps.structure_analysis.outputs.has_main_readme }}" != "true" ]]; then
            echo "- ğŸ“– Add a comprehensive README.md file" >> docs_quality_report.md
          fi

          if [[ "${{ steps.structure_analysis.outputs.has_contributing }}" != "true" ]]; then
            echo "- ğŸ¤ Consider adding a CONTRIBUTING.md guide" >> docs_quality_report.md
          fi

          if [[ "${{ steps.writing_quality.outputs.writing_issues }}" -gt 5 ]]; then
            echo "- âœï¸ Review and improve writing quality based on suggestions" >> docs_quality_report.md
          fi

          # æ·»åŠ æ—¶é—´æˆ³
          echo "" >> docs_quality_report.md
          echo "---" >> docs_quality_report.md
          echo "*Report generated on $(date -u '+%Y-%m-%d %H:%M:%S UTC') by GitHub Actions*" >> docs_quality_report.md

          echo "quality_score=$score" >> $GITHUB_OUTPUT
          echo "quality_grade=$grade" >> $GITHUB_OUTPUT

      # ===== å‘å¸ƒç»“æœ (15s) =====
      - name: ğŸ“¤ Upload Quality Report
        uses: actions/upload-artifact@v3
        with:
          name: documentation-quality-report
          path: |
            docs_quality_report.md
            markdown_lint.log
            docs_files.txt
          retention-days: 30

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('docs_quality_report.md', 'utf8');

            const comment = `## ğŸ“‹ Documentation Quality Check Results

            ${report}

            <details>
            <summary>ğŸ” View Detailed Analysis</summary>

            ### Workflow Details
            - **Execution Time**: ${{ job.container.network }} seconds
            - **Trigger**: ${context.eventName} on ${context.ref}
            - **Commit**: ${context.sha.substring(0, 7)}

            ### Files Analyzed
            - **Total Documentation Files**: ${{ steps.discover.outputs.total_files }}
            - **Total Links Checked**: ${{ steps.link_check.outputs.total_links }}
            - **File Types**: Markdown (.md, .mdx)

            </details>

            ---
            *Automated quality check by [GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: âœ… Set Status Check
        if: always()
        run: |
          if [[ "${{ steps.markdown_lint.outputs.lint_status }}" == "passed" &&
                "${{ steps.link_check.outputs.broken_links }}" == "0" &&
                "${{ steps.generate_report.outputs.quality_score }}" -ge 70 ]]; then
            echo "âœ… Documentation quality check passed"
            exit 0
          else
            echo "âŒ Documentation quality check failed"
            echo "Quality score: ${{ steps.generate_report.outputs.quality_score }}/100"
            exit 1
          fi

  # ===== å¹¶è¡Œæ‰§è¡Œçš„è¡¥å……æ£€æŸ¥ =====
  accessibility-check:
    name: â™¿ Accessibility Check
    runs-on: ubuntu-latest
    timeout-minutes: 2
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ” Check Documentation Accessibility
        run: |
          echo "â™¿ Checking documentation accessibility..."

          # æ£€æŸ¥å›¾ç‰‡altæ ‡ç­¾
          missing_alt=0
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              # æŸ¥æ‰¾æ²¡æœ‰altå±æ€§çš„å›¾ç‰‡
              if grep -P '!\[(?:\s*)\]\(' "$file" >/dev/null 2>&1; then
                echo "âš ï¸ Missing alt text in: $file"
                ((missing_alt++))
              fi
            fi
          done < <(find . -name "*.md" ! -path "./node_modules/*")

          # æ£€æŸ¥æ ‡é¢˜å±‚æ¬¡
          echo "ğŸ“‹ Accessibility summary:"
          echo "- Images missing alt text: $missing_alt"

          if [[ $missing_alt -gt 0 ]]; then
            echo "âš ï¸ Consider adding descriptive alt text for better accessibility"
            exit 1
          else
            echo "âœ… Accessibility check passed"
          fi

  # ===== æ€§èƒ½ç›‘æ§ =====
  performance-monitor:
    name: âš¡ Performance Monitor
    runs-on: ubuntu-latest
    timeout-minutes: 1

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“Š Monitor Documentation Performance
        run: |
          echo "âš¡ Monitoring documentation performance..."

          start_time=$(date +%s)

          # å¿«é€Ÿæ–‡ä»¶ç»Ÿè®¡
          total_files=$(find . -name "*.md" ! -path "./node_modules/*" | wc -l)
          total_size=$(find . -name "*.md" ! -path "./node_modules/*" -exec cat {} \; 2>/dev/null | wc -c)

          end_time=$(date +%s)
          duration=$((end_time - start_time))

          echo "ğŸ“ˆ Performance metrics:"
          echo "- Analysis duration: ${duration}s"
          echo "- Files processed: $total_files"
          echo "- Data processed: $(echo $total_size | awk '{print int($1/1024)"KB"}')"
          echo "- Processing rate: $(echo $total_files $duration | awk '{if($2>0) print int($1/$2)" files/s"; else print "N/A"}')"

          # æ€§èƒ½è­¦å‘Š
          if [[ $duration -gt 120 ]]; then
            echo "âš ï¸ WARNING: Documentation processing took longer than expected (${duration}s > 120s)"
            exit 1
          else
            echo "âœ… Performance within acceptable limits"
          fi