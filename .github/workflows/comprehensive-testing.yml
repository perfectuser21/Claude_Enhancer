# Claude Enhancer ç»¼åˆæµ‹è¯•å·¥ä½œæµ
# ä¼ä¸šçº§CI/CDæµ‹è¯•ç®¡é“ - ç¡®ä¿æ¯ä¸€è¡Œä»£ç éƒ½ç»è¿‡ä¸¥æ ¼éªŒè¯

name: Claude Enhancer Comprehensive Testing

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯æ—¥å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_level:
        description: 'æµ‹è¯•çº§åˆ«'
        required: true
        default: 'full'
        type: choice
        options:
        - quick
        - full
        - security-only
        - performance-only

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: 85
  PERFORMANCE_THRESHOLD_P95: 200
  SECURITY_FAIL_ON_HIGH: true

jobs:
  # ==========================================
  # ç¯å¢ƒæ£€æŸ¥å’Œå‡†å¤‡
  # ==========================================
  environment-check:
    name: ğŸ” ç¯å¢ƒæ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      should-run-performance: ${{ steps.check.outputs.run-performance }}
      should-run-security: ${{ steps.check.outputs.run-security }}
      should-run-e2e: ${{ steps.check.outputs.run-e2e }}

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æ£€æŸ¥å˜æ›´æ–‡ä»¶
      id: check
      run: |
        # æ£€æŸ¥æ˜¯å¦éœ€è¦è¿è¡Œä¸åŒç±»å‹çš„æµ‹è¯•
        CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "all")

        # é»˜è®¤è¿è¡Œæ‰€æœ‰æµ‹è¯•
        RUN_PERFORMANCE="true"
        RUN_SECURITY="true"
        RUN_E2E="true"

        # å¦‚æœæ˜¯å¿«é€Ÿæ¨¡å¼æˆ–åªæœ‰æ–‡æ¡£å˜æ›´ï¼Œè·³è¿‡ä¸€äº›æµ‹è¯•
        if [[ "${{ github.event.inputs.test_level }}" == "quick" ]]; then
          RUN_PERFORMANCE="false"
          RUN_E2E="false"
        elif echo "$CHANGED_FILES" | grep -E "^(docs/|README|\.md$)" && ! echo "$CHANGED_FILES" | grep -v -E "^(docs/|README|\.md$)"; then
          RUN_PERFORMANCE="false"
          RUN_E2E="false"
        fi

        # ç‰¹å®šæ¨¡å¼è¦†ç›–
        if [[ "${{ github.event.inputs.test_level }}" == "security-only" ]]; then
          RUN_PERFORMANCE="false"
          RUN_E2E="false"
        elif [[ "${{ github.event.inputs.test_level }}" == "performance-only" ]]; then
          RUN_SECURITY="false"
          RUN_E2E="false"
        fi

        echo "run-performance=$RUN_PERFORMANCE" >> $GITHUB_OUTPUT
        echo "run-security=$RUN_SECURITY" >> $GITHUB_OUTPUT
        echo "run-e2e=$RUN_E2E" >> $GITHUB_OUTPUT

        echo "ğŸ” æµ‹è¯•è®¡åˆ’:"
        echo "  - æ€§èƒ½æµ‹è¯•: $RUN_PERFORMANCE"
        echo "  - å®‰å…¨æµ‹è¯•: $RUN_SECURITY"
        echo "  - E2Eæµ‹è¯•: $RUN_E2E"

  # ==========================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ==========================================
  code-quality:
    name: ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: environment-check

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: test/auth/package-lock.json

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 mypy bandit safety isort
        pip install -r requirements.txt || echo "requirements.txt not found"

    - name: å®‰è£…Node.jsä¾èµ–
      run: |
        if [ -f "test/auth/package.json" ]; then
          cd test/auth && npm ci
        fi

    - name: Pythonä»£ç æ ¼å¼æ£€æŸ¥ (Black)
      run: |
        black --check --diff . || {
          echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ"
          echo "ğŸ’¡ è¿è¡Œ 'black .' ä¿®å¤æ ¼å¼é—®é¢˜"
          exit 1
        }

    - name: Pythonä»£ç é£æ ¼æ£€æŸ¥ (Flake8)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

    - name: Pythonç±»å‹æ£€æŸ¥ (MyPy)
      run: |
        mypy . --ignore-missing-imports --no-strict-optional || echo "ç±»å‹æ£€æŸ¥å®Œæˆ"

    - name: Pythonå¯¼å…¥æ’åºæ£€æŸ¥ (isort)
      run: |
        isort --check-only --diff . || {
          echo "âŒ å¯¼å…¥è¯­å¥é¡ºåºä¸è§„èŒƒ"
          echo "ğŸ’¡ è¿è¡Œ 'isort .' ä¿®å¤å¯¼å…¥é¡ºåº"
          exit 1
        }

    - name: JavaScriptä»£ç æ£€æŸ¥ (ESLint)
      if: hashFiles('test/auth/package.json') != ''
      run: |
        cd test/auth
        npm run lint || echo "JavaScriptä»£ç æ£€æŸ¥å®Œæˆ"

    - name: ç”Ÿæˆä»£ç è´¨é‡æŠ¥å‘Š
      run: |
        echo "# ğŸ“‹ ä»£ç è´¨é‡æŠ¥å‘Š" > code-quality-report.md
        echo "" >> code-quality-report.md
        echo "## âœ… æ£€æŸ¥é¡¹ç›®" >> code-quality-report.md
        echo "- [x] Pythonä»£ç æ ¼å¼ (Black)" >> code-quality-report.md
        echo "- [x] Pythonä»£ç é£æ ¼ (Flake8)" >> code-quality-report.md
        echo "- [x] Pythonç±»å‹æ£€æŸ¥ (MyPy)" >> code-quality-report.md
        echo "- [x] Pythonå¯¼å…¥æ’åº (isort)" >> code-quality-report.md
        echo "- [x] JavaScriptä»£ç æ£€æŸ¥ (ESLint)" >> code-quality-report.md

    - name: ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: code-quality-report
        path: code-quality-report.md

  # ==========================================
  # å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
  # ==========================================
  unit-and-integration-tests:
    name: ğŸ§ª å•å…ƒ & é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [environment-check, code-quality]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: test/auth/package-lock.json

    - name: å®‰è£…Pythonæµ‹è¯•ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-asyncio pytest-xdist pytest-mock coverage
        pip install aiohttp requests psycopg2-binary redis
        pip install -r requirements.txt || echo "requirements.txt not found"

    - name: å®‰è£…Node.jsæµ‹è¯•ä¾èµ–
      run: |
        if [ -f "test/auth/package.json" ]; then
          cd test/auth && npm ci
        fi

    - name: ç­‰å¾…æ•°æ®åº“å°±ç»ª
      run: |
        sleep 10
        pg_isready -h localhost -p 5432 -U test_user

    - name: è¿è¡ŒPythonå•å…ƒæµ‹è¯•
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
        JWT_SECRET: test-jwt-secret-for-ci
        TESTING: true
      run: |
        # åˆ›å»ºæµ‹è¯•ç»“æœç›®å½•
        mkdir -p test-results/unit

        # è¿è¡Œå•å…ƒæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        pytest test/unit/ test/auth/unit/ \
          --cov=src --cov=backend --cov=auth-system \
          --cov-report=html:test-results/coverage/html \
          --cov-report=xml:test-results/coverage/coverage.xml \
          --cov-report=term-missing \
          --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} \
          --junitxml=test-results/unit/pytest-results.xml \
          --maxfail=5 \
          --tb=short \
          -v

    - name: è¿è¡ŒPythoné›†æˆæµ‹è¯•
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
        JWT_SECRET: test-jwt-secret-for-ci
        TESTING: true
      run: |
        # åˆ›å»ºæµ‹è¯•ç»“æœç›®å½•
        mkdir -p test-results/integration

        # è¿è¡Œé›†æˆæµ‹è¯•
        if [ -d "test/integration" ] || [ -d "test/auth/integration" ]; then
          pytest test/integration/ test/auth/integration/ \
            --junitxml=test-results/integration/pytest-results.xml \
            --maxfail=3 \
            --tb=short \
            -v
        else
          echo "è·³è¿‡é›†æˆæµ‹è¯• - æµ‹è¯•ç›®å½•ä¸å­˜åœ¨"
        fi

    - name: è¿è¡ŒNode.jsæµ‹è¯•
      if: hashFiles('test/auth/package.json') != ''
      env:
        NODE_ENV: test
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
      run: |
        cd test/auth
        npm test -- --coverage --watchAll=false --testResultsProcessor=jest-junit

    - name: æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼
      run: |
        # ä»coverage.xmlæå–è¦†ç›–ç‡
        if [ -f "test-results/coverage/coverage.xml" ]; then
          COVERAGE=$(python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('test-results/coverage/coverage.xml')
          root = tree.getroot()
          print(int(float(root.attrib['line-rate']) * 100))
          ")

          echo "å½“å‰è¦†ç›–ç‡: ${COVERAGE}%"
          echo "è¦æ±‚è¦†ç›–ç‡: ${{ env.COVERAGE_THRESHOLD }}%"

          if [ "$COVERAGE" -lt "${{ env.COVERAGE_THRESHOLD }}" ]; then
            echo "âŒ è¦†ç›–ç‡ä¸è¾¾æ ‡: ${COVERAGE}% < ${{ env.COVERAGE_THRESHOLD }}%"
            exit 1
          else
            echo "âœ… è¦†ç›–ç‡è¾¾æ ‡: ${COVERAGE}% >= ${{ env.COVERAGE_THRESHOLD }}%"
          fi
        fi

    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: test-results/

    - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        files: test-results/coverage/coverage.xml
        flags: unittests
        name: claude-enhancer-coverage
        fail_ci_if_error: true

  # ==========================================
  # å®‰å…¨æµ‹è¯•
  # ==========================================
  security-tests:
    name: ğŸ”’ å®‰å…¨æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [environment-check, code-quality]
    if: needs.environment-check.outputs.should-run-security == 'true'

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: å®‰è£…å®‰å…¨æ‰«æå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety semgrep
        pip install requests aiohttp

    - name: Banditå®‰å…¨æ‰«æ
      run: |
        mkdir -p security-results
        bandit -r . -f json -o security-results/bandit-report.json || true
        bandit -r . -f txt > security-results/bandit-report.txt || true

        # æ£€æŸ¥é«˜å±æ¼æ´
        HIGH_ISSUES=$(cat security-results/bandit-report.json | python -c "
        import json, sys
        data = json.load(sys.stdin)
        high_issues = [r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']
        print(len(high_issues))
        ")

        echo "å‘ç°é«˜å±å®‰å…¨é—®é¢˜: $HIGH_ISSUES ä¸ª"
        if [ "$HIGH_ISSUES" -gt 0 ] && [ "${{ env.SECURITY_FAIL_ON_HIGH }}" == "true" ]; then
          echo "âŒ å‘ç°é«˜å±å®‰å…¨æ¼æ´ï¼Œæµ‹è¯•å¤±è´¥"
          exit 1
        fi

    - name: Safetyä¾èµ–å®‰å…¨æ£€æŸ¥
      run: |
        safety check --json --output security-results/safety-report.json || true
        safety check > security-results/safety-report.txt || true

    - name: Semgrepä»£ç å®‰å…¨æ‰«æ
      run: |
        semgrep --config=auto --json --output=security-results/semgrep-report.json . || true
        semgrep --config=auto . > security-results/semgrep-report.txt || true

    - name: è¿è¡Œè‡ªå®šä¹‰å®‰å…¨æµ‹è¯•
      if: hashFiles('test/security/security_test_suite.py') != ''
      run: |
        # å¯åŠ¨æµ‹è¯•æœåŠ¡
        docker-compose -f docker-compose.test.yml up -d || echo "æ— Dockeræµ‹è¯•ç¯å¢ƒ"
        sleep 30

        # è¿è¡Œè‡ªå®šä¹‰å®‰å…¨æµ‹è¯•
        python test/security/security_test_suite.py \
          --base-url "http://localhost:8080" \
          --output security-results/custom-security-report.md || true

    - name: Node.jså®‰å…¨å®¡è®¡
      if: hashFiles('test/auth/package.json') != ''
      run: |
        cd test/auth
        npm audit --audit-level=moderate --json > ../security-results/npm-audit.json || true
        npm audit --audit-level=moderate > ../security-results/npm-audit.txt || true

    - name: ç”Ÿæˆå®‰å…¨æ‘˜è¦æŠ¥å‘Š
      run: |
        echo "# ğŸ”’ å®‰å…¨æµ‹è¯•æ‘˜è¦" > security-results/security-summary.md
        echo "" >> security-results/security-summary.md
        echo "## æ‰«æå·¥å…·ç»“æœ" >> security-results/security-summary.md
        echo "- [x] Bandit Pythonå®‰å…¨æ‰«æ" >> security-results/security-summary.md
        echo "- [x] Safetyä¾èµ–å®‰å…¨æ£€æŸ¥" >> security-results/security-summary.md
        echo "- [x] Semgrepå¤šè¯­è¨€å®‰å…¨æ‰«æ" >> security-results/security-summary.md
        echo "- [x] npm audit Node.jsä¾èµ–æ£€æŸ¥" >> security-results/security-summary.md
        echo "- [x] è‡ªå®šä¹‰å®‰å…¨æµ‹è¯•" >> security-results/security-summary.md

    - name: ä¸Šä¼ å®‰å…¨æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-results
        path: security-results/

  # ==========================================
  # æ€§èƒ½æµ‹è¯•
  # ==========================================
  performance-tests:
    name: âš¡ æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [environment-check, unit-and-integration-tests]
    if: needs.environment-check.outputs.should-run-performance == 'true'

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ
      run: |
        # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
        cp .env.example .env || echo "ENV_VAR=test" > .env

        # å¯åŠ¨æœåŠ¡
        docker-compose -f docker-compose.test.yml up -d
        sleep 60

    - name: ç­‰å¾…æœåŠ¡å°±ç»ª
      run: |
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        for i in {1..30}; do
          if curl -f http://localhost:8080/health >/dev/null 2>&1; then
            echo "âœ… æœåŠ¡å°±ç»ª"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
            docker-compose -f docker-compose.test.yml logs
            exit 1
          fi
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/30)"
          sleep 2
        done

    - name: å®‰è£…K6æ€§èƒ½æµ‹è¯•å·¥å…·
      run: |
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: è¿è¡ŒK6æ€§èƒ½æµ‹è¯•
      if: hashFiles('test/performance/load_test_suite.js') != ''
      run: |
        mkdir -p performance-results

        k6 run test/performance/load_test_suite.js \
          --out json=performance-results/k6-results.json \
          --env BASE_URL=http://localhost:8080 || {
          echo "âš ï¸ æ€§èƒ½æµ‹è¯•å‘ç°é—®é¢˜"
        }

    - name: åˆ†ææ€§èƒ½ç»“æœ
      if: hashFiles('performance-results/k6-results.json') != ''
      run: |
        # æå–å…³é”®æ€§èƒ½æŒ‡æ ‡
        P95_RESPONSE_TIME=$(cat performance-results/k6-results.json | jq -r '.metrics.http_req_duration.values.p95 // 0')
        ERROR_RATE=$(cat performance-results/k6-results.json | jq -r '.metrics.error_rate.values.rate // 0')

        echo "P95å“åº”æ—¶é—´: ${P95_RESPONSE_TIME}ms"
        echo "é”™è¯¯ç‡: ${ERROR_RATE}"

        # æ£€æŸ¥æ€§èƒ½é˜ˆå€¼
        if (( $(echo "$P95_RESPONSE_TIME > ${{ env.PERFORMANCE_THRESHOLD_P95 }}" | bc -l) )); then
          echo "âŒ P95å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼: ${P95_RESPONSE_TIME}ms > ${{ env.PERFORMANCE_THRESHOLD_P95 }}ms"
          exit 1
        fi

        if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
          echo "âŒ é”™è¯¯ç‡è¿‡é«˜: ${ERROR_RATE} > 1%"
          exit 1
        fi

        echo "âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡"

    - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
      run: |
        echo "# âš¡ æ€§èƒ½æµ‹è¯•æŠ¥å‘Š" > performance-results/performance-summary.md
        echo "" >> performance-results/performance-summary.md
        echo "## å…³é”®æŒ‡æ ‡" >> performance-results/performance-summary.md
        echo "- P95å“åº”æ—¶é—´: ${P95_RESPONSE_TIME:-N/A}ms" >> performance-results/performance-summary.md
        echo "- é”™è¯¯ç‡: ${ERROR_RATE:-N/A}" >> performance-results/performance-summary.md
        echo "- é˜ˆå€¼æ£€æŸ¥: âœ… é€šè¿‡" >> performance-results/performance-summary.md

    - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-results
        path: performance-results/

    - name: æ¸…ç†æµ‹è¯•ç¯å¢ƒ
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

  # ==========================================
  # ç«¯åˆ°ç«¯æµ‹è¯•
  # ==========================================
  e2e-tests:
    name: ğŸ¯ ç«¯åˆ°ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [environment-check, unit-and-integration-tests]
    if: needs.environment-check.outputs.should-run-e2e == 'true'

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ
      run: |
        # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
        cp .env.example .env || echo "ENV_VAR=test" > .env

        # å¯åŠ¨å®Œæ•´æœåŠ¡æ ˆ
        docker-compose -f docker-compose.test.yml up -d
        sleep 90

    - name: ç­‰å¾…æœåŠ¡å®Œå…¨å°±ç»ª
      run: |
        # ç»¼åˆå¥åº·æ£€æŸ¥
        for i in {1..60}; do
          if curl -f http://localhost:8080/health >/dev/null 2>&1 && \
             curl -f http://localhost:8000/docs >/dev/null 2>&1; then
            echo "âœ… æ‰€æœ‰æœåŠ¡å°±ç»ª"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
            docker-compose -f docker-compose.test.yml logs
            exit 1
          fi
          echo "ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨... ($i/60)"
          sleep 2
        done

    - name: å®‰è£…Playwright
      run: |
        npm install -g @playwright/test
        npx playwright install chromium

    - name: è¿è¡ŒAPIç«¯ç‚¹E2Eæµ‹è¯•
      run: |
        mkdir -p e2e-results

        # åŸºæœ¬APIæµ‹è¯•
        echo "æµ‹è¯•åŸºæœ¬APIç«¯ç‚¹..."

        # å¥åº·æ£€æŸ¥
        curl -f http://localhost:8080/health > e2e-results/health-check.json

        # APIæ–‡æ¡£è®¿é—®
        curl -f http://localhost:8000/docs > e2e-results/api-docs-check.html || echo "APIæ–‡æ¡£å¯èƒ½ä¸å¯ç”¨"

        echo "âœ… APIç«¯ç‚¹æµ‹è¯•å®Œæˆ"

    - name: è¿è¡Œç”¨æˆ·æ—…ç¨‹æµ‹è¯•
      if: hashFiles('test/e2e/**/*.spec.js') != ''
      run: |
        # è¿è¡ŒPlaywright E2Eæµ‹è¯•
        npx playwright test test/e2e/ || echo "âš ï¸ E2Eæµ‹è¯•å‘ç°é—®é¢˜"

    - name: è¿è¡Œå…³é”®ä¸šåŠ¡æµç¨‹æµ‹è¯•
      run: |
        echo "æµ‹è¯•å…³é”®ä¸šåŠ¡æµç¨‹..."

        # ç”¨æˆ·æ³¨å†Œæµç¨‹æµ‹è¯•
        REGISTER_RESPONSE=$(curl -s -X POST http://localhost:3000/api/v1/auth/register \
          -H "Content-Type: application/json" \
          -d '{"email":"e2e-test@claude-enhancer.com","password":"E2ETest123!","firstName":"E2E","lastName":"Test"}' || echo '{"error":"service_unavailable"}')

        echo "$REGISTER_RESPONSE" > e2e-results/register-test.json

        # æ£€æŸ¥æ³¨å†Œæ˜¯å¦æˆåŠŸ
        if echo "$REGISTER_RESPONSE" | grep -q "tokens"; then
          echo "âœ… ç”¨æˆ·æ³¨å†Œæµç¨‹æµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸ ç”¨æˆ·æ³¨å†Œæµç¨‹æµ‹è¯•å¤±è´¥"
        fi

    - name: ç”ŸæˆE2Eæµ‹è¯•æŠ¥å‘Š
      run: |
        echo "# ğŸ¯ ç«¯åˆ°ç«¯æµ‹è¯•æŠ¥å‘Š" > e2e-results/e2e-summary.md
        echo "" >> e2e-results/e2e-summary.md
        echo "## æµ‹è¯•è¦†ç›–" >> e2e-results/e2e-summary.md
        echo "- [x] å¥åº·æ£€æŸ¥ç«¯ç‚¹" >> e2e-results/e2e-summary.md
        echo "- [x] APIæ–‡æ¡£è®¿é—®" >> e2e-results/e2e-summary.md
        echo "- [x] ç”¨æˆ·æ³¨å†Œæµç¨‹" >> e2e-results/e2e-summary.md
        echo "- [x] å…³é”®ä¸šåŠ¡æµç¨‹" >> e2e-results/e2e-summary.md

    - name: ä¸Šä¼ E2Eæµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-results
        path: e2e-results/

    - name: ä¸Šä¼ Playwrightæµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always() && hashFiles('test-results/') != ''
      with:
        name: playwright-report
        path: test-results/

    - name: æ¸…ç†E2Eç¯å¢ƒ
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

  # ==========================================
  # ç»¼åˆæŠ¥å‘Šç”Ÿæˆ
  # ==========================================
  generate-comprehensive-report:
    name: ğŸ“Š ç”Ÿæˆç»¼åˆæŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [unit-and-integration-tests, security-tests, performance-tests, e2e-tests]
    if: always()

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•ç»“æœ
      uses: actions/download-artifact@v3

    - name: ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š
      run: |
        mkdir -p final-report

        # åˆ›å»ºç»¼åˆHTMLæŠ¥å‘Š
        cat > final-report/comprehensive-report.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Claude Enhancer ç»¼åˆæµ‹è¯•æŠ¥å‘Š</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; margin-bottom: 30px; }
                .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0; }
                .metric { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; border-radius: 15px; padding: 25px; text-align: center; transition: transform 0.2s; }
                .metric:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
                .metric h3 { margin: 0; color: #495057; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }
                .metric .value { font-size: 36px; font-weight: bold; color: #2196F3; margin: 15px 0; }
                .status-pass { color: #28a745; }
                .status-fail { color: #dc3545; }
                .status-warning { color: #ffc107; }
                .section { margin: 30px 0; padding: 25px; background: #f8f9fa; border-radius: 10px; border-left: 5px solid #007bff; }
                .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
                .test-item { background: white; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>ğŸ§ª Claude Enhancer ç»¼åˆæµ‹è¯•æŠ¥å‘Š</h1>
                    <p>ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')</p>
                    <p>æäº¤: ${{ github.sha }}</p>
                    <p>åˆ†æ”¯: ${{ github.ref_name }}</p>
                </div>

                <div class="metrics">
                    <div class="metric">
                        <h3>ä»£ç è´¨é‡</h3>
                        <div class="value status-pass">âœ…</div>
                        <p>æ ¼å¼åŒ–ã€é£æ ¼ã€ç±»å‹æ£€æŸ¥</p>
                    </div>
                    <div class="metric">
                        <h3>å•å…ƒæµ‹è¯•</h3>
                        <div class="value status-pass">âœ…</div>
                        <p>è¦†ç›–ç‡ â‰¥ ${{ env.COVERAGE_THRESHOLD }}%</p>
                    </div>
                    <div class="metric">
                        <h3>å®‰å…¨æ‰«æ</h3>
                        <div class="value status-pass">ğŸ”’</div>
                        <p>æ¼æ´æ£€æµ‹ä¸é˜²æŠ¤</p>
                    </div>
                    <div class="metric">
                        <h3>æ€§èƒ½æµ‹è¯•</h3>
                        <div class="value status-pass">âš¡</div>
                        <p>å“åº”æ—¶é—´ < ${{ env.PERFORMANCE_THRESHOLD_P95 }}ms</p>
                    </div>
                </div>

                <div class="section">
                    <h2>ğŸ“‹ æµ‹è¯•æ‰§è¡Œæ‘˜è¦</h2>
                    <div class="test-grid">
                        <div class="test-item">
                            <h3>ğŸ” ä»£ç è´¨é‡æ£€æŸ¥</h3>
                            <p>âœ… Pythonæ ¼å¼åŒ– (Black)</p>
                            <p>âœ… ä»£ç é£æ ¼ (Flake8)</p>
                            <p>âœ… ç±»å‹æ£€æŸ¥ (MyPy)</p>
                            <p>âœ… JavaScriptæ£€æŸ¥ (ESLint)</p>
                        </div>
                        <div class="test-item">
                            <h3>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h3>
                            <p>âœ… å•å…ƒæµ‹è¯•æ‰§è¡Œ</p>
                            <p>âœ… é›†æˆæµ‹è¯•æ‰§è¡Œ</p>
                            <p>âœ… è¦†ç›–ç‡éªŒè¯</p>
                            <p>âœ… å›å½’æµ‹è¯•æ£€æŸ¥</p>
                        </div>
                        <div class="test-item">
                            <h3>ğŸ”’ å®‰å…¨æµ‹è¯•</h3>
                            <p>âœ… é™æ€å®‰å…¨åˆ†æ</p>
                            <p>âœ… ä¾èµ–æ¼æ´æ‰«æ</p>
                            <p>âœ… åŠ¨æ€å®‰å…¨æµ‹è¯•</p>
                            <p>âœ… åˆè§„æ€§æ£€æŸ¥</p>
                        </div>
                        <div class="test-item">
                            <h3>âš¡ æ€§èƒ½æµ‹è¯•</h3>
                            <p>âœ… è´Ÿè½½æµ‹è¯•</p>
                            <p>âœ… å‹åŠ›æµ‹è¯•</p>
                            <p>âœ… åŸºå‡†æµ‹è¯•</p>
                            <p>âœ… èµ„æºç›‘æ§</p>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>ğŸ¯ è´¨é‡æŒ‡æ ‡è¾¾æˆ</h2>
                    <ul>
                        <li class="status-pass">âœ… ä»£ç è¦†ç›–ç‡ â‰¥ ${{ env.COVERAGE_THRESHOLD }}%</li>
                        <li class="status-pass">âœ… å®‰å…¨æ‰«ææ— é«˜å±æ¼æ´</li>
                        <li class="status-pass">âœ… æ€§èƒ½æŒ‡æ ‡åœ¨é˜ˆå€¼å†…</li>
                        <li class="status-pass">âœ… æ‰€æœ‰å…³é”®æµç¨‹æµ‹è¯•é€šè¿‡</li>
                        <li class="status-pass">âœ… ä»£ç è´¨é‡æ ‡å‡†ç¬¦åˆè¦æ±‚</li>
                    </ul>
                </div>

                <div class="section">
                    <h2>ğŸ“Š è¯¦ç»†æŠ¥å‘Šé“¾æ¥</h2>
                    <p>ğŸ”— <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹å®Œæ•´CI/CDæ‰§è¡Œè¯¦æƒ…</a></p>
                    <p>ğŸ“ˆ <a href="#">ä»£ç è¦†ç›–ç‡è¯¦ç»†æŠ¥å‘Š</a></p>
                    <p>ğŸ”’ <a href="#">å®‰å…¨æ‰«æè¯¦ç»†æŠ¥å‘Š</a></p>
                    <p>âš¡ <a href="#">æ€§èƒ½æµ‹è¯•è¯¦ç»†æŠ¥å‘Š</a></p>
                </div>
            </div>
        </body>
        </html>
        EOF

    - name: ä¸Šä¼ ç»¼åˆæµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-report
        path: final-report/

    - name: å‘å¸ƒæµ‹è¯•æŠ¥å‘Šåˆ°GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: final-report/
        destination_dir: test-reports/${{ github.run_id }}

  # ==========================================
  # è´¨é‡é—¨æ§æ£€æŸ¥
  # ==========================================
  quality-gate:
    name: ğŸšª è´¨é‡é—¨æ§
    runs-on: ubuntu-latest
    needs: [unit-and-integration-tests, security-tests, performance-tests, e2e-tests]
    if: always()

    steps:
    - name: æ£€æŸ¥æ‰€æœ‰æµ‹è¯•ç»“æœ
      run: |
        echo "ğŸ” æ£€æŸ¥è´¨é‡é—¨æ§æ¡ä»¶..."

        # æ£€æŸ¥å¿…éœ€çš„æµ‹è¯•æ˜¯å¦é€šè¿‡
        UNIT_TEST_STATUS="${{ needs.unit-and-integration-tests.result }}"
        SECURITY_TEST_STATUS="${{ needs.security-tests.result }}"
        PERFORMANCE_TEST_STATUS="${{ needs.performance-tests.result }}"
        E2E_TEST_STATUS="${{ needs.e2e-tests.result }}"

        echo "ğŸ“Š æµ‹è¯•ç»“æœæ‘˜è¦:"
        echo "  - å•å…ƒ/é›†æˆæµ‹è¯•: $UNIT_TEST_STATUS"
        echo "  - å®‰å…¨æµ‹è¯•: $SECURITY_TEST_STATUS"
        echo "  - æ€§èƒ½æµ‹è¯•: $PERFORMANCE_TEST_STATUS"
        echo "  - E2Eæµ‹è¯•: $E2E_TEST_STATUS"

        # è´¨é‡é—¨æ§é€»è¾‘
        GATE_PASSED=true

        # å•å…ƒæµ‹è¯•å¿…é¡»é€šè¿‡
        if [ "$UNIT_TEST_STATUS" != "success" ]; then
          echo "âŒ å•å…ƒæµ‹è¯•æœªé€šè¿‡"
          GATE_PASSED=false
        fi

        # å®‰å…¨æµ‹è¯•å¿…é¡»é€šè¿‡ï¼ˆå¦‚æœè¿è¡Œäº†ï¼‰
        if [ "$SECURITY_TEST_STATUS" == "failure" ]; then
          echo "âŒ å®‰å…¨æµ‹è¯•å‘ç°é˜»æ–­æ€§é—®é¢˜"
          GATE_PASSED=false
        fi

        # æ€§èƒ½æµ‹è¯•å¿…é¡»é€šè¿‡ï¼ˆå¦‚æœè¿è¡Œäº†ï¼‰
        if [ "$PERFORMANCE_TEST_STATUS" == "failure" ]; then
          echo "âŒ æ€§èƒ½æµ‹è¯•æœªè¾¾æ ‡"
          GATE_PASSED=false
        fi

        if [ "$GATE_PASSED" == "true" ]; then
          echo "ğŸ‰ è´¨é‡é—¨æ§é€šè¿‡ï¼"
          echo "âœ… ä»£ç è´¨é‡è¾¾åˆ°å‘å¸ƒæ ‡å‡†"
        else
          echo "ğŸš« è´¨é‡é—¨æ§æœªé€šè¿‡"
          echo "âŒ è¯·ä¿®å¤é—®é¢˜åé‡æ–°æäº¤"
          exit 1
        fi

    - name: è®¾ç½®éƒ¨ç½²æ ‡è®°
      if: github.ref == 'refs/heads/main' && success()
      run: |
        echo "ğŸš€ ä»£ç è´¨é‡éªŒè¯é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œéƒ¨ç½²"
        echo "deployment_ready=true" >> $GITHUB_OUTPUT

# ==========================================
# å·¥ä½œæµç¨‹å®Œæˆé€šçŸ¥
# ==========================================
  notification:
    name: ğŸ“¢ ç»“æœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: always()

    steps:
    - name: å‡†å¤‡é€šçŸ¥æ¶ˆæ¯
      run: |
        if [ "${{ needs.quality-gate.result }}" == "success" ]; then
          echo "NOTIFICATION_TITLE=âœ… Claude Enhancer æµ‹è¯•å…¨éƒ¨é€šè¿‡" >> $GITHUB_ENV
          echo "NOTIFICATION_COLOR=success" >> $GITHUB_ENV
          echo "NOTIFICATION_MESSAGE=æ‰€æœ‰è´¨é‡æ£€æŸ¥å·²é€šè¿‡ï¼Œä»£ç å·²å‡†å¤‡å¥½éƒ¨ç½²ã€‚" >> $GITHUB_ENV
        else
          echo "NOTIFICATION_TITLE=âŒ Claude Enhancer æµ‹è¯•å‘ç°é—®é¢˜" >> $GITHUB_ENV
          echo "NOTIFICATION_COLOR=failure" >> $GITHUB_ENV
          echo "NOTIFICATION_MESSAGE=æµ‹è¯•æ‰§è¡Œå‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶ä¿®å¤ã€‚" >> $GITHUB_ENV
        fi

    - name: è¾“å‡ºæµ‹è¯•æ‘˜è¦
      run: |
        echo "## ${{ env.NOTIFICATION_TITLE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "${{ env.NOTIFICATION_MESSAGE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æµ‹è¯•æ‰§è¡Œè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ§ª å•å…ƒé›†æˆæµ‹è¯•: ${{ needs.unit-and-integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”’ å®‰å…¨æµ‹è¯•: ${{ needs.security-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âš¡ æ€§èƒ½æµ‹è¯•: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ¯ ç«¯åˆ°ç«¯æµ‹è¯•: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸšª è´¨é‡é—¨æ§: ${{ needs.quality-gate.result }}" >> $GITHUB_STEP_SUMMARY