# =============================================================================
# Gitå·¥ä½œæµè‡ªåŠ¨åŒ– - GitHub Actionsé›†æˆ
# ä¸æœ¬åœ°git-workflow.shè„šæœ¬ååŒå·¥ä½œ
# =============================================================================

name: Git Workflow Automation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      workflow_type:
        description: 'å·¥ä½œæµç±»å‹'
        required: true
        default: 'full'
        type: choice
        options:
        - quality-check
        - full
        - deploy

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

# å·¥ä½œæµä½œä¸š
jobs:
  # ==========================================================================
  # å˜æ›´æ£€æµ‹ - æ™ºèƒ½å†³å®šè¿è¡Œå“ªäº›æ£€æŸ¥
  # ==========================================================================
  detect-changes:
    name: ğŸ” æ£€æµ‹å˜æ›´
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.changes.outputs.python }}
      scripts: ${{ steps.changes.outputs.scripts }}
      docs: ${{ steps.changes.outputs.docs }}
      config: ${{ steps.changes.outputs.config }}
      workflows: ${{ steps.changes.outputs.workflows }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æµ‹æ–‡ä»¶å˜æ›´
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            python:
              - '**/*.py'
              - 'requirements*.txt'
              - 'setup.py'
              - 'pyproject.toml'
            scripts:
              - 'scripts/**/*.sh'
              - '**/*.sh'
            docs:
              - '**/*.md'
              - 'docs/**'
            config:
              - '**/*.yaml'
              - '**/*.yml'
              - '**/*.json'
              - '.pre-commit-config.yaml'
            workflows:
              - '.github/workflows/**'

  # ==========================================================================
  # è´¨é‡æ£€æŸ¥ä½œä¸š - å¹¶è¡Œæ‰§è¡Œå¤šç§æ£€æŸ¥
  # ==========================================================================
  quality-checks:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.python == 'true' || needs.detect-changes.outputs.scripts == 'true'
    strategy:
      fail-fast: false
      matrix:
        check-type:
          - name: python-format
            condition: python
            script: |
              pip install black isort flake8
              black --check .
              isort --check-only .
              flake8 .
          - name: python-security
            condition: python
            script: |
              pip install bandit safety
              bandit -r . -x "./venv,./test"
              safety check
          - name: shell-scripts
            condition: scripts
            script: |
              sudo apt-get update && sudo apt-get install -y shellcheck
              find . -name "*.sh" -exec shellcheck {} \;
          - name: documentation
            condition: docs
            script: |
              npm install -g markdownlint-cli
              markdownlint "**/*.md" --ignore node_modules

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        if: contains(matrix.check-type.condition, 'python')
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node.js
        if: contains(matrix.check-type.condition, 'docs')
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.npm
          key: ${{ runner.os }}-deps-${{ matrix.check-type.name }}-${{ hashFiles('**/requirements*.txt', '**/package*.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-${{ matrix.check-type.name }}-

      - name: Run ${{ matrix.check-type.name }} checks
        if: needs.detect-changes.outputs[matrix.check-type.condition] == 'true'
        run: ${{ matrix.check-type.script }}

  # ==========================================================================
  # é›†æˆæµ‹è¯• - è¿è¡Œå®Œæ•´çš„è´¨é‡æ£€æŸ¥è„šæœ¬
  # ==========================================================================
  integrated-quality-check:
    name: ğŸ§ª é›†æˆè´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-checks]
    if: always() && (needs.detect-changes.outputs.python == 'true' || needs.detect-changes.outputs.scripts == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          pip install black isort flake8 bandit safety pytest coverage

      - name: Make scripts executable
        run: |
          chmod +x scripts/quality-check.sh
          chmod +x scripts/git-workflow.sh

      - name: Run integrated quality check
        run: |
          cd ${{ github.workspace }}
          bash scripts/quality-check.sh

      - name: Upload quality report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: quality-report
          path: |
            .quality-report.json
            .quality-report-summary.json

  # ==========================================================================
  # è‡ªåŠ¨ä¿®å¤ - å¯¹å¯ä¿®å¤çš„é—®é¢˜è¿›è¡Œè‡ªåŠ¨ä¿®å¤
  # ==========================================================================
  auto-fix:
    name: ğŸ”§ è‡ªåŠ¨ä¿®å¤
    runs-on: ubuntu-latest
    needs: [detect-changes, integrated-quality-check]
    if: failure() && github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install auto-fix tools
        run: |
          pip install black isort

      - name: Auto-fix Python code
        if: needs.detect-changes.outputs.python == 'true'
        run: |
          black .
          isort .

      - name: Commit fixes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --staged --quiet || git commit -m "style: auto-fix code formatting

          ğŸ¤– è‡ªåŠ¨ä¿®å¤ä»¥ä¸‹é—®é¢˜:
          - Pythonä»£ç æ ¼å¼åŒ– (Black)
          - å¯¼å…¥æ’åº (isort)

          Generated with Claude Code
          Co-Authored-By: Claude <noreply@anthropic.com>"

      - name: Push changes
        run: |
          git push

  # ==========================================================================
  # å·¥ä½œæµéªŒè¯ - éªŒè¯å·¥ä½œæµè„šæœ¬æœ¬èº«
  # ==========================================================================
  validate-workflow:
    name: âœ… å·¥ä½œæµè„šæœ¬éªŒè¯
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.scripts == 'true' || needs.detect-changes.outputs.workflows == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck bats

      - name: Validate shell scripts
        run: |
          find scripts/ -name "*.sh" -exec shellcheck {} \;

      - name: Test workflow script dry-run
        run: |
          chmod +x scripts/git-workflow.sh
          chmod +x scripts/workflow
          # æµ‹è¯•é…ç½®ç”Ÿæˆ
          bash scripts/git-workflow.sh config || true
          # æµ‹è¯•çŠ¶æ€æ£€æŸ¥
          bash scripts/git-workflow.sh status || true

      - name: Test quality check script
        run: |
          chmod +x scripts/quality-check.sh
          bash scripts/quality-check.sh || true

  # ==========================================================================
  # éƒ¨ç½²å·¥ä½œæµ - åœ¨ä¸»åˆ†æ”¯ä¸Šè‡ªåŠ¨éƒ¨ç½²
  # ==========================================================================
  deploy-workflow:
    name: ğŸš€ éƒ¨ç½²å·¥ä½œæµå·¥å…·
    runs-on: ubuntu-latest
    needs: [quality-checks, integrated-quality-check, validate-workflow]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup deployment
        run: |
          # åˆ›å»ºå‘å¸ƒåŒ…
          mkdir -p workflow-tools
          cp scripts/git-workflow.sh workflow-tools/
          cp scripts/workflow workflow-tools/
          cp scripts/quality-check.sh workflow-tools/
          cp .github/workflows/git-workflow-automation.yml workflow-tools/

          # åˆ›å»ºå®‰è£…è„šæœ¬
          cat > workflow-tools/install.sh << 'EOF'
          #!/bin/bash
          # Gitå·¥ä½œæµè‡ªåŠ¨åŒ–å·¥å…·å®‰è£…è„šæœ¬

          INSTALL_DIR="/usr/local/bin"
          SCRIPTS_DIR="$HOME/.git-workflow"

          echo "ğŸš€ å®‰è£…Gitå·¥ä½œæµè‡ªåŠ¨åŒ–å·¥å…·..."

          # åˆ›å»ºè„šæœ¬ç›®å½•
          mkdir -p "$SCRIPTS_DIR"

          # å¤åˆ¶è„šæœ¬
          cp git-workflow.sh "$SCRIPTS_DIR/"
          cp quality-check.sh "$SCRIPTS_DIR/"

          # åˆ›å»ºå…¨å±€å‘½ä»¤
          sudo cp workflow "$INSTALL_DIR/workflow"
          sudo chmod +x "$INSTALL_DIR/workflow"

          # è®¾ç½®æƒé™
          chmod +x "$SCRIPTS_DIR"/*.sh

          echo "âœ… å®‰è£…å®Œæˆ!"
          echo "ä½¿ç”¨ 'workflow help' æŸ¥çœ‹å¸®åŠ©"
          EOF

          chmod +x workflow-tools/install.sh

      - name: Create release package
        run: |
          tar -czf git-workflow-automation.tar.gz workflow-tools/

      - name: Upload release artifact
        uses: actions/upload-artifact@v3
        with:
          name: git-workflow-automation
          path: git-workflow-automation.tar.gz

  # ==========================================================================
  # é€šçŸ¥å’ŒæŠ¥å‘Š
  # ==========================================================================
  notify-results:
    name: ğŸ“Š ç»“æœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [quality-checks, integrated-quality-check, validate-workflow]
    if: always()
    steps:
      - name: Download quality reports
        uses: actions/download-artifact@v3
        with:
          name: quality-report
        continue-on-error: true

      - name: Generate workflow summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ” Gitå·¥ä½œæµè‡ªåŠ¨åŒ–æŠ¥å‘Š

          ## ğŸ“Š æ£€æŸ¥ç»“æœ

          | æ£€æŸ¥é¡¹ | çŠ¶æ€ |
          |--------|------|
          | ä»£ç è´¨é‡æ£€æŸ¥ | ${{ needs.quality-checks.result }} |
          | é›†æˆæµ‹è¯• | ${{ needs.integrated-quality-check.result }} |
          | å·¥ä½œæµéªŒè¯ | ${{ needs.validate-workflow.result }} |

          ## ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ

          - å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
          - ä½¿ç”¨æœ¬åœ° `workflow` å‘½ä»¤è¿›è¡Œå¿«é€Ÿä¿®å¤
          - è¿è¡Œ `scripts/quality-check.sh` è¿›è¡Œæœ¬åœ°éªŒè¯

          ## ğŸ› ï¸ æœ¬åœ°å·¥å…·ä½¿ç”¨

          ```bash
          # å¼€å§‹æ–°åŠŸèƒ½
          workflow new feature-name

          # ä¿å­˜è¿›åº¦
          workflow save

          # å‘å¸ƒåŠŸèƒ½
          workflow ship

          # æŸ¥çœ‹çŠ¶æ€
          workflow status
          ```

          ---
          ğŸ¤– Generated with Claude Code
          EOF

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ” Gitå·¥ä½œæµè‡ªåŠ¨åŒ–æŠ¥å‘Š')
            );

            const body = `## ğŸ” Gitå·¥ä½œæµè‡ªåŠ¨åŒ–æŠ¥å‘Š

            ### ğŸ“Š æ£€æŸ¥ç»“æœ
            - **ä»£ç è´¨é‡æ£€æŸ¥**: ${{ needs.quality-checks.result }}
            - **é›†æˆæµ‹è¯•**: ${{ needs.integrated-quality-check.result }}
            - **å·¥ä½œæµéªŒè¯**: ${{ needs.validate-workflow.result }}

            ### ğŸ¯ å»ºè®®æ“ä½œ
            ${needs.integrated-quality-check.result === 'failure' ?
              'âš ï¸ è´¨é‡æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œè¯·è¿è¡Œæœ¬åœ°ä¿®å¤å‘½ä»¤ï¼š\n```bash\nworkflow save\n```' :
              'âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å®‰å…¨åˆå¹¶ï¼'}

            ---
            ğŸ¤– è‡ªåŠ¨ç”Ÿæˆäº ${new Date().toISOString()}`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }