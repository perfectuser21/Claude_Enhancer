# Security Audit CI/CD Pipeline
# å¼ºåˆ¶GPGéªŒç­¾å’Œå®‰å…¨æ£€æŸ¥
name: Security Audit

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  security-events: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: å®‰å…¨æ¼æ´æ‰«æ
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  vulnerability-scan:
    name: "Vulnerability Scan"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for unprotected rm -rf
        run: |
          echo "ğŸ” Scanning for dangerous rm -rf usage..."
          
          VIOLATIONS=0
          
          # æŸ¥æ‰¾æ‰€æœ‰ä½¿ç”¨rm -rfçš„åœ°æ–¹
          FILES=$(grep -r "rm -rf" \
                  --include="*.sh" \
                  --exclude-dir=".git" \
                  --exclude-dir="node_modules" \
                  --exclude="*_SECURE.sh" \
                  --exclude="security_exploit_test.sh" \
                  . || true)
          
          if [[ -n "$FILES" ]]; then
            echo "$FILES" | while read -r line; do
              file=$(echo "$line" | cut -d: -f1)
              
              # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†safe_rm_rf
              if ! grep -q "safe_rm_rf" "$file"; then
                echo "âŒ VIOLATION: Unprotected rm -rf in $file"
                echo "   $line"
                ((VIOLATIONS++))
              fi
            done
            
            if [[ $VIOLATIONS -gt 0 ]]; then
              echo ""
              echo "âŒ ERROR: Found $VIOLATIONS unprotected rm -rf usage"
              echo "Required: Use safe_rm_rf() instead"
              exit 1
            fi
          fi
          
          echo "âœ… No unprotected rm -rf found"

      - name: Scan for weak signing systems
        run: |
          echo "ğŸ” Scanning for weak signature systems..."
          
          # æ£€æŸ¥æ˜¯å¦ä»åœ¨ä½¿ç”¨SHA256è‡ªç­¾å
          if grep -r "sha256sum.*sig" \
             --include="*.sh" \
             --exclude="*_GPG.sh" \
             .workflow/scripts/ 2>/dev/null; then
            echo "âŒ ERROR: Weak SHA256 self-signing detected"
            echo "Required: Use GPG or minisign cryptographic signing"
            exit 1
          fi
          
          echo "âœ… No weak signing systems detected"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: GPGç­¾åéªŒè¯ï¼ˆå¼ºåˆ¶ï¼‰
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gpg-signature-verification:
    name: "GPG Signature Verification"
    runs-on: ubuntu-latest
    needs: vulnerability-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup GPG
        run: |
          echo "ğŸ”‘ Setting up GPG..."
          
          # å®‰è£…GPG
          sudo apt-get update -qq
          sudo apt-get install -y gnupg
          
          # å¯¼å…¥å¯ä¿¡å…¬é’¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [[ -f .gates/trusted.asc ]]; then
            gpg --import .gates/trusted.asc
            echo "âœ“ Trusted public key imported"
          else
            echo "âš ï¸  No trusted public key found (.gates/trusted.asc)"
            echo "   Gates verification will use any available key"
          fi

      - name: Verify all gate signatures
        run: |
          echo "ğŸ” Verifying gate signatures..."
          
          TOTAL=0
          VALID=0
          INVALID=0
          UNSIGNED=0
          
          for ok_file in .gates/*.ok; do
            [[ ! -f "$ok_file" ]] && continue
            
            ((TOTAL++))
            gate_num=$(basename "$ok_file" .ok)
            sig_file="${ok_file}.sig"
            
            echo ""
            echo "Checking gate $gate_num..."
            
            if [[ ! -f "$sig_file" ]]; then
              echo "  âš ï¸  No signature (legacy gate)"
              ((UNSIGNED++))
              continue
            fi
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºGPGç­¾åï¼ˆarmoredæ ¼å¼ï¼‰
            if grep -q "BEGIN PGP SIGNATURE" "$sig_file"; then
              # GPGç­¾åéªŒè¯
              if gpg --verify "$sig_file" "$ok_file" 2>&1; then
                echo "  âœ… Valid GPG signature"
                ((VALID++))
              else
                echo "  âŒ Invalid or untrusted GPG signature"
                ((INVALID++))
              fi
            else
              # æ—§çš„SHA256ç­¾åï¼ˆä¸å®‰å…¨ï¼‰
              echo "  âš ï¸  Using weak SHA256 signature"
              echo "  âŒ SECURITY POLICY: SHA256 self-signing no longer accepted"
              ((INVALID++))
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Verification Summary:"
          echo "  Total gates:    $TOTAL"
          echo "  Valid (GPG):    $VALID"
          echo "  Invalid/Weak:   $INVALID"
          echo "  Unsigned:       $UNSIGNED"
          
          # ç­–ç•¥ï¼šä»»ä½•invalidæˆ–ä½¿ç”¨å¼±ç­¾åçš„éƒ½å¤±è´¥
          if [[ $INVALID -gt 0 ]]; then
            echo ""
            echo "âŒ SECURITY POLICY VIOLATION"
            echo "All gates must use GPG cryptographic signatures"
            echo ""
            echo "To fix:"
            echo "  ./.workflow/scripts/sign_gate_GPG.sh P<N> <num> create"
            exit 1
          fi
          
          if [[ $VALID -gt 0 || $UNSIGNED -eq $TOTAL ]]; then
            echo ""
            echo "âœ… Signature verification passed"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: å®‰å…¨æµ‹è¯•å¥—ä»¶
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-exploit-tests:
    name: "Security Exploit Tests"
    runs-on: ubuntu-latest
    needs: vulnerability-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GPG for testing
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y gnupg
          
          # ç”Ÿæˆæµ‹è¯•å¯†é’¥
          cat > /tmp/gpg_gen.conf << EOF
%no-protection
Key-Type: RSA
Key-Length: 2048
Name-Real: CI Test Key
Name-Email: ci@test.local
Expire-Date: 0
%commit
EOF
          gpg --batch --gen-key /tmp/gpg_gen.conf
          
          # å¯¼å‡ºç¯å¢ƒå˜é‡
          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep -A1 '^sec' | tail -1 | awk '{print $1}')
          echo "CE_GPG_KEY=$KEY_ID" >> $GITHUB_ENV

      - name: Run exploit tests
        run: |
          echo "ğŸ” Running security exploit tests..."
          chmod +x test/security_exploit_test.sh
          ./test/security_exploit_test.sh

      - name: Test report
        if: always()
        run: |
          echo "Security test completed"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 4: ä»£ç å®‰å…¨æ‰«æ
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  code-security-scan:
    name: "Code Security Scan"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ShellCheck security scan
        run: |
          echo "ğŸ” Running ShellCheck security analysis..."
          
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck
          
          find . -name "*.sh" \
            -not -path "./node_modules/*" \
            -not -path "./.git/*" \
            -exec shellcheck -S error {} \;

      - name: Secret detection
        run: |
          echo "ğŸ” Scanning for hardcoded secrets..."
          
          VIOLATIONS=0
          
          # æ£€æŸ¥ç§é’¥
          if grep -r "BEGIN.*PRIVATE KEY" \
              --exclude-dir=.git \
              --exclude-dir=node_modules \
              --exclude="*.md" \
              . ; then
            echo "âŒ Found private keys!"
            ((VIOLATIONS++))
          fi
          
          # æ£€æŸ¥AWSå¯†é’¥
          if grep -rE "AKIA[0-9A-Z]{16}" \
              --exclude-dir=.git \
              --exclude="*.md" \
              . ; then
            echo "âŒ Found AWS keys!"
            ((VIOLATIONS++))
          fi
          
          if [[ $VIOLATIONS -gt 0 ]]; then
            echo "âŒ Security violations detected"
            exit 1
          fi
          
          echo "âœ… No secrets found"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # æœ€ç»ˆæ±‡æ€»
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-summary:
    name: "Security Audit Summary"
    runs-on: ubuntu-latest
    needs:
      - vulnerability-scan
      - gpg-signature-verification
      - security-exploit-tests
      - code-security-scan
    steps:
      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Security Audit Passed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Vulnerability scan"
          echo "âœ“ GPG signature verification"
          echo "âœ“ Security exploit tests"
          echo "âœ“ Code security scan"
          echo ""
          echo "ğŸ”’ System is secure"
