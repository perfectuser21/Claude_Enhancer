name: ğŸ“š Critical Documentation Sentinel

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:

jobs:
  check-critical-docs:
    name: ğŸ” Verify Critical Documentation Exists
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Critical Documentation Files
        id: check_docs
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ“š Critical Documentation Sentinel"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # å®šä¹‰å…³é”®æ–‡æ¡£åˆ—è¡¨ï¼ˆè¿™äº›æ–‡æ¡£ç»å¯¹ä¸èƒ½è¢«åˆ é™¤ï¼‰
          CRITICAL_DOCS=(
            "docs/PARALLEL_SUBAGENT_STRATEGY.md|å¹¶è¡ŒSubAgentç­–ç•¥æ–‡æ¡£|2753"
            "CLAUDE.md|Claudeä¸»æ–‡æ¡£|2000"
            "README.md|é¡¹ç›®README|100"
            ".workflow/SPEC.yaml|æ ¸å¿ƒè§„æ ¼æ–‡æ¡£|339"
            ".workflow/manifest.yml|å·¥ä½œæµæ¸…å•|50"
            ".workflow/gates.yml|è´¨é‡é—¨ç¦é…ç½®|50"
            "docs/CHECKS_INDEX.json|æ£€æŸ¥ç‚¹ç´¢å¼•|50"
            "ARCHITECTURE.md|æ¶æ„æ–‡æ¡£|100"
            "CHANGELOG.md|å˜æ›´æ—¥å¿—|100"
          )

          EXIT_CODE=0
          MISSING_DOCS=()
          SIZE_WARNINGS=()

          echo "ğŸ” Checking ${#CRITICAL_DOCS[@]} critical documents..."
          echo ""

          for doc_info in "${CRITICAL_DOCS[@]}"; do
            IFS='|' read -r doc_path doc_name min_lines <<< "$doc_info"

            if [[ ! -f "$doc_path" ]]; then
              echo "âŒ CRITICAL: Missing document: $doc_name"
              echo "   Path: $doc_path"
              MISSING_DOCS+=("$doc_name ($doc_path)")
              EXIT_CODE=1
            else
              # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆè¡Œæ•°ï¼‰
              actual_lines=$(wc -l < "$doc_path" 2>/dev/null || echo "0")

              if [[ $actual_lines -lt $min_lines ]]; then
                echo "âš ï¸  WARNING: Document too small: $doc_name"
                echo "   Path: $doc_path"
                echo "   Expected: â‰¥${min_lines} lines, Actual: ${actual_lines} lines"
                SIZE_WARNINGS+=("$doc_name: ${actual_lines}/${min_lines} lines")
              else
                echo "âœ… $doc_name ($actual_lines lines)"
              fi
            fi
          done

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [[ ${#MISSING_DOCS[@]} -gt 0 ]]; then
            echo "âŒ FAILURE: ${#MISSING_DOCS[@]} critical document(s) missing!"
            echo ""
            echo "Missing documents:"
            for missing in "${MISSING_DOCS[@]}"; do
              echo "  - $missing"
            done
            echo ""
            echo "ğŸš¨ This is a CRITICAL failure!"
            echo "   These documents are protected by immutable_kernel."
            echo "   Deleting them requires RFC process."
            echo ""
            echo "Actions required:"
            echo "  1. Restore the missing document(s)"
            echo "  2. If intentional deletion, follow RFC process:"
            echo "     - Create rfc/* branch"
            echo "     - Write RFC document explaining Why/What/Impact"
            echo "     - Get user approval"
            echo "     - Update .workflow/SPEC.yaml immutable_kernel section"
          elif [[ ${#SIZE_WARNINGS[@]} -gt 0 ]]; then
            echo "âš ï¸  WARNING: ${#SIZE_WARNINGS[@]} document(s) suspiciously small"
            echo ""
            echo "Small documents:"
            for warning in "${SIZE_WARNINGS[@]}"; do
              echo "  - $warning"
            done
            echo ""
            echo "ğŸ’¡ Please verify these documents haven't been simplified/gutted"
            # ä¸å¤±è´¥ï¼Œåªæ˜¯è­¦å‘Š
          else
            echo "âœ… SUCCESS: All ${#CRITICAL_DOCS[@]} critical documents present"
            echo ""
            echo "âœ“ docs/PARALLEL_SUBAGENT_STRATEGY.md (Phase 2-7 strategies)"
            echo "âœ“ CLAUDE.md (Main documentation)"
            echo "âœ“ .workflow/SPEC.yaml (Core specifications)"
            echo "âœ“ All other critical documents"
          fi

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          exit $EXIT_CODE

      - name: Check for Deleted Files in Commit
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        run: |
          echo ""
          echo "ğŸ” Checking for deleted critical files in this commit..."
          echo ""

          # è·å–è¦æ¯”è¾ƒçš„base commit
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="HEAD^"
          fi

          # æ£€æŸ¥deleted files
          DELETED_FILES=$(git diff --name-status $BASE_SHA HEAD | grep '^D' | cut -f2 || true)

          if [[ -z "$DELETED_FILES" ]]; then
            echo "âœ… No files deleted in this commit"
            exit 0
          fi

          echo "ğŸ“‹ Deleted files detected:"
          echo "$DELETED_FILES"
          echo ""

          # æ£€æŸ¥æ˜¯å¦åˆ é™¤äº†å…³é”®æ–‡æ¡£
          CRITICAL_PATTERNS=(
            "docs/PARALLEL_SUBAGENT_STRATEGY.md"
            "CLAUDE.md"
            ".workflow/SPEC.yaml"
            ".workflow/manifest.yml"
            ".workflow/gates.yml"
            "docs/CHECKS_INDEX.json"
            "ARCHITECTURE.md"
          )

          CRITICAL_DELETED=()

          for pattern in "${CRITICAL_PATTERNS[@]}"; do
            if echo "$DELETED_FILES" | grep -q "^$pattern$"; then
              CRITICAL_DELETED+=("$pattern")
            fi
          done

          if [[ ${#CRITICAL_DELETED[@]} -gt 0 ]]; then
            echo "âŒ CRITICAL: Attempted to delete protected document(s)!"
            echo ""
            echo "Deleted protected files:"
            for file in "${CRITICAL_DELETED[@]}"; do
              echo "  - $file"
            done
            echo ""
            echo "ğŸš¨ This violates immutable_kernel protection!"
            echo ""
            echo "To delete these files, you MUST:"
            echo "  1. Create an RFC branch (rfc/*)"
            echo "  2. Write RFC document explaining:"
            echo "     - Why: Reason for deletion"
            echo "     - What: Impact assessment"
            echo "     - Rollback: Recovery plan"
            echo "  3. Get explicit user approval"
            echo "  4. Update .workflow/SPEC.yaml to remove from kernel_files"
            echo ""
            exit 1
          else
            echo "âœ… No critical documents deleted"
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "### ğŸ“š Critical Documentation Sentinel" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.check_docs.outcome }}" == "success" ]]; then
            echo "âœ… **All critical documents present and protected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Protected documents:" >> $GITHUB_STEP_SUMMARY
            echo "- docs/PARALLEL_SUBAGENT_STRATEGY.md (Phase 2-7 å¹¶è¡Œç­–ç•¥)" >> $GITHUB_STEP_SUMMARY
            echo "- CLAUDE.md (ä¸»æ–‡æ¡£)" >> $GITHUB_STEP_SUMMARY
            echo "- .workflow/SPEC.yaml (æ ¸å¿ƒè§„æ ¼)" >> $GITHUB_STEP_SUMMARY
            echo "- All immutable_kernel files" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Critical documentation check FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See job logs for details." >> $GITHUB_STEP_SUMMARY
          fi

  verify-parallel-strategy-content:
    name: ğŸš€ Verify Parallel Strategy Content Quality
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: check-critical-docs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify PARALLEL_SUBAGENT_STRATEGY.md Content
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸš€ Parallel Strategy Content Quality Check"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          DOC_PATH="docs/PARALLEL_SUBAGENT_STRATEGY.md"

          if [[ ! -f "$DOC_PATH" ]]; then
            echo "âŒ ERROR: Document not found (should have been caught earlier)"
            exit 1
          fi

          # å®šä¹‰å¿…é¡»åŒ…å«çš„å…³é”®sectionï¼ˆé˜²æ­¢æ–‡æ¡£è¢«ç®€åŒ–ï¼‰
          REQUIRED_SECTIONS=(
            "ç†è®ºåŸºç¡€ï¼šå¹¶è¡Œæ‰§è¡ŒåŸç†"
            "å½“å‰ç³»ç»Ÿæ¶æ„ (v2.0.0)"
            "Phase 2-7 å¹¶è¡Œç­–ç•¥è¯¦è§£"
            "å®æˆ˜ä½¿ç”¨æŒ‡å—"
            "æ€§èƒ½ä¸ä¼˜åŒ–"
            "Claude Codeçš„æ‰¹é‡è°ƒç”¨"
            "Impact Assessment"
            "STAGES.yml"
          )

          MISSING_SECTIONS=()

          echo "ğŸ” Checking for ${#REQUIRED_SECTIONS[@]} essential sections..."
          echo ""

          for section in "${REQUIRED_SECTIONS[@]}"; do
            if grep -q "$section" "$DOC_PATH"; then
              echo "âœ… Found: $section"
            else
              echo "âŒ Missing: $section"
              MISSING_SECTIONS+=("$section")
            fi
          done

          echo ""

          # æ£€æŸ¥æ–‡æ¡£å¤§å°ï¼ˆé˜²æ­¢è¢«ç®€åŒ–ï¼‰
          LINE_COUNT=$(wc -l < "$DOC_PATH")
          MIN_LINES=2000

          if [[ $LINE_COUNT -lt $MIN_LINES ]]; then
            echo "âŒ Document too small: ${LINE_COUNT} lines (expected â‰¥${MIN_LINES})"
            echo ""
            echo "ğŸš¨ This suggests the document has been simplified/gutted!"
            exit 1
          else
            echo "âœ… Document size OK: ${LINE_COUNT} lines (â‰¥${MIN_LINES})"
          fi

          echo ""

          if [[ ${#MISSING_SECTIONS[@]} -gt 0 ]]; then
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ FAILURE: ${#MISSING_SECTIONS[@]} essential section(s) missing!"
            echo ""
            echo "Missing sections:"
            for section in "${MISSING_SECTIONS[@]}"; do
              echo "  - $section"
            done
            echo ""
            echo "ğŸš¨ This is a CRITICAL failure!"
            echo "   The parallel strategy document has been gutted."
            echo ""
            echo "Actions required:"
            echo "  1. Restore missing sections from git history"
            echo "  2. Ensure document contains:"
            echo "     - Theoretical knowledge (5 parallel strategies)"
            echo "     - Current v2.0.0 implementation details"
            echo "     - Phase 2-7 detailed strategies"
            echo "     - Practical usage examples"
            echo "  3. Verify document is â‰¥2000 lines"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          else
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… SUCCESS: All essential sections present"
            echo "âœ… Document quality verified"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi
