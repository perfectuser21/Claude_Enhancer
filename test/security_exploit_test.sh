#!/bin/bash
# Security Exploit Test Suite
# è¯æ˜å®‰å…¨æœºåˆ¶æ— æ³•è¢«ç»•è¿‡

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "ğŸ” Security Exploit Test Suite"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

TESTS_PASSED=0
TESTS_FAILED=0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Test 1: å°è¯•ç»•è¿‡safe_rm_rfè·¯å¾„ç™½åå•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${BLUE}[TEST 1] Path Whitelist Bypass Attempt${NC}"

test_rm_bypass() {
    local test_script="/tmp/test_safe_rm.sh"
    
    # æå–safe_rm_rfå‡½æ•°
    cat > "$test_script" << 'INNER_EOF'
#!/bin/bash
source .claude/hooks/performance_optimized_hooks_SECURE.sh

# å°è¯•1: åˆ é™¤æ ¹ç›®å½•ï¼ˆåº”å¤±è´¥ï¼‰
echo "Attempt 1: Deleting /"
if safe_rm_rf "/" 2>&1 | grep -q "SECURITY"; then
    echo "  âœ“ Blocked as expected"
    exit 0
else
    echo "  âœ— SECURITY BREACH: Root deletion not blocked!"
    exit 1
fi
INNER_EOF
    
    chmod +x "$test_script"
    
    if bash "$test_script"; then
        echo -e "${GREEN}âœ… Test 1.1: Root path blocked${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}âŒ Test 1.1: FAILED${NC}"
        ((TESTS_FAILED++))
    fi
    rm -f "$test_script"
    
    # å°è¯•2: åˆ é™¤homeç›®å½•ï¼ˆåº”å¤±è´¥ï¼‰
    cat > "$test_script" << 'INNER_EOF2'
#!/bin/bash
source .claude/hooks/performance_optimized_hooks_SECURE.sh

echo "Attempt 2: Deleting $HOME"
if safe_rm_rf "$HOME" 2>&1 | grep -q "SECURITY"; then
    echo "  âœ“ Blocked as expected"
    exit 0
else
    echo "  âœ— SECURITY BREACH!"
    exit 1
fi
INNER_EOF2
    
    chmod +x "$test_script"
    
    if bash "$test_script"; then
        echo -e "${GREEN}âœ… Test 1.2: Home directory blocked${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}âŒ Test 1.2: FAILED${NC}"
        ((TESTS_FAILED++))
    fi
    rm -f "$test_script"
    
    # å°è¯•3: è·¯å¾„æ³¨å…¥æ”»å‡»ï¼ˆåº”å¤±è´¥ï¼‰
    cat > "$test_script" << 'INNER_EOF3'
#!/bin/bash
source .claude/hooks/performance_optimized_hooks_SECURE.sh

echo "Attempt 3: Path injection with /../"
if safe_rm_rf "/tmp/../home" 2>&1 | grep -q "SECURITY"; then
    echo "  âœ“ Blocked as expected"
    exit 0
else
    echo "  âœ— SECURITY BREACH!"
    exit 1
fi
INNER_EOF3
    
    chmod +x "$test_script"
    
    if bash "$test_script"; then
        echo -e "${GREEN}âœ… Test 1.3: Path injection blocked${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}âŒ Test 1.3: FAILED${NC}"
        ((TESTS_FAILED++))
    fi
    rm -f "$test_script"
}

test_rm_bypass

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Test 2: å°è¯•ä¼ªé€ GPGç­¾å
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${BLUE}[TEST 2] GPG Signature Forgery Attempt${NC}"

test_gpg_forgery() {
    # åˆ›å»ºå‡çš„gateæ–‡ä»¶
    mkdir -p .gates
    echo "phase=P99" > .gates/99.ok
    echo "gate=99" >> .gates/99.ok
    echo "FORGED" >> .gates/99.ok
    
    # å°è¯•1: æ— ç­¾åæ–‡ä»¶
    echo "Attempt 1: Gate without signature"
    if ./.workflow/scripts/sign_gate_GPG.sh P99 99 verify 2>&1 | grep -q "ERROR"; then
        echo -e "${GREEN}  âœ“ Unsigned gate rejected${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}  âœ— FAILED: Unsigned gate accepted!${NC}"
        ((TESTS_FAILED++))
    fi
    
    # å°è¯•2: ä¼ªé€ çš„SHA256ç­¾åï¼ˆæ—§ç³»ç»Ÿï¼‰
    cat > .gates/99.ok.sig << 'FAKE_SIG'
phase=P99
gate=99
sha256=abcdef1234567890
FAKE_SIG
    
    echo "Attempt 2: Fake SHA256 signature"
    if ./.workflow/scripts/sign_gate_GPG.sh P99 99 verify 2>&1 | grep -q "ERROR\|INVALID"; then
        echo -e "${GREEN}  âœ“ Fake SHA256 signature rejected${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}  âœ— FAILED: Fake signature accepted!${NC}"
        ((TESTS_FAILED++))
    fi
    
    # å°è¯•3: ç¯¡æ”¹å·²ç­¾åçš„gate
    # é¦–å…ˆåˆ›å»ºåˆæ³•ç­¾å
    ./.workflow/scripts/sign_gate_GPG.sh P7 07 create &>/dev/null || true
    
    if [[ -f .gates/07.ok.sig ]]; then
        # ç¯¡æ”¹gateå†…å®¹
        echo "TAMPERED" >> .gates/07.ok
        
        echo "Attempt 3: Tampering with signed gate"
        if ./.workflow/scripts/sign_gate_GPG.sh P7 07 verify 2>&1 | grep -q "INVALID\|BAD"; then
            echo -e "${GREEN}  âœ“ Tampered gate detected${NC}"
            ((TESTS_PASSED++))
        else
            echo -e "${RED}  âœ— FAILED: Tampering not detected!${NC}"
            ((TESTS_FAILED++))
        fi
    else
        echo -e "${YELLOW}  âš ï¸  Skipped (GPG key setup needed)${NC}"
    fi
    
    # æ¸…ç†
    rm -f .gates/99.ok .gates/99.ok.sig
}

test_gpg_forgery

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Test 3: ç¬¦å·é“¾æ¥æ”»å‡»
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${BLUE}[TEST 3] Symlink Attack Prevention${NC}"

test_symlink_attack() {
    local test_script="/tmp/test_symlink.sh"
    
    # åˆ›å»ºç¬¦å·é“¾æ¥æŒ‡å‘é‡è¦ç›®å½•
    local symlink_path="/tmp/test_symlink_attack"
    ln -sf /etc "$symlink_path" 2>/dev/null || true
    
    cat > "$test_script" << 'INNER_SYMLINK'
#!/bin/bash
source .claude/hooks/performance_optimized_hooks_SECURE.sh

echo "Attempt: Delete via symlink to /etc"
if safe_rm_rf "/tmp/test_symlink_attack" 2>&1 | grep -q "SECURITY.*symbolic link"; then
    echo "  âœ“ Symlink attack blocked"
    exit 0
else
    echo "  âœ— SECURITY BREACH!"
    exit 1
fi
INNER_SYMLINK
    
    chmod +x "$test_script"
    
    if bash "$test_script"; then
        echo -e "${GREEN}âœ… Symlink attack prevented${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}âŒ FAILED: Symlink attack succeeded!${NC}"
        ((TESTS_FAILED++))
    fi
    
    rm -f "$test_script"
    rm -f "$symlink_path"
}

test_symlink_attack

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Test 4: Dry-runéªŒè¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${BLUE}[TEST 4] Dry-run Mode${NC}"

test_dry_run() {
    local test_script="/tmp/test_dryrun.sh"
    local test_dir="/tmp/test_dryrun_dir_$$"
    mkdir -p "$test_dir"
    touch "$test_dir/file1.txt"
    
    cat > "$test_script" << INNER_DRYRUN
#!/bin/bash
source .claude/hooks/performance_optimized_hooks_SECURE.sh

export DRY_RUN=1

if safe_rm_rf "$test_dir" 2>&1 | grep -q "DRY-RUN"; then
    # æ£€æŸ¥ç›®å½•ä»ç„¶å­˜åœ¨
    if [[ -d "$test_dir" ]]; then
        echo "  âœ“ Dry-run: Directory not deleted"
        exit 0
    else
        echo "  âœ— Directory was deleted in dry-run mode!"
        exit 1
    fi
else
    echo "  âœ— Dry-run flag not respected"
    exit 1
fi
INNER_DRYRUN
    
    chmod +x "$test_script"
    
    if bash "$test_script"; then
        echo -e "${GREEN}âœ… Dry-run mode working${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}âŒ FAILED: Dry-run not working${NC}"
        ((TESTS_FAILED++))
    fi
    
    rm -rf "$test_dir" "$test_script"
}

test_dry_run

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "${BLUE}Test Results:${NC}"
echo -e "${GREEN}Passed: $TESTS_PASSED${NC}"
echo -e "${RED}Failed: $TESTS_FAILED${NC}"
echo ""

if [[ $TESTS_FAILED -eq 0 ]]; then
    echo -e "${GREEN}âœ… All security tests passed!${NC}"
    echo "Security mechanisms are working correctly."
    exit 0
else
    echo -e "${RED}âŒ Security tests failed!${NC}"
    echo "CRITICAL: Security vulnerabilities detected!"
    exit 1
fi
