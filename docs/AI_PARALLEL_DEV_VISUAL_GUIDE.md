# AI 并行开发可视化指南

## 文档信息
- **配套文档**: AI_PARALLEL_DEV_WORKFLOW.md
- **目的**: 提供直观的流程图和决策树
- **版本**: 1.0.0
- **日期**: 2025-10-09

---

## 🎨 核心流程可视化

### 1. 三终端并行开发时间轴

```
时间轴：多功能并行开发场景（3个终端）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        开发者工作台（3 终端）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  Terminal 1           Terminal 2           Terminal 3
  (登录功能)           (支付功能)           (通知功能)
  ═════════════════    ═════════════════    ═════════════════

T0 (08:00)
  $ ce start login
  ✓ wip/login created
  [P0 探索]

T1 (08:10)
  [P1 规划]
  编写 PLAN.md          $ ce start payment
                        ✓ wip/payment created
                        [P0 探索]

T2 (08:30)
  [P2 骨架]             [P1 规划]             $ ce start notify
  创建 src/auth/        编写 PLAN.md          ✓ wip/notify created
                                              [P0 探索]

T3 (09:00)
  [P3 实现] ──────────────────────────────────────────────────
  📝 src/auth/login.ts  [P2 骨架]             [P1 规划]
  📝 api/login.ts       创建 src/payment/     编写 PLAN.md
  📝 tests/auth/

  ⚠️  冲突检测: PASS（不同文件路径）

T4 (09:30)
  [P4 测试]             [P3 实现]             [P2 骨架]
  运行测试套件          📝 src/payment/      创建 src/notify/
                        📝 api/payment.ts

T5 (10:00)
  [P5 审查]             [P4 测试]             [P3 实现]
  生成 REVIEW.md        运行测试              📝 src/notify/

T6 (10:30)
  [P6 发布准备]         [P5 审查]             [P4 测试]
  更新文档              生成 REVIEW.md        运行测试

T7 (10:45)
  $ ce publish          [P6 发布准备]         [P5 审查]
  ✓ PR #101 created     更新文档

T8 (11:00)
  [等待 CI/CR]          $ ce publish          [P6 发布准备]
                        ✓ PR #102 created

T9 (11:15)
  ✅ CI 通过            [等待 CI/CR]          $ ce publish
  等待审查                                    ✓ PR #103 created

T10 (14:00)
  ✅ 审查通过           ✅ CI 通过            [等待 CI/CR]
  $ ce merge wip/login  等待审查
  ✓ 合并到 main

T11 (14:30)
                        ✅ 审查通过           ✅ CI 通过
                        $ ce merge wip/payment 等待审查
                        ✓ 合并到 main

T12 (15:00)
                                              ✅ 审查通过
                                              $ ce merge wip/notify
                                              ✓ 合并到 main

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总结:
  • 总耗时: 7 小时（vs 串行 16+ 小时）
  • 效率提升: 57%
  • 冲突次数: 0
  • 并行峰值: 3 个功能同时开发
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### 2. Git 分支演进图

```
主分支演进（时间从左到右）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

main    A───────────B─────────────C─────────────D─────────────E─────>
        │           │             │             │             │
        │           │             │             │             │
        │           │ (PR #101)   │ (PR #102)   │ (PR #103)   │
        │           │ Merge       │ Merge       │ Merge       │
        │           │             │             │             │
        │           │             │             │             │
wip/    │           │             │             │             │
login   ├─1─2─3─4─5┘             │             │             │
        │ │ │ │ │ │               │             │             │
        │ │ │ │ │ └─ P6: 发布准备  │             │             │
        │ │ │ │ └─── P4: 测试      │             │             │
        │ │ │ └───── P3: 实现      │             │             │
        │ │ └─────── P2: 骨架      │             │             │
        │ └───────── P1: 规划      │             │             │
        └─────────── P0: 探索      │             │             │
                                   │             │             │
wip/                               │             │             │
payment ───────────6─7─8─9─10─────┘             │             │
                   │ │ │ │ │                     │             │
                   │ │ │ │ └─ P6: 发布准备       │             │
                   │ │ │ └─── P4: 测试           │             │
                   │ │ └───── P3: 实现           │             │
                   │ └─────── P2: 骨架           │             │
                   └───────── P1: 规划           │             │
                              P0: 探索           │             │
                                                 │             │
wip/                                             │             │
notify  ─────────────────11─12─13─14─15────────┘             │
                         │  │  │  │  │                        │
                         │  │  │  │  └─ P6: 发布准备          │
                         │  │  │  └─── P4: 测试               │
                         │  │  └───── P3: 实现                │
                         │  └─────── P2: 骨架                 │
                         └───────── P1: 规划                  │
                                    P0: 探索                  │
                                                              │
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

图例:
  A, B, C, D, E = main 分支上的 merge commit
  1, 2, 3, ... = 功能分支上的开发 commit
  ├─ = 分支点（branch off）
  ┘  = 合并点（merge）

关键点:
  • 所有 wip/ 分支从 main 分支创建
  • 开发过程完全独立（不同 commit）
  • 通过 PR 顺序合并回 main
  • 合并后 wip/ 分支被删除
```

---

### 3. 状态机图（Phase 转换）

```
Phase 状态机（P0-P7 生命周期）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

     ┌─────────────┐
     │   ce start  │ ←── 用户触发
     └──────┬──────┘
            │
            ▼
      ┌─────────┐
      │   P0    │  探索 (Discovery)
      │ 探索    │  ├─ 技术可行性验证
      └────┬────┘  └─ 依赖项检查
           │ ✓
           ▼
      ┌─────────┐
      │   P1    │  规划 (Plan)
      │ 规划    │  ├─ 创建 PLAN.md
      └────┬────┘  ├─ 任务清单 ≥5
           │ ✓     └─ 受影响文件列表
           ▼
      ┌─────────┐
      │   P2    │  骨架 (Skeleton)
      │ 骨架    │  ├─ 创建目录结构
      └────┬────┘  ├─ 定义接口
           │ ✓     └─ 生成占位代码
           ▼
      ┌─────────┐
      │   P3    │  实现 (Implementation)
      │ 实现    │  ├─ 编写核心逻辑         ┌──────────┐
      └────┬────┘  ├─ 更新 CHANGELOG      │   并行   │
           │ ✓     └─ 功能完整           │   工作   │ ← 多终端
           ▼                              │   区域   │   并行执行
      ┌─────────┐                         └──────────┘
      │   P4    │  测试 (Testing)
      │ 测试    │  ├─ 单元测试 ✓
      └────┬────┘  ├─ 边界测试 ✓
           │ ✓     └─ 集成测试 ✓
           ▼
      ┌─────────┐
      │   P5    │  审查 (Review)
      │ 审查    │  ├─ 代码自审
      └────┬────┘  ├─ REVIEW.md
           │ ✓     └─ 风险标记
           ▼
      ┌─────────┐
      │   P6    │  发布准备 (Release)
      │ 发布    │  ├─ 更新文档
      └────┬────┘  ├─ 健康检查
           │ ✓     └─ 打 tag（可选）
           ▼
     ┌──────────────┐
     │  ce publish  │ ←── 用户触发
     └───────┬──────┘
             │
             ▼
        ┌─────────┐
        │ 推送PR  │  ├─ 推送到远程
        │ 等待CI  │  ├─ 创建 PR
        └────┬────┘  └─ 触发 CI/CD
             │ ✓
             ▼
        ┌─────────┐
        │ 人工审查│  ├─ Code Review
        │ 等待批准│  └─ 至少 1 个 approval
        └────┬────┘
             │ ✓
             ▼
     ┌──────────────┐
     │  ce merge    │ ←── 用户触发（或自动）
     └───────┬──────┘
             │
             ▼
        ┌─────────┐
        │   P7    │  监控 (Monitor)
        │ 监控    │  ├─ 健康检查
        └────┬────┘  ├─ SLO 验证
             │ ✓     └─ 告警监控
             ▼
        ┌─────────┐
        │  完成    │  ├─ 合并到 main
        │  清理    │  └─ 删除 wip/ 分支
        └─────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

状态转换规则:
  ✓ = 通过质量门禁（Gates）
  ❌ = 失败，返回当前 Phase 修复
  ⚠️  = 警告，可选择继续或返回

可回退点:
  • P4 测试失败 → 返回 P3 修复
  • P5 审查不通过 → 返回 P3 重构
  • CI 失败 → 返回任意 Phase 修复
```

---

### 4. 决策树（ce start）

```
ce start <feature-name> 决策流程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

                    [用户输入: ce start login]
                               │
                               ▼
                    ┌──────────────────────┐
                    │  验证功能名称         │
                    │  是否为空?           │
                    └──────┬───────┬───────┘
                           │       │
                     [是]  │       │ [否]
                           ▼       │
                   ┌───────────┐   │
                   │ ❌ 报错   │   │
                   │ 显示用法  │   │
                   └───────────┘   │
                                   ▼
                    ┌──────────────────────┐
                    │  检查 Git 工作区      │
                    │  是否有未提交修改?    │
                    └──────┬───────┬───────┘
                           │       │
                     [是]  │       │ [否]
                           ▼       │
                   ┌───────────────┐ │
                   │ 提示:         │ │
                   │ git stash 或  │ │
                   │ git commit    │ │
                   └───────────────┘ │
                                     ▼
                    ┌──────────────────────┐
                    │  检查当前分支         │
                    │  是否在 main 上?      │
                    └──────┬───────┬───────┘
                           │       │
                     [否]  │       │ [是]
                           │       │
         ┌─────────────────┘       └──────────────────┐
         ▼                                            ▼
┌──────────────────┐                    ┌──────────────────────┐
│  当前在 wip/ 分支 │                    │  当前在 main 分支     │
│  询问: 是否切换?  │                    │  ✅ 可以创建新分支    │
└────┬─────┬───────┘                    └──────────┬───────────┘
     │     │                                       │
[否] │     │ [是]                                  ▼
     ▼     │                         ┌──────────────────────┐
  ┌──────┐ │                         │  检查分支是否已存在   │
  │ 取消 │ │                         │  git show-ref         │
  └──────┘ │                         └──────┬───────┬───────┘
           │                                │       │
           │                          [已存在]      │ [不存在]
           │                                │       │
           │                                ▼       ▼
           │                     ┌──────────────┐  ┌──────────────┐
           │                     │ 询问:        │  │ 创建新分支:  │
           │                     │ 是否切换?    │  │ wip/login    │
           │                     └───┬──────┬──┘  └──────┬───────┘
           │                         │      │            │
           │                   [是]  │      │ [否]       │
           │                         ▼      ▼            ▼
           └─────────────────────> checkout 取消    初始化工作流
                                     │               │
                                     │               ├─ .phase/current = P0
                                     │               ├─ .workflow/ACTIVE
                                     │               └─ 初始 commit
                                     │               │
                                     └───────┬───────┘
                                             ▼
                                    ┌─────────────────┐
                                    │  ✅ 成功         │
                                    │  显示下一步建议  │
                                    └─────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

输出示例:
  ✅ 成功创建并切换到分支: wip/login

  📍 下一步建议:
    1. 运行 'ce plan' 开始 P0 探索阶段
    2. 或直接开始编码 (自动进入 P1 规划)

  💡 其他终端可以并行开发其他功能:
    Terminal 2: ce start payment
    Terminal 3: ce start notification
```

---

### 5. 冲突检测与降级流程

```
冲突检测引擎工作流程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

               [多个 Agent 并行执行]
                       │
                       ▼
        ┌──────────────────────────────┐
        │  收集所有 Agent 的文件操作    │
        │  ├─ Terminal 1: src/auth/*   │
        │  ├─ Terminal 2: src/payment/*│
        │  └─ Terminal 3: src/notify/* │
        └──────────────┬───────────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │  冲突检测规则匹配             │
        │  （基于 STAGES.yml）         │
        └──────┬───────────────┬───────┘
               │               │
       [无冲突] │               │ [有冲突]
               ▼               ▼
      ┌─────────────┐   ┌──────────────────┐
      │ ✅ 继续并行 │   │ 冲突类型分析      │
      │ 执行        │   └────┬─────────┬───┘
      └─────────────┘        │         │
                             │         │
               ┌─────────────┘         └──────────────┐
               ▼                                      ▼
    ┌──────────────────────┐            ┌──────────────────────┐
    │ 相同文件写入冲突      │            │ 共享配置文件冲突      │
    │ (FATAL)              │            │ (FATAL)              │
    ├──────────────────────┤            ├──────────────────────┤
    │ 例子:                │            │ 例子:                │
    │ • Terminal 1 写      │            │ • package.json       │
    │   src/utils.ts       │            │ • .workflow/*.yml    │
    │ • Terminal 2 也写    │            │ • openapi.yaml       │
    │   src/utils.ts       │            │                      │
    └──────────┬───────────┘            └──────────┬───────────┘
               │                                   │
               ▼                                   ▼
      ┌─────────────────┐              ┌─────────────────────┐
      │ 降级策略:        │              │ 降级策略:            │
      │ downgrade_to_   │              │ mutex_lock          │
      │ serial          │              │                     │
      └────────┬────────┘              └──────────┬──────────┘
               │                                   │
               └────────────┬──────────────────────┘
                            ▼
                 ┌────────────────────┐
                 │ 执行降级动作        │
                 ├────────────────────┤
                 │ 1. 暂停后续 Agent  │
                 │ 2. 等待当前 Agent  │
                 │    完成            │
                 │ 3. 串行执行剩余    │
                 │    Agent           │
                 └─────────┬──────────┘
                           │
                           ▼
                 ┌────────────────────┐
                 │ 记录降级事件        │
                 │ ├─ 日志记录        │
                 │ ├─ 指标上报        │
                 │ └─ 用户通知        │
                 └─────────┬──────────┘
                           │
                           ▼
                 ┌────────────────────┐
                 │ ⚠️  降级完成        │
                 │ 继续执行（串行）    │
                 └────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

冲突类型严重程度:
  FATAL    → 立即降级，阻止并行
  MAJOR    → 排队执行
  MINOR    → 警告但继续
  INFO     → 仅记录日志

降级策略对比:
  ┌─────────────────┬─────────┬─────────┬─────────┐
  │ 策略             │ 安全性  │ 效率    │ 适用场景 │
  ├─────────────────┼─────────┼─────────┼─────────┤
  │ downgrade_to_   │ ⭐⭐⭐⭐⭐ │ ⭐      │ 文件冲突 │
  │ serial          │         │         │         │
  ├─────────────────┼─────────┼─────────┼─────────┤
  │ mutex_lock      │ ⭐⭐⭐⭐  │ ⭐⭐⭐   │ 配置文件 │
  ├─────────────────┼─────────┼─────────┼─────────┤
  │ queue_execution │ ⭐⭐⭐   │ ⭐⭐⭐⭐  │ 目录冲突 │
  ├─────────────────┼─────────┼─────────┼─────────┤
  │ abort           │ ⭐⭐⭐⭐⭐ │ ⭐      │ 关键失败 │
  └─────────────────┴─────────┴─────────┴─────────┘
```

---

## 🚨 异常处理可视化

### 6. Git 冲突解决流程图

```
Git 冲突全流程处理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

            [检测到 Git 冲突]
                    │
                    ▼
         ┌────────────────────┐
         │ 冲突类型分析        │
         └────┬──────┬────┬───┘
              │      │    │
    ┌─────────┘      │    └──────────┐
    ▼                ▼               ▼
┌────────┐    ┌────────────┐   ┌─────────┐
│内容冲突│    │删除/修改   │   │二进制   │
│CONFLICT│    │冲突 DA/DU  │   │文件冲突 │
└───┬────┘    └──────┬─────┘   └────┬────┘
    │                │              │
    ▼                ▼              ▼
┌────────────┐  ┌────────────┐  ┌────────────┐
│尝试自动合并│  │选择版本:   │  │选择版本:   │
│git merge-  │  │• 保留 ours │  │• ours      │
│file        │  │• 保留theirs│  │• theirs    │
└──┬────┬────┘  │• 手动合并  │  └──────┬─────┘
   │    │       └──────┬─────┘         │
[成功][失败]           │               │
   │    │              │               │
   │    └──────┬───────┴───────────────┘
   │           ▼
   │    ┌──────────────────┐
   │    │ 人工解决冲突      │
   │    ├──────────────────┤
   │    │ 1. 打开编辑器    │
   │    │ 2. 标记冲突区域  │
   │    │    <<<<<<<      │
   │    │    =======      │
   │    │    >>>>>>>      │
   │    │ 3. 手动编辑      │
   │    └─────────┬────────┘
   │              │
   └──────┬───────┘
          ▼
   ┌──────────────────┐
   │ 验证解决方案      │
   ├──────────────────┤
   │ • 运行测试        │
   │ • 检查语法        │
   │ • 手动验证功能    │
   └──────┬──────┬────┘
          │      │
    [通过] │      │ [失败]
          ▼      ▼
   ┌──────────┐ ┌────────┐
   │ 提交解决 │ │ 重新   │
   │ git add  │ │ 编辑   │
   │ git      │ └───┬────┘
   │ commit   │     │
   └─────┬────┘     │
         │          │
         └────┬─────┘
              ▼
       ┌──────────────┐
       │ ✅ 冲突解决  │
       │ 继续工作流   │
       └──────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

冲突标记示例:
  <<<<<<< HEAD (wip/login)
  function login(username, password) {
    return authenticate(username, password);
  }
  =======
  function login(email, pass) {
    return auth(email, pass);
  }
  >>>>>>> main

解决方案选择:
  选项 A: 保留 HEAD (当前分支)
  选项 B: 保留 main (主分支)
  选项 C: 合并两者（推荐）
    function login(username, password) {
      // 兼容 email 和 username
      return authenticate(username || email, password || pass);
    }
```

---

### 7. 网络故障恢复流程

```
网络故障自动恢复机制
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

        [执行: git push origin wip/login]
                      │
                      ▼
           ┌────────────────────┐
           │  网络请求           │
           │  超时检测 (30s)    │
           └────┬───────┬───────┘
                │       │
          [成功] │       │ [超时/失败]
                ▼       ▼
         ┌──────────┐  ┌───────────────┐
         │ ✅ 完成  │  │ ❌ 检测到错误  │
         └──────────┘  │ 错误码: 128   │
                       └───────┬───────┘
                               │
                               ▼
                    ┌────────────────────┐
                    │ 重试机制启动        │
                    │ 尝试次数: 1/3      │
                    └──────┬─────────────┘
                           │
                ┌──────────┴──────────┐
                ▼                     ▼
         ┌─────────────┐       ┌─────────────┐
         │ 等待 2 秒   │       │ 检查网络    │
         │ (指数退避)  │       │ 连通性      │
         └──────┬──────┘       └──────┬──────┘
                │                     │
                └──────────┬──────────┘
                           ▼
                [重试 git push]
                           │
              ┌────────────┼────────────┐
              ▼            ▼            ▼
        [成功]        [超时]        [失败 3 次]
              │            │            │
              ▼            │            ▼
       ┌──────────┐        │     ┌─────────────────┐
       │ ✅ 完成  │        │     │ 降级方案启动     │
       └──────────┘        │     ├─────────────────┤
                           │     │ 1. 创建本地      │
                           │     │    bundle:      │
                           │     │    login.bundle │
                           │     │                 │
                           │     │ 2. 记录到队列:  │
                           │     │    .workflow/   │
                           │     │    pending.yml  │
                           │     │                 │
                           │     │ 3. 启动后台任务:│
                           │     │    自动重试守护 │
                           │     └────────┬────────┘
                           │              │
              ┌────────────┘              │
              ▼                           ▼
       ┌─────────────┐          ┌─────────────────┐
       │ 尝试 2/3    │          │ 用户通知         │
       │ 等待 4 秒   │          ├─────────────────┤
       └──────┬──────┘          │ ⚠️  网络不稳定  │
              │                 │ 已保存到本地     │
              ▼                 │                 │
        [重试...]               │ 📁 login.bundle │
                                │                 │
                                │ 🔄 后台持续重试  │
                                └─────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

重试策略参数:
  • 最大重试次数: 3
  • 初始延迟: 2 秒
  • 退避倍数: 2 (2s → 4s → 8s)
  • 最大延迟: 30 秒

降级方案:
  1. 本地 Bundle:
     git bundle create login.bundle HEAD
     文件大小: ~1-10 MB

  2. 待办队列:
     .workflow/pending.yml
     ├─ wip/login: pending
     ├─ retry_count: 3
     └─ last_attempt: 2025-10-09T10:30:00Z

  3. 后台守护进程:
     systemd/launchd 自动重试
     检查间隔: 每 5 分钟
```

---

### 8. CI/CD 失败诊断树

```
CI/CD 失败诊断与修复流程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

               [GitHub Actions 失败]
                        │
                        ▼
            ┌─────────────────────┐
            │  查看失败的 Job      │
            │  gh pr checks        │
            └──────┬──────────────┘
                   │
      ┌────────────┼────────────┐
      ▼            ▼            ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│  Lint    │ │  Test    │ │  Build   │
│  Failed  │ │  Failed  │ │  Failed  │
└────┬─────┘ └────┬─────┘ └────┬─────┘
     │            │            │
     ▼            ▼            ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 本地复现:   │ │ 本地复现:   │ │ 本地复现:   │
│ npm run     │ │ npm test    │ │ npm run     │
│ lint        │ │             │ │ build       │
└──────┬──────┘ └──────┬──────┘ └──────┬──────┘
       │               │               │
       ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 自动修复:   │ │ 分析失败:   │ │ 检查依赖:   │
│ npm run     │ │ • 断言失败  │ │ npm install │
│ lint:fix    │ │ • 超时      │ │             │
└──────┬──────┘ │ • 环境问题  │ │ 检查版本:   │
       │        └──────┬──────┘ │ node -v     │
       ▼               │        │ npm -v      │
┌─────────────┐        ▼        └──────┬──────┘
│ 验证修复:   │ ┌─────────────┐        │
│ npm run     │ │ 修复代码:   │        ▼
│ lint        │ │ • 修复逻辑  │ ┌─────────────┐
└──────┬──────┘ │ • 更新测试  │ │ 修复依赖:   │
       │        │ • Mock 数据 │ │ npm update  │
       ▼        └──────┬──────┘ │ npm audit   │
┌─────────────┐        │        │ fix         │
│ 提交修复:   │        ▼        └──────┬──────┘
│ git add .   │ ┌─────────────┐        │
│ git commit  │ │ 验证修复:   │        ▼
│ git push    │ │ npm test    │ ┌─────────────┐
└──────┬──────┘ └──────┬──────┘ │ 验证修复:   │
       │               │        │ npm run     │
       │               ▼        │ build       │
       │        ┌─────────────┐ └──────┬──────┘
       │        │ 提交修复:   │        │
       │        │ git commit  │        │
       │        │ git push    │        │
       │        └──────┬──────┘        │
       │               │               │
       └───────┬───────┴───────┬───────┘
               ▼               ▼
        ┌──────────────────────────┐
        │  等待 CI 重新运行         │
        │  (自动触发)              │
        └─────────┬────────────────┘
                  │
         ┌────────┴────────┐
         ▼                 ▼
    [✅ 通过]         [❌ 仍失败]
         │                 │
         ▼                 ▼
  ┌──────────┐      ┌─────────────┐
  │ 继续流程 │      │ 深度诊断:   │
  │ 等待审查 │      │ • 查看完整  │
  └──────────┘      │   日志      │
                    │ • 联系专家  │
                    │ • 检查 CI   │
                    │   环境      │
                    └─────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

常见失败原因与解决方案:

Lint 失败:
  原因: 代码风格不符合规范
  解决: npm run lint:fix
  时间: 1-2 分钟

Test 失败:
  原因: 单元测试断言失败
  解决: 修复代码逻辑或更新测试
  时间: 10-30 分钟

Build 失败:
  原因: TypeScript 编译错误
  解决: 修复类型定义
  时间: 5-15 分钟

依赖问题:
  原因: package.json 版本冲突
  解决: npm install 或 npm audit fix
  时间: 2-5 分钟
```

---

## 📊 性能对比图表

### 9. 串行 vs 并行时间对比

```
开发时间对比（3 个功能）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

串行开发（传统方式）:
  0h    2h    4h    6h    8h    10h   12h   14h   16h   18h
  ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤
  │ Feature 1                   │ Feature 2         │ Feat│ure 3      │
  │ ████████████████████████████│███████████████████│████│███████████ │
  │ P0-P6: 5.4h                 │ P0-P6: 5.4h       │ P0-│P6: 5.4h    │
  │                             │                   │    │            │
  │ 解决冲突: 20min             │ 解决冲突: 20min   │    │            │
  └─────────────────────────────┴───────────────────┴────┴────────────┘
                                总时间: 17.7 小时

并行开发（Claude Enhancer）:
  0h    2h    4h    6h    8h    10h   12h   14h   16h   18h
  ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤
  │ Feature 1                   │ Merge│ CR  │           │            │
  │ ████████████████████████████│██████│     │           │            │
  │ Feature 2                        │ Merge│ CR  │      │            │
  │ ████████████████████████████████ │██████│     │      │            │
  │ Feature 3                          │ Merge│ CR  │    │            │
  │ ██████████████████████████████████│██████│     │    │            │
  └────────────────────────────────────┴──────┴─────┴────┴────────────┘
                    总时间: 5.8 小时

性能提升:
  ┌────────────────────────────────────────────────────┐
  │ 时间节省: 11.9 小时 (67.3%)                        │
  │ 并行加速比: 3.05x                                  │
  │ 冲突次数: 2 次 → 0 次                              │
  │ 人工操作时间: 85 分钟 → 2 分钟                     │
  └────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

图例:
  ████ = 开发时间（P0-P6）
  ██   = 合并和审查时间
  CR   = Code Review

关键指标:
  • 开发效率提升: 67.3%
  • 上线速度加快: 3 倍
  • 冲突率降低: 从 70% 到 0%
  • 自动化程度: 98%
```

---

### 10. 异常恢复时间统计

```
各类异常平均恢复时间（MTTR）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

异常类型                 平均恢复时间              严重程度
─────────────────────────────────────────────────────────────
Git 冲突
  ├─ 简单冲突            │████░░░░░░ 10min        │ MEDIUM
  ├─ 复杂冲突            │████████░░ 30min        │ HIGH
  └─ 二进制冲突          │████░░░░░░ 15min        │ HIGH

网络故障
  ├─ 短暂超时            │██░░░░░░░░  2min        │ LOW
  ├─ 持续不可用          │████░░░░░░  5min        │ MEDIUM
  └─ 完全离线            │████░░░░░░  N/A         │ INFO

权限问题
  ├─ SSH Key 过期        │████░░░░░░ 10min        │ HIGH
  ├─ Token 失效          │███░░░░░░░  5min        │ MEDIUM
  └─ 仓库权限不足        │██████████ 60min        │ HIGH

CI/CD 失败
  ├─ Lint 错误           │█░░░░░░░░░  1min        │ LOW
  ├─ 测试失败            │████░░░░░░ 15min        │ MEDIUM
  ├─ 构建失败            │███░░░░░░░  5min        │ MEDIUM
  └─ 安全扫描失败        │██████░░░░ 30min        │ HIGH

分支状态异常
  ├─ 分支不存在          │█░░░░░░░░░  1min        │ LOW
  ├─ 工作区不干净        │██░░░░░░░░  3min        │ LOW
  └─ HEAD 游离           │███░░░░░░░  5min        │ MEDIUM

依赖问题
  ├─ 版本冲突            │███░░░░░░░  5min        │ MEDIUM
  ├─ 缺少依赖            │██░░░░░░░░  2min        │ LOW
  └─ 安全漏洞            │████████░░ 30min        │ HIGH

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

图例:
  █ = 10 分钟
  ░ = 未使用时间

平均恢复时间（MTTR）:
  • 总体平均: 12 分钟
  • 中位数: 5 分钟
  • 99th 百分位: 60 分钟

自动恢复率:
  • 完全自动: 35%
  • 半自动: 45%
  • 需人工: 20%
```

---

## 🎯 决策矩阵

### 11. 合并策略选择矩阵

```
合并策略选择指南
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

场景分析         Squash Merge  Merge Commit  Rebase Merge
────────────────────────────────────────────────────────────────
小型功能
  单人开发            ⭐⭐⭐⭐⭐        ⭐⭐             ⭐⭐⭐
  <10 commits

大型功能
  多人协作            ⭐⭐             ⭐⭐⭐⭐⭐        ⭐
  >20 commits

快速修复
  Hotfix              ⭐⭐⭐⭐⭐        ⭐⭐⭐           ⭐⭐⭐⭐

需要追溯
  调试历史            ⭐               ⭐⭐⭐⭐⭐        ⭐⭐
  详细记录

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

优缺点对比:

Squash Merge (推荐默认):
  优点:
    ✅ 主分支历史简洁
    ✅ 每个功能 1 个 commit
    ✅ 容易回滚
    ✅ PR 描述即 commit message
  缺点:
    ❌ 丢失详细开发历史
    ❌ 难以追溯细节
  适用: 80% 的场景

Merge Commit:
  优点:
    ✅ 保留完整历史
    ✅ 可追溯每个 commit
    ✅ 明确标记合并点
  缺点:
    ❌ 主分支历史复杂
    ❌ 图形化日志难看
  适用: 大型功能、团队协作

Rebase Merge:
  优点:
    ✅ 线性历史
    ✅ 无合并 commit
  缺点:
    ❌ 重写历史（风险）
    ❌ 冲突难解决
  适用: 简单功能、无冲突

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

决策流程:
  ┌─────────────────────┐
  │ 是否单人开发?        │
  └──┬─────────────┬────┘
     │ 是          │ 否
     ▼             ▼
  ┌──────────┐  ┌──────────┐
  │ Squash   │  │ 是否 >20 │
  │ Merge    │  │ commits? │
  └──────────┘  └──┬───┬───┘
                   │是 │否
                   ▼   ▼
              ┌────────┬────────┐
              │ Merge  │ Squash │
              │ Commit │ Merge  │
              └────────┴────────┘
```

---

## 📚 快速参考卡片

### 12. 命令速查卡

```
┌─────────────────────────────────────────────────────────────┐
│  Claude Enhancer 并行开发命令速查卡                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  启动新功能                                                  │
│  ────────────────────────────────────────────────────────   │
│  $ ce start <feature>          创建 wip/ 分支并初始化       │
│  $ ce start login              示例: 创建登录功能分支       │
│  $ ce start payment --from dev 从 dev 分支创建              │
│                                                             │
│  查看状态                                                    │
│  ────────────────────────────────────────────────────────   │
│  $ ce status                   查看当前 Phase 和进度        │
│  $ ce branches                 列出所有 wip 分支            │
│  $ ce conflicts                检查潜在冲突                 │
│                                                             │
│  开发流程                                                    │
│  ────────────────────────────────────────────────────────   │
│  $ ce validate                 验证当前 Phase Gates         │
│  $ ce next                     进入下一个 Phase             │
│  $ ce goto P3                  跳转到 P3 实现阶段           │
│                                                             │
│  发布与合并                                                  │
│  ────────────────────────────────────────────────────────   │
│  $ ce publish                  推送并创建 Draft PR          │
│  $ ce publish --ready          创建正式 PR                  │
│  $ ce merge wip/login          合并功能分支到 main          │
│  $ ce cleanup                  清理已合并的分支             │
│                                                             │
│  故障排查                                                    │
│  ────────────────────────────────────────────────────────   │
│  $ ce diagnose                 诊断常见问题                 │
│  $ ce logs                     查看日志                     │
│  $ ce doctor                   健康检查                     │
│  $ ce rollback <commit>        回滚指定提交                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

### 13. Phase 推进检查清单

```
┌─────────────────────────────────────────────────────────────┐
│  8-Phase 工作流检查清单（快速版）                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ☐ P0 探索 (20-40min)                                       │
│     ├─ 技术方案可行性验证                                   │
│     ├─ 识别依赖和风险                                       │
│     └─ 估算工作量                                           │
│                                                             │
│  ☐ P1 规划 (30-60min)                                       │
│     ├─ 创建 docs/PLAN.md                                    │
│     ├─ 任务清单 ≥ 5 条                                      │
│     ├─ 受影响文件清单                                       │
│     └─ 回滚方案                                             │
│                                                             │
│  ☐ P2 骨架 (15-30min)                                       │
│     ├─ 创建目录结构                                         │
│     ├─ 定义接口和类型                                       │
│     └─ 生成占位代码                                         │
│                                                             │
│  ☐ P3 实现 (60-180min)                                      │
│     ├─ 实现核心业务逻辑                                     │
│     ├─ 更新 CHANGELOG.md                                    │
│     └─ 代码可构建运行                                       │
│                                                             │
│  ☐ P4 测试 (30-90min)                                       │
│     ├─ 单元测试通过                                         │
│     ├─ 边界测试通过                                         │
│     ├─ 覆盖率 ≥ 80%                                         │
│     └─ 集成测试（可选）                                     │
│                                                             │
│  ☐ P5 审查 (20-40min)                                       │
│     ├─ 代码自审                                             │
│     ├─ 生成 docs/REVIEW.md                                  │
│     ├─ 标记风险点                                           │
│     └─ 明确 APPROVE/REWORK                                  │
│                                                             │
│  ☐ P6 发布准备 (10-20min)                                   │
│     ├─ 更新文档                                             │
│     ├─ 运行健康检查                                         │
│     ├─ 打 tag（可选）                                       │
│     └─ ce validate 全通过                                   │
│                                                             │
│  ☐ P7 监控 (15min, 合并后)                                  │
│     ├─ 健康检查通过                                         │
│     ├─ SLO 指标正常                                         │
│     └─ 无告警触发                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎓 最佳实践提示

### 14. 分支命名规范卡片

```
┌─────────────────────────────────────────────────────────────┐
│  分支命名规范（强制执行）                                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  强制格式:  wip/<feature-name>                               │
│                                                             │
│  ✅ 推荐命名:                                                │
│     wip/user-login            功能开发                      │
│     wip/fix-payment-bug       Bug 修复                      │
│     wip/refactor-api          代码重构                      │
│     wip/docs-quickstart       文档更新                      │
│     wip/perf-database         性能优化                      │
│                                                             │
│  ❌ 禁止命名:                                                │
│     feature/xxx               旧格式（不兼容）              │
│     dev/xxx                   非标准前缀                    │
│     xxx                       缺少前缀                      │
│     wip/123                   缺少描述                      │
│     wip/MY-FEATURE            大写字母                      │
│                                                             │
│  命名原则:                                                   │
│  • 使用小写字母和连字符 (kebab-case)                        │
│  • 描述性强，一看就懂                                       │
│  • 长度不超过 30 个字符                                     │
│  • 避免缩写（除非众所周知）                                 │
│  • 反映功能本质，而非实现细节                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

### 15. Commit Message 模板

```
┌─────────────────────────────────────────────────────────────┐
│  Commit Message 规范模板                                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  格式:                                                       │
│    <type>(<scope>): <subject> [<phase>]                     │
│                                                             │
│  类型 (type):                                                │
│    feat     新功能                                          │
│    fix      修复 Bug                                        │
│    docs     文档更新                                        │
│    style    代码格式（不影响逻辑）                          │
│    refactor 重构（不改变功能）                              │
│    test     测试相关                                        │
│    chore    构建/工具变更                                   │
│    perf     性能优化                                        │
│                                                             │
│  范围 (scope, 可选):                                         │
│    auth, payment, notify (功能模块)                         │
│    api, db, ui (技术层)                                     │
│    core, utils (基础模块)                                   │
│                                                             │
│  Phase 标记 (可选):                                          │
│    [P0], [P1], [P2], [P3], [P4], [P5], [P6], [P7]          │
│                                                             │
│  ✅ 正确示例:                                                │
│    feat(auth): 实现用户登录功能 [P3]                        │
│    fix(payment): 修复金额计算精度问题 [P3]                  │
│    docs: 更新 API 使用文档 [P6]                             │
│    test(auth): 添加登录边界测试 [P4]                        │
│    refactor(api): 重构错误处理逻辑 [P3]                     │
│                                                             │
│  ❌ 错误示例:                                                │
│    "update code"              太笼统，缺少上下文            │
│    "fix bug"                  缺少范围和描述                │
│    "Add login feature..."     首字母大写，有省略号          │
│    "修复登录问题"             中文（推荐英文）              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📞 故障排查索引

### 16. 常见问题快速索引

```
┌─────────────────────────────────────────────────────────────┐
│  常见问题快速解决索引                                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Q1: 忘记创建分支，在 main 上开发了？                        │
│  A1: git checkout -b wip/my-feature                         │
│      git checkout main                                      │
│      git reset --hard origin/main                           │
│                                                             │
│  Q2: 如何处理功能依赖关系？                                  │
│  A2: ce start feature-b --depends-on wip/feature-a          │
│      或串行开发（推荐）                                      │
│                                                             │
│  Q3: CI 一直失败怎么办？                                     │
│  A3: 1. 本地复现: npm run test                              │
│      2. 查看日志: gh pr checks wip/xxx                      │
│      3. 修复后推送: git push                                │
│                                                             │
│  Q4: 如何回滚错误的合并？                                    │
│  A4: ce rollback <PR-number>                                │
│      或: git revert <merge-commit>                          │
│                                                             │
│  Q5: 多个分支修改了同一文件？                                │
│  A5: 系统会自动检测并降级为串行执行                          │
│      或手动: git rebase main 解决冲突                        │
│                                                             │
│  Q6: 如何查看当前所有 wip 分支？                             │
│  A6: ce branches                                            │
│      或: git branch | grep wip/                             │
│                                                             │
│  Q7: 如何清理已合并的分支？                                  │
│  A7: ce cleanup                                             │
│      或: git branch -d wip/xxx                              │
│                                                             │
│  Q8: 推送失败（网络问题）？                                  │
│  A8: 系统会自动重试 3 次                                     │
│      失败后保存到 .workflow/bundles/                        │
│                                                             │
│  Q9: 如何强制发布（未完成 P6）？                             │
│  A9: ce publish --force                                     │
│      （不推荐，仅紧急情况）                                  │
│                                                             │
│  Q10: 如何查看详细日志？                                     │
│  A10: cat .workflow/logs/executor.log                       │
│       cat .workflow/logs/claude_hooks.log                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📝 文档元信息

```
文档版本: 1.0.0
创建日期: 2025-10-09
作者: Business Analyst (Claude Code)
配套文档: AI_PARALLEL_DEV_WORKFLOW.md
状态: 讨论模式 - 可视化参考

使用建议:
  • 打印此文档作为桌面参考
  • 将流程图分享给团队成员
  • 在团队会议中使用决策矩阵
  • 根据实际情况调整参数

下一步:
  • 用户审查可视化设计
  • 根据反馈调整图表
  • 准备实施阶段
```

---

**文档结束 - 准备好可视化你的并行开发流程了吗？**
