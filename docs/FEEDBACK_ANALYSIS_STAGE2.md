# 阶段2：9个问题的优先级与解决方案

## 🎯 核心策略

**原则**：先解决"影响理解"的问题，再解决"锦上添花"的问题

**类比**：
```
建房子缺说明书：
优先级1：先说明"厕所在哪、怎么开门"（基础功能）
优先级2：再说明"WiFi密码、空调遥控器"（高级功能）
优先级3：最后说明"装饰品含义、设计理念"（美化内容）
```

---

## 📊 优先级矩阵（影响 × 难度）

```
高影响 │
      │ ① 8-Phase DoD       ③ Hook矩阵      ⑨ 术语统一
      │ (P1 - 必须先做)     (P1)            (P1)
      │
      │ ⑥ 质量分计算       ⑧ 端到端案例    ⑦ 触发词
      │ (P2 - 接着做)      (P2)            (P2)
      │
低影响│ ② 5层说明         ④ 并行规则      ⑤ 安全强调
      │ (P3 - 最后做)      (P3)            (P3)
      │
      └────────────────────────────────────────
         低难度              中难度           高难度
```

### 优先级分组

**P1 - 必须先做**（基础理解，缺了就看不懂）
1. ① 8-Phase DoD表格 - **影响最大**
2. ③ Hook职责矩阵 - **最困惑的点**
3. ⑨ 术语统一 - **全文一致性**

**P2 - 接着做**（增强可用性）
4. ⑥ 质量分计算方法 - **建立信任**
5. ⑧ 端到端案例 - **实际操作**
6. ⑦ 固定触发词 - **降低门槛**

**P3 - 最后做**（锦上添花）
7. ② 5层保障说明 - **已有4层够用**
8. ④ 并行规则详解 - **高级话题**
9. ⑤ 安全清单强调 - **已有机制**

---

## 🔧 详细解决方案（逐个击破）

---

## 优先级P1-1：8-Phase DoD表格

### 问题本质
**现状**：知道有P0-P7，但不知道每个Phase做什么、怎么算完成
**影响**：读者在P3时不知道现在干啥、还要多久、怎么知道完没完

### 解决方案：DoD表格

**可直接粘贴的模块**：

```markdown
## 8-Phase 完整定义（DoD表格）

| 阶段 | 名称 | 英文 | 主要工作 | 输入 | 输出 | 完成标准（DoD） | 预计耗时 |
|-----|------|------|---------|------|------|----------------|---------|
| **P0** | 探索 | Discovery | 技术调研、可行性验证 | 需求描述 | 可行性报告 | • 技术方案确定<br>• 风险点识别<br>• 依赖项清单 | 5-10分钟 |
| **P1** | 规划 | Planning | 详细设计、生成方案 | P0报告 | PLAN.md | • PLAN.md ≥300行<br>• 架构图完整<br>• API设计明确 | 10-15分钟 |
| **P2** | 骨架 | Skeleton | 搭建目录、创建占位 | PLAN.md | 目录结构 | • 目录结构创建<br>• 空文件占位<br>• dry-run通过 | 5分钟 |
| **P3** | 实现 | Implementation | 核心代码开发 | P2骨架 | 代码+测试 | • 代码完成<br>• 单元测试≥80%<br>• 自检通过 | 15-30分钟 |
| **P4** | 测试 | Testing | 全面质量验证 | P3代码 | 测试报告 | • 所有测试通过<br>• 覆盖率≥80%<br>• 安全扫描通过 | 10-15分钟 |
| **P5** | 审查 | Review | 代码审查评分 | P4结果 | REVIEW.md | • REVIEW.md生成<br>• 质量≥80/100<br>• 无阻断问题 | 5-10分钟 |
| **P6** | 发布 | Release | 准备上线交付 | P5审查 | Tag+文档 | • CHANGELOG更新<br>• Git Tag创建<br>• 健康检查通过 | 5分钟 |
| **P7** | 监控 | Monitor | 生产监控配置 | P6发布 | 监控配置 | • SLO配置验证<br>• 性能预算设置<br>• 告警规则完整 | 5分钟 |

### Phase转换规则
- **顺序强制**：不能跳Phase（P1→P3会被拒绝）
- **Gate签名**：每个Phase完成签署.gates/XX.ok.sig
- **状态追踪**：.phase/current记录当前阶段
- **失败回退**：检查不通过回到上一Phase

### 示例：你在P3阶段
```
当前状态：cat .phase/current
输出：P3

你知道：
- 现在在做什么：核心代码开发（6个Agents并行）
- 要多久：预计15-30分钟
- 怎么算完：单元测试≥80% + 自检通过
- 完成后产出：1,850行代码 + 75个测试用例
```
```

**放置位置**：SYSTEM_OVERVIEW_COMPLETE.md 第2节（8-Phase工作流）

**工作量**：1小时（整理表格+验证数据）

---

## 优先级P1-2：Hook职责矩阵

### 问题本质
**现状**：知道有Git Hook和Claude Hook，但不知道谁管什么、什么时候触发
**影响**：被拦住了不知道是哪层拦的、为什么拦、怎么解决

### 解决方案：职责矩阵表

**可直接粘贴的模块**：

```markdown
## Git Hook vs Claude Hook 职责矩阵

### 快速对照表

| 触发时机 | Claude Hook | Git Hook | 失败后果 | 如何修复 |
|---------|------------|----------|---------|---------|
| **准备执行前** | ✓ 校验模式<br>✓ 选择Agents | - | 停止执行 | 说"启动执行" |
| **开始编码前** | ✓ 生成任务清单<br>✓ 对照DoD | - | 回到P2/P3 | 补齐缺项 |
| **本地提交时** | ✓ 自检标记 | ✓ 拦截不合规提交 | 提交被拒 | 按提示修复 |
| **写提交信息** | ✓ 建议模板 | ✓ 强制格式验证 | 提交被拒 | 改用正确格式 |
| **推送前** | ✓ 汇总得分 | ✓ 阻止低分推送 | 推送被拒 | 修复后重试 |
| **PR/合并** | ✓ 附带报告 | - (CI接管) | PR不可合并 | 补充缺失项 |

### 详细职责分工

#### 第1阶段：准备执行（Claude Hook主导）

**Claude Hook工作**：
```bash
位置：.claude/hooks/smart_agent_selector.sh

1. 分析任务描述
   输入："实现用户登录功能"
   处理：determine_complexity()
   输出：complexity = "standard" (6个Agents)

2. 推荐Agents组合
   输入：complexity = "standard"
   处理：get_agent_recommendations()
   输出：
   - backend-architect
   - security-auditor
   - api-designer
   - database-specialist
   - test-engineer
   - technical-writer

3. 给Claude建议
   💡 "登录功能属于安全敏感任务，建议使用6个Agents"
```

**Git Hook工作**：无（此阶段Git Hook不参与）

**失败处理**：
- Claude Hook建议被忽略 → 继续执行（软约束）
- 但Git Hook会在提交时检查实际使用的Agents数量

---

#### 第2阶段：本地提交（Git Hook主导）

**Git Hook工作**：
```bash
位置：.git/hooks/pre-commit 第135-200行

检查1：分支保护
if [ "$BRANCH" = "main" ]; then
    if [ "$CE_AUTOBRANCH" != "1" ]; then
        echo "❌ 禁止提交到main分支"
        echo "方案1: export CE_AUTOBRANCH=1"
        echo "方案2: git checkout -b feature/xxx"
        exit 1  # 硬拦截
    fi
fi

检查2：工作流验证
if [ ! -f ".phase/current" ]; then
    echo "❌ 未启动工作流"
    exit 1  # 硬拦截
fi

检查3：Gate签名
验证P0-当前Phase的所有Gate已签署
```

**Claude Hook工作**：
```bash
位置：.claude/hooks/quality_gate.sh

提前质量检查：
- 任务描述长度 ≥ 10字符
- 包含动作词（实现/修复/优化）
- 无危险操作（删除全部/rm -rf）

输出质量评分：${score}/100
如果 score < 70：给出改进建议（不阻止）
```

**失败处理**：
```
Claude Hook警告 → 继续（给建议）
Git Hook拒绝 → 停止（硬拦截）

示例：
Claude Hook: "⚠️ 任务描述过短，建议补充"
用户：忽略继续

Git Hook: "❌ 禁止提交到main分支"
用户：必须修复，否则无法提交
```

---

### 类比理解

```
Claude Hook = GPS导航
- "建议走这条路（6个Agents）"
- "前方有施工，建议绕行（任务描述不清）"
- 你可以不听，但可能遇到问题

Git Hook = 高速收费站
- "没买ETC不让过"
- "超载不让过"
- "无牌照不让过"
- 必须满足才能通过，无商量余地
```

### 协同工作流程图

```
你准备提交代码
    ↓
Claude Hook先检查（软约束）
    ├─ ✓ 通过 → 给出建议 → 继续
    └─ ✗ 警告 → 给出建议 → 继续（不阻止）
    ↓
Git Hook再检查（硬约束）
    ├─ ✓ 通过 → 提交成功 ✅
    └─ ✗ 失败 → 提交被拒 ❌ → 打印修复命令
    ↓
如果被拒绝：
    1. 看错误提示（哪一层拦的）
    2. 看修复命令（3选1）
    3. 执行修复
    4. 重新提交
```

### 实际案例

**案例1：在main分支提交**

```bash
# 你的操作
$ git commit -m "fix bug"

# Claude Hook（软约束）
🎯 质量评分: 75/100
📋 质量建议:
  💡 建议包含更详细的bug描述
✅ 质量检查通过（继续）

# Git Hook（硬约束）
🔍 Claude Enhancer Pre-commit Check
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ ERROR: 禁止直接提交到 main 分支

解决方案（3选1）:
方式1: 自动分支模式（推荐）
  export CE_AUTOBRANCH=1
  git commit -m "fix bug"

方式2: 手动创建分支
  git checkout -b feature/fix-bug
  git commit -m "fix bug"

方式3: 启动工作流
  bash .claude/hooks/workflow_enforcer_v2.sh 'fix bug'

# 结果：提交被拒绝 ❌
```

**案例2：未启动工作流**

```bash
# 你的操作
$ git commit -m "add feature"

# Claude Hook
✅ 质量检查通过

# Git Hook
🔍 Claude Enhancer Pre-commit Check
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[WORKFLOW]
❌ ERROR: 未启动工作流
启动: bash .claude/hooks/workflow_enforcer_v2.sh '任务描述'

# 结果：提交被拒绝 ❌
```

### 关键差异总结

| 维度 | Claude Hook | Git Hook |
|-----|------------|----------|
| 类型 | 🧭 建议型 | 🚧 强制型 |
| 时机 | AI执行前 | Git操作时 |
| 失败 | 给建议，继续 | 拒绝，停止 |
| 绕过 | ✅ 可忽略 | ❌ 不可绕过 |
| 作用 | 帮助决策 | 防止错误 |
| 示例 | "建议用6个Agents" | "main分支禁止提交" |
```

**放置位置**：SYSTEM_OVERVIEW_COMPLETE.md 第4节（Hook分工）

**工作量**：2小时（整理矩阵+绘制流程图）

---

## 优先级P1-3：术语统一

### 问题本质
**现状**：同一概念有多种叫法，读者晕车
**影响**：看文档像在做"找不同"游戏

### 解决方案：术语表+全篇替换

**可直接粘贴的模块**：

```markdown
## 术语速查表（请收藏）

### 核心概念

| 术语 | 含义 | 别名（不再使用） | 示例 |
|-----|------|----------------|------|
| **讨论模式** | 只读分析、出方案、不改文件 | 探索模式、只读模式 | 你说需求，Claude给方案ABC |
| **执行模式** | 启动工作流、可以改文件 | 工作流模式、开发模式 | 说"启动执行"后进入 |
| **启动执行** | 从讨论切换到执行的动作 | 触发执行、进入工作流、开始实现 | 触发词："启动执行" |
| **Phase** | 8个阶段之一（P0-P7） | 阶段、Phase | "当前Phase = P3" |
| **Gate** | Phase完成的签名证明 | 门禁、质量门 | .gates/03.ok.sig |
| **Agent** | 专业子代理（如backend-architect） | 子Agent、专家 | 6个Agents并行工作 |
| **Hook** | 检查脚本 | 钩子、拦截器 | Git Hook拦截提交 |
| **DoD** | Definition of Done（完成标准） | 验收标准、完成定义 | "DoD：测试≥80%" |

### 工作流术语

| 术语 | 含义 | 何时用 |
|-----|------|-------|
| **P0-P7** | 8个Phase的编号 | 讨论工作流时 |
| **Discovery** | P0探索阶段 | 技术调研时 |
| **Planning** | P1规划阶段 | 设计方案时 |
| **Implementation** | P3实现阶段 | 写代码时 |
| **DONE** | 全部Phase完成 | .phase/current = DONE |

### Hook术语

| 术语 | 含义 | 位置 |
|-----|------|------|
| **Claude Hook** | AI执行前的辅助脚本 | .claude/hooks/ |
| **Git Hook** | Git操作时的拦截脚本 | .git/hooks/ |
| **pre-commit** | 提交前检查的Hook | .git/hooks/pre-commit |
| **质量门** | quality_gate.sh | .claude/hooks/quality_gate.sh |

### 质量术语

| 术语 | 含义 | 示例 |
|-----|------|------|
| **质量分** | 0-100的综合评分 | "质量分：92/100" |
| **A+** | 质量等级（≥90分） | "等级：A+ (Excellent)" |
| **及格线** | 最低可合并分数（85分） | "85分以上可合并" |
| **保障力** | 系统保护能力评分 | "保障力：93/100" |

### 触发词（固定用法）

| 触发词 | 作用 | 响应 |
|-------|------|------|
| "启动执行" | 进入执行模式 | 激活8-Phase工作流 |
| "开始实现" | 同上 | 同上 |
| "let's implement" | 同上（英文） | 同上 |
| "讨论这个需求" | 保持讨论模式 | 只读分析 |

### 使用规范

**✅ 统一说法（推荐）**：
- "切换到执行模式"
- "当前在P3阶段"
- "Git Hook拦截了提交"
- "质量分达到92分"

**❌ 不统一说法（避免）**：
- "进入工作流" / "启动开发" / "触发执行"
- "现在是实现阶段" / "在Implementation" / "P3 Phase"
- "被hook挡住了" / "拦截器阻止了" / "钩子失败"
- "评分92" / "得分92/100" / "质量92分"
```

**放置位置**：SYSTEM_OVERVIEW_COMPLETE.md 第1节开头（术语速查表）

**全篇替换**：
1. 搜索所有"探索模式/只读模式" → 替换为"讨论模式"
2. 搜索所有"触发执行/进入工作流/开始实现" → 替换为"启动执行"
3. 搜索所有"阶段" → 替换为"Phase"（保持英文缩写）
4. 搜索所有"门禁/拦截器" → 替换为"Hook"

**工作量**：1.5小时（制作术语表+全篇查找替换）

---

## 优先级P2-1：质量分计算方法

### 问题本质
**现状**：说"100/100"，但不知道怎么算的
**影响**：读者怀疑"是不是AI自己打的虚分"

### 解决方案：公开计算方法

**可直接粘贴的模块**：

```markdown
## 质量分 = 100分的计算方法

### 评分维度与权重

| 维度 | 权重 | 检查项 | 满分条件 | 实际得分示例 |
|-----|------|-------|---------|------------|
| **代码质量** | 15分 | • Lint通过<br>• 复杂度<10<br>• 注释率>20%<br>• 函数<50行 | 全部满足 | 15/15 ✅ |
| **文档质量** | 15分 | • ≥1500行<br>• 行号准确<br>• 结构清晰<br>• 示例可用 | 全部满足 | 15/15 ✅ |
| **测试覆盖** | 15分 | • 覆盖率≥80%<br>• 集成测试完整<br>• BDD场景覆盖<br>• 通过率100% | 全部满足 | 15/15 ✅ |
| **安全性** | 15分 | • 0个CVE漏洞<br>• 无敏感信息<br>• 输入验证完整<br>• 最小权限 | 全部满足 | 15/15 ✅ |
| **性能** | 10分 | • p95<200ms<br>• 吞吐≥20req/s<br>• 内存<512MB<br>• 0次回归 | 全部满足 | 10/10 ✅ |
| **可维护性** | 10分 | • 代码复用高<br>• 依赖清晰<br>• 错误处理好<br>• 日志完整 | 全部满足 | 10/10 ✅ |
| **需求符合** | 10分 | • 功能完整<br>• 边界处理<br>• 用户体验<br>• 错误提示清晰 | 全部满足 | 10/10 ✅ |
| **向后兼容** | 10分 | • API不破坏<br>• 有迁移脚本<br>• 可回滚<br>• 版本管理 | 全部满足 | 10/10 ✅ |
| **总分** | **100分** | | | **100/100** |

### 计算公式

```
质量分 = Σ(维度得分 × 权重)

示例计算：
代码质量：15分 × 100% = 15分
文档质量：15分 × 100% = 15分
测试覆盖：15分 × 100% = 15分
安全性：  15分 × 100% = 15分
性能：    10分 × 100% = 10分
可维护性：10分 × 100% = 10分
需求符合：10分 × 100% = 10分
向后兼容：10分 × 100% = 10分
━━━━━━━━━━━━━━━━━━━━━━━━
总分 = 100分
```

### 详细检查项

#### 1. 代码质量（15分）

| 检查项 | 工具 | 标准 | 分值 |
|-------|------|------|------|
| Lint通过 | shellcheck/eslint | 0 errors | 5分 |
| 圈复杂度 | 代码分析 | <10 | 3分 |
| 注释率 | 统计 | >20% | 4分 |
| 函数长度 | 代码分析 | <50行 | 3分 |

#### 2. 文档质量（15分）

| 检查项 | 标准 | 分值 |
|-------|------|------|
| 总行数 | ≥1500行 | 5分 |
| 行号引用 | 100%准确 | 3分 |
| 结构完整 | 有目录+章节 | 4分 |
| 示例可用 | 可复制执行 | 3分 |

**实际检查命令**：
```bash
# 文档行数
$ wc -l docs/*.md
2647 total  # ≥1500 ✅

# 示例可执行性
$ bash -n 文档中的代码块
无错误 ✅
```

#### 3. 测试覆盖（15分）

| 检查项 | 标准 | 分值 |
|-------|------|------|
| 覆盖率 | ≥80% | 5分 |
| 集成测试 | 关键路径覆盖 | 4分 |
| BDD场景 | ≥25个场景 | 3分 |
| 通过率 | 100% | 3分 |

**实际检查命令**：
```bash
# 运行测试
$ npm test
85/85 passed  # 100% ✅

# 覆盖率
$ npm run coverage
92% coverage  # ≥80% ✅
```

#### 4. 安全性（15分）

| 检查项 | 工具 | 标准 | 分值 |
|-------|------|------|------|
| CVE扫描 | npm audit | 0 vulnerabilities | 5分 |
| 敏感信息 | grep扫描 | 无泄露 | 4分 |
| 输入验证 | 代码审查 | 完整 | 3分 |
| 权限控制 | 代码审查 | 最小权限 | 3分 |

**实际检查命令**：
```bash
# 安全扫描
$ npm audit
0 vulnerabilities  # ✅

# 敏感信息检查
$ grep -r "password\|secret\|token" --exclude-dir=.git
只在注释中出现 ✅
```

### 等级划分

| 分数区间 | 等级 | 评价 | 是否可合并 |
|---------|------|------|-----------|
| 90-100 | A+ | Excellent | ✅ 立即可合并 |
| 85-89 | A | Very Good | ✅ 可合并 |
| 80-84 | A- | Good | ⚠️ 建议改进后合并 |
| 75-79 | B+ | Acceptable | ⚠️ 需改进 |
| 70-74 | B | Fair | ❌ 必须改进 |
| <70 | C或以下 | Poor | ❌ 拒绝合并 |

### 及格线：85分

**为什么是85分？**
- 生产级标准：不能低于"Very Good"
- 允许小瑕疵：不要求完美100分
- 可量化：有明确的改进方向

### 真实案例：从78分提升到92分

**初始评分：78分**
```
代码质量：12/15 ✗ (Lint有3个warning)
文档质量：13/15 ✗ (只有1200行，缺400行)
测试覆盖：12/15 ✗ (覆盖率只有75%)
安全性：  15/15 ✅
性能：    10/10 ✅
可维护性：8/10  ✗ (缺日志)
需求符合：8/10  ✗ (边界条件未处理)
向后兼容：10/10 ✅
━━━━━━━━━━━━━━━━━━━━━━━━
总分 = 78/100 (B+) ❌ 未达标
```

**改进动作**：
1. 修复Lint warning → 代码质量 +3分
2. 补充文档到1600行 → 文档质量 +2分
3. 增加测试用例 → 测试覆盖 +3分
4. 添加日志模块 → 可维护性 +2分
5. 处理边界条件 → 需求符合 +2分

**最终评分：92分**
```
代码质量：15/15 ✅ (+3)
文档质量：15/15 ✅ (+2)
测试覆盖：15/15 ✅ (+3)
安全性：  15/15 ✅
性能：    10/10 ✅
可维护性：10/10 ✅ (+2)
需求符合：10/10 ✅ (+2)
向后兼容：10/10 ✅
━━━━━━━━━━━━━━━━━━━━━━━━
总分 = 92/100 (A) ✅ 可合并
```

### 如何查看你的质量分

**方法1：查看Review文档**
```bash
$ cat docs/REVIEW_*.md | grep "Quality Grade"
Quality Grade: A+ (Excellent)
Production Readiness: 100%
```

**方法2：运行质量检查脚本**
```bash
$ bash .claude/hooks/quality_gate.sh
🎯 质量评分: 92/100
✅ 质量检查通过
```

**方法3：P5阶段自动生成**
```
在P5审查阶段，code-reviewer Agent会：
1. 检查所有维度
2. 生成REVIEW_YYYYMMDD.md
3. 包含详细评分和改进建议
```
```

**放置位置**：SYSTEM_OVERVIEW_COMPLETE.md 第5节（质量保证机制）

**工作量**：2小时（整理评分标准+写案例）

---

## 📊 P2其他问题（简要说明）

### P2-2：端到端案例（预计3小时）
- 写一个完整的"登录功能"案例
- 从"你输入"到"完成交付"
- 包含失败→补齐→提分的过程

### P2-3：固定触发词（预计30分钟）
- 明确3个触发词："启动执行"、"开始实现"、"let's implement"
- 给出对照命令
- 集中在术语表

---

## 📊 P3问题（简要说明）

### P3-1：5层保障说明（预计1.5小时）
- 统一为4层（实际情况）
- 补充每层的失败动作和自救命令

### P3-2：并行规则详解（预计2小时）
- 补充并行/串行判定规则
- 添加冲突检测机制
- 写Dry-run示例

### P3-3：安全清单强调（预计1小时）
- 整理完整的安全检查项
- 强调最小权限原则
- 补充回滚机制文档

---

## 🎯 总工作量估算

| 优先级 | 任务 | 工作量 | 累计 |
|-------|------|-------|------|
| **P1** | ① 8-Phase DoD | 1h | 1h |
| **P1** | ③ Hook矩阵 | 2h | 3h |
| **P1** | ⑨ 术语统一 | 1.5h | 4.5h |
| **P2** | ⑥ 质量分计算 | 2h | 6.5h |
| **P2** | ⑧ 端到端案例 | 3h | 9.5h |
| **P2** | ⑦ 固定触发词 | 0.5h | 10h |
| **P3** | ② 5层说明 | 1.5h | 11.5h |
| **P3** | ④ 并行规则 | 2h | 13.5h |
| **P3** | ⑤ 安全清单 | 1h | 14.5h |

**总计**：约15小时（2个工作日）

**最小可行方案**（只做P1）：4.5小时

---

## 📋 下一步

你已经看完了**优先级和解决方案**。

**接下来你想：**
1. **看P2-P3的详细方案**（端到端案例、并行规则等）
2. **直接开始做P1**（我给你完整的可粘贴模块）
3. **先看整体总结**（所有方案汇总）

**输入你的选择（1/2/3）或直接说"继续"我给你下一阶段。**
