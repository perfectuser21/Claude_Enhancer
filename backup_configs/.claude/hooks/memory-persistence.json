{
  "name": "memory-persistence",
  "description": "å®žçŽ°æŠ—é—å¿˜æœºåˆ¶ï¼Œåœ¨ä¼šè¯åŽ‹ç¼©å‰ä¿å­˜å·¥ä½œæµçŠ¶æ€ï¼Œå¯åŠ¨æ—¶æ¢å¤",
  "event": "PreCompact",
  "matcher": {},
  "action": "#!/bin/bash\nset -euo pipefail\n\n# åˆ›å»ºæŒä¹…åŒ–ç›®å½•\nmkdir -p eval/memory\nMEMORY_FILE=\"eval/memory/workflow_context.json\"\nTIMESTAMP=$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\n\necho \"[$TIMESTAMP] Saving workflow context before compaction...\"\n\n# èŽ·å–å½“å‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚æžœå¯ç”¨ï¼‰\nCONTEXT_DATA=$(echo \"$CLAUDE_CONTEXT\" | jq -r '.' 2>/dev/null || echo '{}')\n\n# è¯»å–å½“å‰å·¥ä½œæµçŠ¶æ€\nWORKFLOW_STATE=\"{}\"\nif [[ -f \"eval/workflow_state/current.json\" ]]; then\n    WORKFLOW_STATE=$(cat \"eval/workflow_state/current.json\")\nfi\n\n# æ£€æŸ¥å½“å‰æ´»è·ƒçš„åŠŸèƒ½å¼€å‘\nCURRENT_FEATURE=\"\"\nFEATURE_STATUS=\"\"\nif [[ -d \"eval/markers\" ]]; then\n    CURRENT_FEATURE=$(find eval/markers -name \"*.active\" -exec basename {} .active \\; | head -1 || echo \"\")\n    if [[ -n \"$CURRENT_FEATURE\" ]]; then\n        FEATURE_STATUS=\"active\"\n    fi\nfi\n\n# æ£€æŸ¥æœ€è¿‘çš„ Git æäº¤\nRECENT_COMMITS=\"[]\"\nif command -v git >/dev/null 2>&1 && git rev-parse --git-dir >/dev/null 2>&1; then\n    RECENT_COMMITS=$(git log --oneline -5 --format='{\"hash\":\"%H\",\"message\":\"%s\",\"date\":\"%ai\"}' | jq -s '.' 2>/dev/null || echo \"[]\")\nfi\n\n# åˆ›å»ºå®Œæ•´çš„è®°å¿†å¿«ç…§\ncat > \"$MEMORY_FILE\" <<EOF\n{\n  \"saved_at\": \"$TIMESTAMP\",\n  \"session_type\": \"vibepilot_workflow\",\n  \"workflow_constraints\": {\n    \"must_use_subagents\": true,\n    \"sequence\": [\"spec-planner\", \"developer-coder\", \"test-runner\", \"code-reviewer\", \"commit-bot\", \"coach-qa\"],\n    \"developer_coder_only_writes\": true,\n    \"evidence_required\": [\"tests.json\", \"review.md\"],\n    \"self_eval_mandatory\": true\n  },\n  \"current_state\": $WORKFLOW_STATE,\n  \"active_feature\": {\n    \"name\": \"$CURRENT_FEATURE\",\n    \"status\": \"$FEATURE_STATUS\"\n  },\n  \"project_context\": {\n    \"type\": \"VibePilot Enhanced V2 Max\",\n    \"directory\": \"$(pwd)\",\n    \"recent_commits\": $RECENT_COMMITS\n  },\n  \"session_context\": $CONTEXT_DATA\n}\nEOF\n\necho \"âœ… å·¥ä½œæµä¸Šä¸‹æ–‡å·²ä¿å­˜åˆ° $MEMORY_FILE\"\necho \"ðŸ“‹ ä¿å­˜å†…å®¹ï¼šå·¥ä½œæµçº¦æŸã€å½“å‰çŠ¶æ€ã€æ´»è·ƒåŠŸèƒ½ã€é¡¹ç›®ä¸Šä¸‹æ–‡\"\n\n# è®°å½•ä¿å­˜æ—¥å¿—\necho \"[$TIMESTAMP] Workflow context saved successfully\" >> \"eval/logs/memory.log\"\n\nexit 0",
  "enabled": true,
  "timeout": 5000,
  "scope": "project"
}