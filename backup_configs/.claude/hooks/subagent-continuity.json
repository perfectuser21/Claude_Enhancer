{
  "name": "subagent-continuity", 
  "description": "ç¡®ä¿å­ä»£ç†å®ŒæˆåŽç»§ç»­å·¥ä½œæµï¼Œé˜²æ­¢å›žè½ä¸»çº¿ç¨‹",
  "event": "SubagentStop",
  "matcher": {
    "subagent": ["spec-planner", "developer-coder", "test-runner", "code-reviewer", "commit-bot", "coach-qa"]
  },
  "action": "#!/bin/bash\nset -euo pipefail\n\n# èŽ·å–å­ä»£ç†ä¿¡æ¯\nSUBAGENT_NAME=$(echo \"$CLAUDE_SUBAGENT_RESULT\" | jq -r '.subagent_name // \"unknown\"')\nSUBAGENT_STATUS=$(echo \"$CLAUDE_SUBAGENT_RESULT\" | jq -r '.status // \"unknown\"')\nSUBAGENT_OUTPUT=$(echo \"$CLAUDE_SUBAGENT_RESULT\" | jq -r '.output // \"\"')\n\n# åˆ›å»ºçŠ¶æ€è·Ÿè¸ªç›®å½•\nmkdir -p eval/workflow_state\nWORKFLOW_STATE=\"eval/workflow_state/current.json\"\nTIMESTAMP=$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\n\necho \"[$TIMESTAMP] Subagent $SUBAGENT_NAME completed with status: $SUBAGENT_STATUS\"\n\n# åˆ†æž SELF-EVAL è¾“å‡º\nOUTCOME=\"unknown\"\nCONFIDENCE=0\nNEXT_ACTION=\"unknown\"\n\nif echo \"$SUBAGENT_OUTPUT\" | grep -qA 10 \"## SELF-EVAL\"; then\n    OUTCOME=$(echo \"$SUBAGENT_OUTPUT\" | grep -A 10 \"## SELF-EVAL\" | grep \"Outcome:\" | cut -d':' -f2- | xargs || echo \"unknown\")\n    CONFIDENCE=$(echo \"$SUBAGENT_OUTPUT\" | grep -A 10 \"## SELF-EVAL\" | grep \"Confidence:\" | cut -d':' -f2- | tr -d '%' | xargs || echo \"0\")\n    NEXT_ACTION=$(echo \"$SUBAGENT_OUTPUT\" | grep -A 10 \"## SELF-EVAL\" | grep \"Next:\" | cut -d':' -f2- | xargs || echo \"unknown\")\nfi\n\n# å®šä¹‰æ ‡å‡†å·¥ä½œæµåºåˆ—\ndeclare -A WORKFLOW_SEQUENCE=(\n    [\"spec-planner\"]=\"developer-coder\"\n    [\"developer-coder\"]=\"test-runner\"\n    [\"test-runner\"]=\"code-reviewer\"\n    [\"code-reviewer\"]=\"commit-bot\"\n    [\"commit-bot\"]=\"coach-qa\"\n    [\"coach-qa\"]=\"complete\"\n)\n\n# æ›´æ–°å·¥ä½œæµçŠ¶æ€\ncat > \"$WORKFLOW_STATE\" <<EOF\n{\n  \"timestamp\": \"$TIMESTAMP\",\n  \"last_completed\": \"$SUBAGENT_NAME\",\n  \"outcome\": \"$OUTCOME\",\n  \"confidence\": $CONFIDENCE,\n  \"next_suggested\": \"$NEXT_ACTION\",\n  \"workflow_next\": \"${WORKFLOW_SEQUENCE[$SUBAGENT_NAME]:-complete}\"\n}\nEOF\n\n# å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨\nNEXT_SUBAGENT=\"${WORKFLOW_SEQUENCE[$SUBAGENT_NAME]:-}\"\n\necho \"ðŸ”„ å·¥ä½œæµçŠ¶æ€æ›´æ–°ï¼š$SUBAGENT_NAME -> $NEXT_SUBAGENT\"\n\ncase \"$SUBAGENT_NAME\" in\n    \"spec-planner\")\n        if [[ \"$OUTCOME\" == \"yes\" && $CONFIDENCE -gt 80 ]]; then\n            echo \"âœ… éœ€æ±‚åˆ†æžå®Œæˆï¼Œå»ºè®®ç»§ç»­ç¼–ç é˜¶æ®µ\"\n            echo \"ðŸ“‹ æç¤ºï¼šè¯·ç¡®è®¤ PRD åŽè°ƒç”¨ developer-coder å¼€å§‹å®žçŽ°\"\n        else\n            echo \"âš ï¸  éœ€æ±‚åˆ†æžå­˜åœ¨é—®é¢˜ï¼Œå»ºè®®é‡æ–°åˆ†æžæˆ–æ¾„æ¸…éœ€æ±‚\"\n        fi\n        ;;\n    \"developer-coder\")\n        if [[ \"$OUTCOME\" == \"yes\" && $CONFIDENCE -gt 70 ]]; then\n            echo \"âœ… ä»£ç å®žçŽ°å®Œæˆï¼Œè‡ªåŠ¨è¿›å…¥æµ‹è¯•é˜¶æ®µ\"\n            echo \"ðŸ§ª å»ºè®®ï¼šç«‹å³è°ƒç”¨ test-runner éªŒè¯ä»£ç è´¨é‡\"\n        else\n            echo \"âš ï¸  ä»£ç å®žçŽ°å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦reviewæˆ–é‡æž„\"\n        fi\n        ;;\n    \"test-runner\")\n        # æ£€æŸ¥æ˜¯å¦æœ‰æµ‹è¯•å¤±è´¥\n        if echo \"$SUBAGENT_OUTPUT\" | grep -q \"MUST FIX\\|FAILED\\|ERROR\"; then\n            echo \"âŒ æµ‹è¯•å‘çŽ°é—®é¢˜ï¼Œéœ€è¦ä¿®å¤åŽå†ç»§ç»­\"\n            echo \"ðŸ”§ å»ºè®®ï¼šè®© developer-coder ä¿®å¤é—®é¢˜åŽé‡æ–°æµ‹è¯•\"\n        elif [[ \"$OUTCOME\" == \"yes\" ]]; then\n            echo \"âœ… æµ‹è¯•é€šè¿‡ï¼Œè¿›å…¥ä»£ç å®¡æŸ¥é˜¶æ®µ\" \n            echo \"ðŸ‘€ å»ºè®®ï¼šè°ƒç”¨ code-reviewer è¿›è¡Œè´¨é‡å®¡æŸ¥\"\n        fi\n        ;;\n    \"code-reviewer\")\n        # æ£€æŸ¥æ˜¯å¦æœ‰ MUST FIX é—®é¢˜\n        if echo \"$SUBAGENT_OUTPUT\" | grep -q \"MUST FIX\"; then\n            echo \"âŒ ä»£ç å®¡æŸ¥å‘çŽ°å¿…é¡»ä¿®å¤çš„é—®é¢˜\"\n            echo \"ðŸ”§ å»ºè®®ï¼šè®© developer-coder ä¿®å¤åŽé‡æ–°å®¡æŸ¥\"\n        elif [[ \"$OUTCOME\" == \"yes\" ]]; then\n            echo \"âœ… ä»£ç å®¡æŸ¥é€šè¿‡ï¼Œå¯ä»¥æäº¤\"\n            echo \"ðŸ“ å»ºè®®ï¼šè°ƒç”¨ commit-bot æäº¤ä»£ç \"\n        fi\n        ;;\n    \"commit-bot\")\n        if [[ \"$OUTCOME\" == \"yes\" ]]; then\n            echo \"âœ… ä»£ç æäº¤å®Œæˆ\"\n            echo \"ðŸŽ“ å¯é€‰ï¼šè°ƒç”¨ coach-qa èŽ·å–æ”¹è¿›å»ºè®®\"\n        else\n            echo \"âš ï¸  ä»£ç æäº¤å¤±è´¥ï¼Œæ£€æŸ¥ Git çŠ¶æ€\"\n        fi\n        ;;\n    \"coach-qa\")\n        echo \"âœ… VibePilot å·¥ä½œæµå®Œæˆï¼\"\n        echo \"ðŸŽ‰ æ‰€æœ‰é˜¶æ®µå·²å®Œæˆï¼ŒåŠŸèƒ½å¼€å‘å®Œæ¯•\"\n        ;;\nesac\n\n# è®°å½•å®Œæˆæ—¥å¿—\necho \"[$TIMESTAMP] Workflow guidance provided for $SUBAGENT_NAME -> $NEXT_SUBAGENT\" >> \"eval/logs/workflow.log\"\n\nexit 0",
  "enabled": true,
  "timeout": 10000,
  "scope": "project"
}