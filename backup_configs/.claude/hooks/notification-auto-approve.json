{
  "name": "notification-auto-approve",
  "description": "自动处理权限通知，避免流程中断回落主线程",
  "event": "Notification",
  "matcher": {
    "type": ["tool_approval_request", "permission_request"]
  },
  "action": "#!/bin/bash\nset -euo pipefail\n\n# 获取通知内容\nNOTIFICATION_TYPE=$(echo \"$CLAUDE_NOTIFICATION\" | jq -r '.type // \"unknown\"')\nTOOL_NAME=$(echo \"$CLAUDE_NOTIFICATION\" | jq -r '.tool_name // \"\"')\nREQUEST_CONTENT=$(echo \"$CLAUDE_NOTIFICATION\" | jq -r '.content // \"\"')\n\n# 创建日志目录\nmkdir -p eval/logs\nLOG_FILE=\"eval/logs/auto_approvals.log\"\nTIMESTAMP=$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\n\necho \"[$TIMESTAMP] Notification received: $NOTIFICATION_TYPE for $TOOL_NAME\" >> \"$LOG_FILE\"\n\n# 定义自动批准的安全操作\nSAFE_TOOLS=(\n    \"Read\" \n    \"Grep\" \n    \"Glob\"\n    \"Task\"\n    \"WebSearch\"\n    \"WebFetch\"\n    \"mcp__ide__getDiagnostics\"\n)\n\n# 定义需要特殊处理的工具\nCONDITIONAL_TOOLS=(\n    \"Edit\"\n    \"Write\" \n    \"MultiEdit\"\n    \"Bash\"\n)\n\n# 自动批准安全工具\nfor tool in \"${SAFE_TOOLS[@]}\"; do\n    if [[ \"$TOOL_NAME\" == \"$tool\" ]]; then\n        echo \"[$TIMESTAMP] AUTO-APPROVED: Safe tool $TOOL_NAME\" >> \"$LOG_FILE\"\n        echo \"✅ 自动批准安全工具: $TOOL_NAME\"\n        echo '{\"action\": \"approve\", \"message\": \"Auto-approved safe operation\"}'\n        exit 0\n    fi\ndone\n\n# 条件批准：检查是否在 VibePilot 工作流中\nif [[ \"$NOTIFICATION_TYPE\" == \"tool_approval_request\" ]]; then\n    # 检查当前是否有 subagent 在工作\n    CURRENT_CONTEXT=$(echo \"$CLAUDE_NOTIFICATION\" | jq -r '.context // \"\"')\n    \n    if echo \"$CURRENT_CONTEXT\" | grep -qE \"(spec-planner|developer-coder|test-runner|code-reviewer|commit-bot|coach-qa)\"; then\n        echo \"[$TIMESTAMP] AUTO-APPROVED: Subagent workflow operation $TOOL_NAME\" >> \"$LOG_FILE\"\n        echo \"✅ 自动批准子代理工作流操作: $TOOL_NAME\"\n        echo '{\"action\": \"approve\", \"message\": \"Auto-approved subagent operation\"}'\n        exit 0\n    fi\n    \n    # 检查是否是在项目目录内的操作\n    if echo \"$REQUEST_CONTENT\" | grep -qE \"(/root/dev/Vibepilot_Kit|/home/xx/dev/Vibepilot_Kit)\"; then\n        echo \"[$TIMESTAMP] AUTO-APPROVED: Project directory operation $TOOL_NAME\" >> \"$LOG_FILE\"\n        echo \"✅ 自动批准项目内操作: $TOOL_NAME\"\n        echo '{\"action\": \"approve\", \"message\": \"Auto-approved project operation\"}'\n        exit 0\n    fi\nfi\n\n# 对于其他情况，记录但不自动处理\necho \"[$TIMESTAMP] MANUAL_REVIEW: $TOOL_NAME requires manual approval\" >> \"$LOG_FILE\"\necho \"⚠️  需要手动确认: $TOOL_NAME\"\necho '{\"action\": \"defer\", \"message\": \"Requires manual review\"}'\nexit 0",
  "enabled": true,
  "timeout": 5000,
  "scope": "project"
}