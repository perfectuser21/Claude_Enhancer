# Perfect21 Prometheus告警规则
groups:
  - name: perfect21.api
    rules:
      # API服务健康状态
      - alert: Perfect21APIDown
        expr: up{job="perfect21-api"} == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Perfect21 API服务下线"
          description: "Perfect21 API服务在过去30秒内无法访问"

      # API响应时间过高
      - alert: Perfect21HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="perfect21-api"}[5m])) > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Perfect21 API响应时间过高"
          description: "Perfect21 API 95百分位响应时间超过2秒，当前值: {{ $value }}秒"

      # API错误率过高
      - alert: Perfect21HighErrorRate
        expr: rate(http_requests_total{job="perfect21-api",status=~"5.."}[5m]) / rate(http_requests_total{job="perfect21-api"}[5m]) > 0.05
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Perfect21 API错误率过高"
          description: "Perfect21 API错误率超过5%，当前值: {{ $value | humanizePercentage }}"

      # CPU使用率过高
      - alert: Perfect21HighCPUUsage
        expr: system_cpu_percent{job="perfect21-api"} > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Perfect21 CPU使用率过高"
          description: "Perfect21服务CPU使用率超过80%，当前值: {{ $value }}%"

      # 内存使用率过高
      - alert: Perfect21HighMemoryUsage
        expr: system_memory_percent{job="perfect21-api"} > 85
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Perfect21内存使用率过高"
          description: "Perfect21服务内存使用率超过85%，当前值: {{ $value }}%"

  - name: perfect21.database
    rules:
      # 数据库连接数过高
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends{job="postgres"} > 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL连接数过高"
          description: "PostgreSQL活跃连接数超过80，当前值: {{ $value }}"

      # 数据库查询时间过长
      - alert: PostgreSQLSlowQueries
        expr: pg_stat_activity_max_tx_duration{job="postgres"} > 300
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL查询时间过长"
          description: "PostgreSQL存在超过5分钟的长查询"

  - name: perfect21.git-workflow
    rules:
      # Git Hook失败率过高
      - alert: GitHookHighFailureRate
        expr: rate(git_hook_executions_failed_total[5m]) / rate(git_hook_executions_total[5m]) > 0.10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Git Hook失败率过高"
          description: "Git Hook失败率超过10%，可能影响代码质量"

      # Agent执行时间过长
      - alert: AgentExecutionTimeout
        expr: histogram_quantile(0.95, rate(agent_execution_duration_seconds_bucket[5m])) > 600
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Agent执行时间过长"
          description: "95%的Agent执行时间超过10分钟"

  - name: perfect21.security
    rules:
      # 认证失败率过高
      - alert: HighAuthenticationFailures
        expr: rate(auth_failures_total[5m]) > 10
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "认证失败率过高"
          description: "每分钟认证失败次数超过10次，可能存在暴力破解攻击"

      # 访问限流触发过多
      - alert: HighRateLimitHits
        expr: rate(rate_limit_hits_total[5m]) > 50
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "访问限流触发过多"
          description: "访问限流触发频率过高，可能影响正常用户访问"

  - name: perfect21.disk-space
    rules:
      # 磁盘空间不足
      - alert: LowDiskSpace
        expr: (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "磁盘空间不足"
          description: "磁盘使用率超过85%，剩余空间: {{ $value | humanizePercentage }}"

      # 日志文件增长过快
      - alert: LogGrowthTooFast
        expr: increase(perfect21_log_size_bytes[1h]) > 100000000  # 100MB per hour
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "日志文件增长过快"
          description: "日志文件每小时增长超过100MB，可能存在异常"