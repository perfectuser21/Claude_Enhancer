# Claude Enhancer 6.2 - ä¸“ä¸šçº§ç›‘æ§é…ç½®
# å…¨é¢çš„ç›‘æ§ã€å‘Šè­¦ã€ä»ªè¡¨æ¿é…ç½®

monitoring:
  service_name: "claude-enhancer-6.2"
  version: "6.2.0"
  environment: "production"  # production, staging, development

  # =================================
  # 1. æ€§èƒ½æŒ‡æ ‡ç›‘æ§é…ç½®
  # =================================
  metrics:
    collection_interval: 10  # ç§’
    retention_period: "7d"   # 7å¤©æ•°æ®ä¿ç•™
    export_interval: 60      # å¯¼å‡ºé—´éš”60ç§’

    # Prometheuså…¼å®¹é…ç½®
    prometheus:
      enabled: true
      port: 9090
      endpoint: "/metrics"
      format: "prometheus"

    # è‡ªå®šä¹‰æŒ‡æ ‡é…ç½®
    custom_metrics:
      # ä¸šåŠ¡æŒ‡æ ‡
      business:
        - name: "auth_requests_total"
          type: "counter"
          help: "è®¤è¯è¯·æ±‚æ€»æ•°"
          labels: ["method", "endpoint", "status"]

        - name: "user_sessions_active"
          type: "gauge"
          help: "æ´»è·ƒç”¨æˆ·ä¼šè¯æ•°"

        - name: "auth_response_time"
          type: "histogram"
          help: "è®¤è¯å“åº”æ—¶é—´åˆ†å¸ƒ"
          buckets: [0.01, 0.05, 0.1, 0.5, 1.0, 2.0, 5.0]

        - name: "password_strength_score"
          type: "histogram"
          help: "å¯†ç å¼ºåº¦è¯„åˆ†åˆ†å¸ƒ"
          buckets: [20, 40, 60, 80, 100]

        - name: "mfa_success_rate"
          type: "gauge"
          help: "å¤šå› å­è®¤è¯æˆåŠŸç‡"

      # ç³»ç»ŸæŒ‡æ ‡
      system:
        - name: "claude_enhancer_cpu_usage"
          type: "gauge"
          help: "CPUä½¿ç”¨ç‡"

        - name: "claude_enhancer_memory_usage"
          type: "gauge"
          help: "å†…å­˜ä½¿ç”¨ç‡"

        - name: "claude_enhancer_disk_usage"
          type: "gauge"
          help: "ç£ç›˜ä½¿ç”¨ç‡"

        - name: "database_connections"
          type: "gauge"
          help: "æ•°æ®åº“è¿æ¥æ•°"

        - name: "cache_hit_ratio"
          type: "gauge"
          help: "ç¼“å­˜å‘½ä¸­ç‡"

      # æ€§èƒ½æŒ‡æ ‡
      performance:
        - name: "request_duration_seconds"
          type: "histogram"
          help: "è¯·æ±‚å¤„ç†æ—¶é—´"
          buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]

        - name: "queue_size"
          type: "gauge"
          help: "é˜Ÿåˆ—å¤§å°"

        - name: "worker_pool_utilization"
          type: "gauge"
          help: "å·¥ä½œçº¿ç¨‹æ± åˆ©ç”¨ç‡"

  # =================================
  # 2. æ—¥å¿—èšåˆé…ç½®
  # =================================
  logging:
    # ELK Stacké…ç½®
    elasticsearch:
      enabled: true
      hosts: ["localhost:9200"]
      index_template: "claude-enhancer-5.1-{date}"
      max_retries: 3

    # æ—¥å¿—çº§åˆ«é…ç½®
    levels:
      root: "INFO"
      claude_enhancer: "DEBUG"
      auth_service: "INFO"
      database: "WARNING"
      performance: "DEBUG"

    # ç»“æ„åŒ–æ—¥å¿—é…ç½®
    structured_logging:
      enabled: true
      format: "json"
      fields:
        service: "claude-enhancer-5.1"
        version: "5.1.0"
        environment: "${ENVIRONMENT}"
        host: "${HOSTNAME}"

    # æ—¥å¿—é‡‡æ ·é…ç½®
    sampling:
      enabled: true
      rate: 1.0  # 100%é‡‡æ ·ï¼ˆç”Ÿäº§ç¯å¢ƒå¯è°ƒæ•´ï¼‰

    # æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
    filters:
      - field: "password"
        action: "mask"
      - field: "token"
        action: "mask"
      - field: "api_key"
        action: "remove"

  # =================================
  # 3. å‘Šè­¦è§„åˆ™é…ç½®
  # =================================
  alerts:
    # å¯ç”¨æ€§å‘Šè­¦
    availability:
      - name: "service_down"
        metric: "up"
        condition: "== 0"
        duration: "2m"
        severity: "critical"
        message: "Claude Enhancer 5.1æœåŠ¡ä¸‹çº¿"
        runbook: "https://wiki.company.com/runbooks/service-down"

      - name: "high_error_rate"
        metric: "error_rate"
        condition: "> 0.05"  # 5%
        duration: "5m"
        severity: "warning"
        message: "é”™è¯¯ç‡è¿‡é«˜: {{value}}%"

      - name: "auth_service_failure"
        metric: "auth_requests_total{status='500'}"
        condition: "> 10"
        duration: "3m"
        severity: "error"
        message: "è®¤è¯æœåŠ¡å¤§é‡å¤±è´¥è¯·æ±‚"

    # æ€§èƒ½å‘Šè­¦
    performance:
      - name: "high_response_time"
        metric: "request_duration_seconds_p95"
        condition: "> 1.0"  # 1ç§’
        duration: "10m"
        severity: "warning"
        message: "å“åº”æ—¶é—´è¿‡é«˜: {{value}}ç§’"

      - name: "cache_hit_rate_low"
        metric: "cache_hit_ratio"
        condition: "< 0.8"  # 80%
        duration: "15m"
        severity: "warning"
        message: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½: {{value}}%"

      - name: "queue_size_high"
        metric: "queue_size"
        condition: "> 1000"
        duration: "5m"
        severity: "error"
        message: "é˜Ÿåˆ—ç§¯å‹ä¸¥é‡: {{value}}ä¸ªä»»åŠ¡"

    # èµ„æºå‘Šè­¦
    resources:
      - name: "cpu_usage_high"
        metric: "claude_enhancer_cpu_usage"
        condition: "> 80"
        duration: "15m"
        severity: "warning"
        message: "CPUä½¿ç”¨ç‡è¿‡é«˜: {{value}}%"

      - name: "memory_usage_critical"
        metric: "claude_enhancer_memory_usage"
        condition: "> 90"
        duration: "10m"
        severity: "critical"
        message: "å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ°ä¸´ç•Œå€¼: {{value}}%"

      - name: "disk_usage_high"
        metric: "claude_enhancer_disk_usage"
        condition: "> 85"
        duration: "30m"
        severity: "warning"
        message: "ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: {{value}}%"

      - name: "database_connections_high"
        metric: "database_connections"
        condition: "> 80"
        duration: "10m"
        severity: "warning"
        message: "æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜: {{value}}"

    # å®‰å…¨å‘Šè­¦
    security:
      - name: "failed_auth_attempts"
        metric: "auth_requests_total{status='401'}"
        condition: "> 50"
        duration: "5m"
        severity: "warning"
        message: "å¼‚å¸¸è®¤è¯å¤±è´¥å°è¯•: {{value}}æ¬¡"

      - name: "suspicious_login_pattern"
        metric: "auth_requests_total"
        condition: "rate > 100"  # æ¯ç§’è¶…è¿‡100æ¬¡
        duration: "2m"
        severity: "error"
        message: "å¯ç–‘ç™»å½•æ¨¡å¼æ£€æµ‹"

    # ä¸šåŠ¡å‘Šè­¦
    business:
      - name: "user_registration_spike"
        metric: "user_registrations_total"
        condition: "rate > 10"  # æ¯ç§’è¶…è¿‡10ä¸ªæ³¨å†Œ
        duration: "5m"
        severity: "info"
        message: "ç”¨æˆ·æ³¨å†Œé‡æ¿€å¢"

      - name: "mfa_failure_rate_high"
        metric: "mfa_success_rate"
        condition: "< 0.9"  # 90%
        duration: "10m"
        severity: "warning"
        message: "å¤šå› å­è®¤è¯æˆåŠŸç‡è¿‡ä½"

  # =================================
  # 4. å‘Šè­¦é€šçŸ¥é…ç½®
  # =================================
  notifications:
    channels:
      # Slacké€šçŸ¥
      slack:
        enabled: true
        webhook_url: "${SLACK_WEBHOOK_URL}"
        channels:
          critical: "#incidents"
          error: "#alerts"
          warning: "#monitoring"
          info: "#notifications"
        template: |
          ğŸš¨ *Claude Enhancer 5.1 Alert*

          *Alert:* {{alert_name}}
          *Severity:* {{severity}}
          *Message:* {{message}}
          *Time:* {{timestamp}}
          *Runbook:* {{runbook}}

      # é‚®ä»¶é€šçŸ¥
      email:
        enabled: true
        smtp_server: "${SMTP_SERVER}"
        smtp_port: 587
        username: "${SMTP_USERNAME}"
        password: "${SMTP_PASSWORD}"
        recipients:
          critical: ["oncall@company.com", "tech-lead@company.com"]
          error: ["dev-team@company.com"]
          warning: ["monitoring@company.com"]
        template: |
          Subject: [{{severity|upper}}] Claude Enhancer 5.1 - {{alert_name}}

          Alert Details:
          - Service: Claude Enhancer 5.1
          - Alert Name: {{alert_name}}
          - Severity: {{severity}}
          - Message: {{message}}
          - Timestamp: {{timestamp}}
          - Runbook: {{runbook}}

      # PagerDutyé›†æˆ
      pagerduty:
        enabled: false
        routing_key: "${PAGERDUTY_ROUTING_KEY}"
        severity_mapping:
          critical: "critical"
          error: "error"
          warning: "warning"
          info: "info"

  # =================================
  # 5. ç›‘æ§ä»ªè¡¨æ¿é…ç½®
  # =================================
  dashboards:
    # Grafanaé…ç½®
    grafana:
      enabled: true
      url: "http://localhost:3000"
      datasources:
        - name: "claude-enhancer-prometheus"
          type: "prometheus"
          url: "http://localhost:9090"
        - name: "claude-enhancer-elasticsearch"
          type: "elasticsearch"
          url: "http://localhost:9200"

    # å†…ç½®Webä»ªè¡¨æ¿
    web_dashboard:
      enabled: true
      port: 8080
      path: "/dashboard"
      refresh_interval: 3  # ç§’

    # ä»ªè¡¨æ¿é¢æ¿é…ç½®
    panels:
      # ç³»ç»Ÿæ¦‚è§ˆé¢æ¿
      system_overview:
        - title: "ç³»ç»Ÿå¥åº·çŠ¶æ€"
          type: "stat"
          metrics: ["overall_health", "uptime_seconds"]

        - title: "è¯·æ±‚é€Ÿç‡"
          type: "graph"
          metrics: ["auth_requests_total"]
          time_range: "1h"

        - title: "å“åº”æ—¶é—´åˆ†å¸ƒ"
          type: "histogram"
          metrics: ["auth_response_time"]

        - title: "é”™è¯¯ç‡è¶‹åŠ¿"
          type: "graph"
          metrics: ["error_rate"]
          thresholds: [0.01, 0.05]

      # æ€§èƒ½ç›‘æ§é¢æ¿
      performance:
        - title: "CPUä½¿ç”¨ç‡"
          type: "gauge"
          metrics: ["claude_enhancer_cpu_usage"]
          thresholds: [60, 80]

        - title: "å†…å­˜ä½¿ç”¨ç‡"
          type: "gauge"
          metrics: ["claude_enhancer_memory_usage"]
          thresholds: [70, 90]

        - title: "ç£ç›˜I/O"
          type: "graph"
          metrics: ["disk_read_bytes", "disk_write_bytes"]

        - title: "ç½‘ç»œæµé‡"
          type: "graph"
          metrics: ["network_bytes_sent", "network_bytes_recv"]

      # æ•°æ®åº“ç›‘æ§é¢æ¿
      database:
        - title: "æ•°æ®åº“è¿æ¥æ± "
          type: "graph"
          metrics: ["database_connections", "database_pool_size"]

        - title: "æŸ¥è¯¢æ€§èƒ½"
          type: "histogram"
          metrics: ["database_query_duration"]

        - title: "æ…¢æŸ¥è¯¢æ•°é‡"
          type: "stat"
          metrics: ["database_slow_queries"]

      # ç¼“å­˜ç›‘æ§é¢æ¿
      cache:
        - title: "ç¼“å­˜å‘½ä¸­ç‡"
          type: "gauge"
          metrics: ["cache_hit_ratio"]
          thresholds: [0.8, 0.95]

        - title: "ç¼“å­˜å¤§å°"
          type: "graph"
          metrics: ["cache_size_bytes"]

        - title: "ç¼“å­˜æ“ä½œ"
          type: "graph"
          metrics: ["cache_gets_total", "cache_sets_total"]

      # è®¤è¯æœåŠ¡é¢æ¿
      authentication:
        - title: "è®¤è¯æˆåŠŸç‡"
          type: "gauge"
          metrics: ["auth_success_rate"]
          thresholds: [0.95, 0.99]

        - title: "æ´»è·ƒä¼šè¯æ•°"
          type: "stat"
          metrics: ["user_sessions_active"]

        - title: "å¯†ç å¼ºåº¦åˆ†å¸ƒ"
          type: "histogram"
          metrics: ["password_strength_score"]

        - title: "MFAä½¿ç”¨ç‡"
          type: "pie"
          metrics: ["mfa_enabled_users", "mfa_disabled_users"]

  # =================================
  # 6. SLA/SLIç›‘æ§é…ç½®
  # =================================
  sla:
    # å¯ç”¨æ€§SLA
    availability:
      target: 99.9  # 99.9%
      window: "30d"
      measurement: "uptime_percentage"

    # å“åº”æ—¶é—´SLA
    response_time:
      target: 200  # 200ms
      percentile: 95
      window: "7d"
      measurement: "response_time_p95"

    # é”™è¯¯ç‡SLA
    error_rate:
      target: 0.1  # 0.1%
      window: "24h"
      measurement: "error_percentage"

    # SLIè®¡ç®—é…ç½®
    sli_calculations:
      availability:
        good_events: "sum(up)"
        total_events: "count(up)"

      latency:
        good_events: "sum(rate(request_duration_seconds_bucket{le='0.2'}[5m]))"
        total_events: "sum(rate(request_duration_seconds_count[5m]))"

      error_rate:
        good_events: "sum(rate(auth_requests_total{status!~'5..'}[5m]))"
        total_events: "sum(rate(auth_requests_total[5m]))"

  # =================================
  # 7. å¼‚å¸¸æ£€æµ‹é…ç½®
  # =================================
  anomaly_detection:
    enabled: true

    # åŸºäºç»Ÿè®¡çš„å¼‚å¸¸æ£€æµ‹
    statistical:
      - metric: "auth_requests_total"
        method: "z_score"
        threshold: 3.0  # 3ä¸ªæ ‡å‡†å·®
        window: "1h"

      - metric: "auth_response_time"
        method: "iqr"  # å››åˆ†ä½æ•°æ³•
        threshold: 1.5
        window: "30m"

    # åŸºäºæœºå™¨å­¦ä¹ çš„å¼‚å¸¸æ£€æµ‹
    ml_based:
      - metric: "user_behavior_pattern"
        algorithm: "isolation_forest"
        contamination: 0.1
        features: ["login_time", "login_location", "device_type"]

    # è¶‹åŠ¿åˆ†æ
    trend_analysis:
      - metric: "memory_usage"
        method: "linear_regression"
        predict_horizon: "6h"
        alert_threshold: 90  # é¢„æµ‹å€¼è¶…è¿‡90%æ—¶å‘Šè­¦

  # =================================
  # 8. å¥åº·æ£€æŸ¥é…ç½®
  # =================================
  health_checks:
    # æœåŠ¡å¥åº·æ£€æŸ¥
    services:
      - name: "auth-service"
        url: "http://localhost:8000/health"
        interval: 30  # ç§’
        timeout: 10
        expected_status: 200

      - name: "database"
        type: "database"
        connection_string: "${DATABASE_URL}"
        query: "SELECT 1"
        interval: 60
        timeout: 5

      - name: "cache"
        type: "redis"
        connection_string: "${REDIS_URL}"
        command: "ping"
        interval: 30
        timeout: 3

    # ç«¯åˆ°ç«¯å¥åº·æ£€æŸ¥
    e2e_checks:
      - name: "user_registration_flow"
        type: "synthetic"
        script: "/scripts/test_user_registration.py"
        interval: 300  # 5åˆ†é’Ÿ
        timeout: 60

      - name: "user_login_flow"
        type: "synthetic"
        script: "/scripts/test_user_login.py"
        interval: 180  # 3åˆ†é’Ÿ
        timeout: 30

  # =================================
  # 9. æ€§èƒ½åŸºå‡†é…ç½®
  # =================================
  benchmarks:
    # æ€§èƒ½åŸºå‡†æµ‹è¯•
    load_testing:
      - name: "auth_endpoint_load"
        target: "http://localhost:8000/api/v1/auth/login"
        method: "POST"
        concurrent_users: 100
        duration: "5m"
        ramp_up: "1m"

      - name: "registration_endpoint_load"
        target: "http://localhost:8000/api/v1/auth/register"
        method: "POST"
        concurrent_users: 50
        duration: "3m"
        ramp_up: "30s"

    # æ€§èƒ½å›å½’æµ‹è¯•
    regression_testing:
      baseline_file: "/benchmarks/baseline_performance.json"
      threshold_degradation: 10  # 10%æ€§èƒ½ä¸‹é™è§¦å‘å‘Šè­¦

    # å®¹é‡è§„åˆ’
    capacity_planning:
      target_growth: 20  # 20%å¹´å¢é•¿
      projection_period: "12m"
      resource_thresholds:
        cpu: 70
        memory: 75
        disk: 80

# é…ç½®éªŒè¯è§„åˆ™
validation:
  required_fields:
    - "monitoring.service_name"
    - "monitoring.metrics.prometheus.enabled"
    - "monitoring.alerts.availability"
    - "monitoring.notifications.channels"

  field_constraints:
    "monitoring.metrics.collection_interval":
      min: 1
      max: 300
    "monitoring.alerts.*.duration":
      pattern: "^[0-9]+[smhd]$"