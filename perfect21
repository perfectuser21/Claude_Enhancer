#!/usr/bin/env python3
"""
Perfect21 - ä¸»ç¨‹åºå…¥å£
åŸºäºclaude-code-unified-agentsçš„æ™ºèƒ½å¼€å‘åŠ©æ‰‹
"""

import os
import sys
import asyncio
import argparse

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.append(os.path.dirname(__file__))

# ç›´æ¥ä½¿ç”¨ç°æœ‰çš„Perfect21æ ¸å¿ƒç³»ç»Ÿ
from main.perfect21 import Perfect21

class Perfect21CLI:
    """Perfect21å‘½ä»¤è¡Œæ¥å£"""

    def __init__(self):
        self.perfect21 = Perfect21()
        self.task_counter = 0

    def execute_task(self, task_description: str, **options):
        """æ‰§è¡Œå¼€å‘ä»»åŠ¡ - ç›®å‰è°ƒç”¨ç°æœ‰CLIç³»ç»Ÿ"""
        print(f"ğŸ“ ä»»åŠ¡: {task_description}")
        print("âš¡ æ­£åœ¨åˆ†æä»»åŠ¡...")

        # TODO: é›†æˆclaude-code-unified-agents
        # ç›®å‰è¿”å›åˆ†æç»“æœ
        self.task_counter += 1

        result = {
            'success': True,
            'task_id': f'task_{self.task_counter}',
            'output': f"""ä»»åŠ¡å·²æ¥æ”¶å¹¶åˆ†æ: {task_description}

ğŸ¯ ä»»åŠ¡åˆ†æ:
- ä»»åŠ¡ç±»å‹: å¼€å‘ä»»åŠ¡
- å¤æ‚åº¦: ä¸­ç­‰
- å»ºè®®Agent: orchestrator â†’ project-manager â†’ ç›¸åº”ä¸“ä¸šAgent

âš ï¸  å½“å‰çŠ¶æ€: ç­‰å¾…claude-code-unified-agentsé›†æˆå®Œæˆ
ğŸ“‹ å»ºè®®: ä½¿ç”¨ç°æœ‰CLIè¿›è¡ŒGitå·¥ä½œæµæ“ä½œï¼š
    python3 main/cli.py hooks status
    python3 main/cli.py workflow list""",
            'routing_info': {
                'suggested_agents': ['orchestrator', 'project-manager'],
                'task_type': 'development',
                'complexity': 'medium'
            }
        }

        if result['success']:
            print("âœ… ä»»åŠ¡åˆ†æå®Œæˆ!")
            print(f"ğŸ“„ åˆ†æç»“æœ:\n{result['output']}")
        else:
            print("âŒ ä»»åŠ¡åˆ†æå¤±è´¥!")
            if result.get('error'):
                print(f"ğŸš¨ é”™è¯¯: {result['error']}")

        return result

    def show_status(self):
        """æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€"""
        print("ğŸ“Š Perfect21ç³»ç»ŸçŠ¶æ€")
        print("=" * 50)

        # è·å–Perfect21æ ¸å¿ƒçŠ¶æ€
        status = self.perfect21.status()

        if status['success']:
            print("âœ… Perfect21æ ¸å¿ƒ: è¿è¡Œæ­£å¸¸")

            # æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
            project = status['status']['project']
            print(f"ğŸ“ Gitä»“åº“: {'âœ…' if project['is_git_repo'] else 'âŒ'}")
            print(f"ğŸŒ¿ å½“å‰åˆ†æ”¯: {project.get('current_branch', 'æœªçŸ¥')}")

            # æ˜¾ç¤ºAgentçŠ¶æ€
            p21_info = status['status']['perfect21']
            print(f"ğŸ¤– æ ¸å¿ƒAgent: {'âœ… å¯ç”¨' if p21_info['core_agents_available'] else 'âŒ ä¸å¯ç”¨'}")
            print(f"ğŸ“Š Agentæ•°é‡: {p21_info['agent_count']}")

        else:
            print(f"âŒ Perfect21æ ¸å¿ƒ: {status.get('error', 'çŠ¶æ€å¼‚å¸¸')}")

        print(f"ğŸ”¢ å¤„ç†ä»»åŠ¡æ•°: {self.task_counter}")
        print(f"ğŸ  å·¥ä½œç›®å½•: {os.getcwd()}")

    def chat(self, message: str):
        """èŠå¤©æ¨¡å¼"""
        # ç®€å•åˆ¤æ–­æ˜¯å¦ä¸ºå¼€å‘ä»»åŠ¡
        development_keywords = ['åˆ›å»º', 'å¼€å‘', 'å®ç°', 'æ„å»º', 'è®¾è®¡', 'ä¼˜åŒ–', 'é‡æ„', 'ä¿®å¤']
        is_development_task = any(keyword in message for keyword in development_keywords)

        if is_development_task:
            return self.execute_task(message)
        else:
            print(f"ğŸ’¬ æ‚¨å¥½ï¼æˆ‘æ˜¯Perfect21æ™ºèƒ½å¼€å‘åŠ©æ‰‹ã€‚")
            print(f"ğŸ“ æ‚¨çš„æ¶ˆæ¯: {message}")
            print(f"ğŸ”§ å¦‚æœæ‚¨éœ€è¦å¼€å‘å¸®åŠ©ï¼Œè¯·ä½¿ç”¨å¦‚'åˆ›å»º'ã€'å¼€å‘'ã€'å®ç°'ç­‰å…³é”®è¯æè¿°æ‚¨çš„éœ€æ±‚ã€‚")
            print(f"ğŸ“‹ æˆ–è€…ä½¿ç”¨ './vp.py --status' æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€")

def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(description='Perfect21 - æ™ºèƒ½å¼€å‘åŠ©æ‰‹')
    parser.add_argument('task', nargs='?', help='å¼€å‘ä»»åŠ¡æè¿°')
    parser.add_argument('--status', action='store_true', help='æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€')
    parser.add_argument('--chat', action='store_true', help='èŠå¤©æ¨¡å¼')
    parser.add_argument('--workspace', help='æŒ‡å®šå·¥ä½œç©ºé—´')
    parser.add_argument('--timeout', type=int, default=300, help='ä»»åŠ¡è¶…æ—¶æ—¶é—´(ç§’)')

    args = parser.parse_args()

    cli = Perfect21CLI()

    try:
        if args.status:
            cli.show_status()
        elif args.chat:
            print("ğŸ’¬ Perfect21èŠå¤©æ¨¡å¼ (è¾“å…¥'exit'é€€å‡º)")
            while True:
                try:
                    message = input("\nğŸ¤– æ‚¨: ")
                    if message.lower() in ['exit', 'quit', 'é€€å‡º']:
                        break
                    cli.chat(message)
                except KeyboardInterrupt:
                    break
        elif args.task:
            options = {
                'workspace_id': args.workspace,
                'timeout': args.timeout
            }
            cli.execute_task(args.task, **options)
        else:
            print("ğŸ¯ Perfect21 - æ™ºèƒ½å¼€å‘åŠ©æ‰‹")
            print("=" * 50)
            print("\nğŸš€ åŸºäºclaude-code-unified-agentsçš„56ä¸ªä¸“ä¸šAgent")
            print("âš¡ æ™ºèƒ½è·¯ç”±ã€å¹¶è¡Œå¤„ç†ã€è´¨é‡ä¼˜å…ˆ")
            print("\nä½¿ç”¨æ–¹æ³•:")
            print("  ./vp.py 'å¼€å‘ä»»åŠ¡æè¿°'          # æ‰§è¡Œå¼€å‘ä»»åŠ¡")
            print("  ./vp.py --status              # æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€")
            print("  ./vp.py --chat                # èŠå¤©æ¨¡å¼")
            print("\nç¤ºä¾‹:")
            print("  ./vp.py 'åˆ›å»ºç”¨æˆ·ç™»å½•APIæ¥å£'")
            print("  ./vp.py 'é‡æ„æ”¯ä»˜ç³»ç»Ÿæ¨¡å—'")
            print("  ./vp.py 'ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½'")
            print("\nğŸ”§ Gitå·¥ä½œæµç®¡ç†:")
            print("  python3 main/cli.py hooks status      # æŸ¥çœ‹Gité’©å­çŠ¶æ€")
            print("  python3 main/cli.py workflow list     # æŸ¥çœ‹å·¥ä½œæµæ“ä½œ")
            print("  python3 main/cli.py status            # è¯¦ç»†ç³»ç»ŸçŠ¶æ€")

    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        if '--debug' in sys.argv:
            import traceback
            traceback.print_exc()
        sys.exit(1)

if __name__ == '__main__':
    main()