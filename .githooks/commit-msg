#!/bin/bash

# === è‡ªåŠ¨æ¨¡å¼æ”¯æŒ ===
if [[ -f "$HOME/dev/Claude Enhancer 5.0/.claude/auto.config" ]]; then
    source "$HOME/dev/Claude Enhancer 5.0/.claude/auto.config"
fi

# å¦‚æœæ˜¯è‡ªåŠ¨æ¨¡å¼ï¼Œè·³è¿‡æ‰€æœ‰äº¤äº’
if [[ "$GIT_HOOKS_AUTO_MODE" == "true" ]]; then
    # è¦†ç›–readå‘½ä»¤
    read() {
        if [[ "$1" == "-r" ]]; then
            shift
            eval "$1='y'"
        else
            eval "$1='y'"
        fi
        return 0
    }
fi
# === è‡ªåŠ¨æ¨¡å¼ç»“æŸ ===

# Claude Enhancer 5.0 - Commit Message Hook with Workflow/Phase validation
commit_file="$1"

set -euo pipefail

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é˜¶æ®µ0: æƒé™è‡ªæ£€æœºåˆ¶ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
HOOKS_DIR="$PROJECT_ROOT/.git/hooks"
LOG_DIR="$PROJECT_ROOT/.workflow/logs"
mkdir -p "$LOG_DIR"

# æƒé™è‡ªæ£€å‡½æ•°
check_self_permission() {
    # æ£€æŸ¥è‡ªèº«æ˜¯å¦å¯æ‰§è¡Œ
    if [ ! -x "$0" ]; then
        echo "ğŸš¨ CRITICAL: commit-msg hook å¤±å»æ‰§è¡Œæƒé™ï¼"
        echo "ğŸ”§ å°è¯•ä¿®å¤..."
        chmod +x "$0" 2>/dev/null || {
            echo "âŒ æ— æ³•ä¿®å¤hookæƒé™ï¼Œæäº¤è¢«é˜»æ­¢"
            exit 1
        }
        echo "âœ… hookæƒé™å·²ä¿®å¤"
    fi

    # æ£€æŸ¥å…¶ä»–å…³é”® hooks
    local critical_hooks=("pre-commit" "pre-push")
    for hook in "${critical_hooks[@]}"; do
        local hook_path="$HOOKS_DIR/$hook"
        if [ -f "$hook_path" ] && [ ! -x "$hook_path" ]; then
            echo "ğŸš¨ WARNING: Hook $hook å¤±å»æ‰§è¡Œæƒé™"
            # è®°å½•å‘Šè­¦æ—¥å¿—
            echo "$(date +'%Y-%m-%d %H:%M:%S') [ALERT] Hook $hook missing execute permission" >> "$LOG_DIR/permission_alerts.log"

            # å°è¯•ä¿®å¤
            if [ -f "$PROJECT_ROOT/scripts/fix_permissions.sh" ]; then
                echo "ğŸ”§ å°è¯•ä¿®å¤æ‰€æœ‰hooksæƒé™..."
                bash "$PROJECT_ROOT/scripts/fix_permissions.sh" --quiet
            fi
        fi
    done
}

# æ‰§è¡Œæƒé™è‡ªæ£€
check_self_permission

# æ·»åŠ æ—¥å¿—æ¢é’ˆ
echo "$(date +'%F %T') [commit-msg] triggered with message: $(cat "$1" | head -1)" >> "$LOG_DIR/hooks.log"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
PHASE_FILE="$PROJECT_ROOT/.phase/current"

if [ ! -f "$commit_file" ]; then
    echo -e "${RED}âŒ æäº¤ä¿¡æ¯æ–‡ä»¶ä¸å­˜åœ¨${NC}"
    exit 1
fi

message=$(head -n 1 "$commit_file")

# è·å–å½“å‰åˆ†æ”¯
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å·¥ä½œæµPhaseæ£€æŸ¥ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ - å¼ºåˆ¶æ‰§è¡Œï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${CYAN}[WORKFLOW VALIDATION]${NC}"

# æ£€æŸ¥Phaseæ–‡ä»¶ï¼ˆå¼ºåˆ¶è¦æ±‚ï¼‰
if [[ ! -f "$PHASE_FILE" ]]; then
    echo -e "${RED}âŒ ERROR: æ— å·¥ä½œæµPhaseæ–‡ä»¶ï¼Œæ‹’ç»æäº¤${NC}"
    echo -e "${RED}å¿…é¡»å…ˆåˆå§‹åŒ–å·¥ä½œæµï¼š${NC}"
    echo "  1. åˆ›å»º.phaseç›®å½•: mkdir -p .phase"
    echo "  2. è®¾ç½®å½“å‰Phase: echo 'P3' > .phase/current"
    echo "  æˆ–ä½¿ç”¨å·¥ä½œæµæ‰§è¡Œå™¨ï¼š"
    echo "  bash .workflow/executor.sh init"
    exit 1
fi

current_phase=$(cat "$PHASE_FILE")
echo -e "${GREEN}âœ“ å½“å‰Phase: $current_phase${NC}"

# è‡ªåŠ¨åœ¨æäº¤ä¿¡æ¯å‰æ·»åŠ Phaseæ ‡è®°ï¼ˆå¦‚æœPhaseæ–‡ä»¶å­˜åœ¨ï¼‰
if [[ -f "$PHASE_FILE" ]] && ! [[ "$message" =~ ^\[P[0-7]\] ]]; then
    current_phase=$(cat "$PHASE_FILE")
    # è‡ªåŠ¨æ·»åŠ Phaseæ ‡è®°
    new_message="[$current_phase] $message"
    echo "$new_message" > "$commit_file"
    echo -e "${CYAN}âœ“ è‡ªåŠ¨æ·»åŠ Phaseæ ‡è®°: [$current_phase]${NC}"
    message="$new_message"
fi

# åˆ†æ”¯å‘½åè§„èŒƒæ£€æŸ¥ï¼ˆæ›´çµæ´»ï¼‰
# å…è®¸: feature/xxx, fix/xxx, docs/xxx, test/xxx, refactor/xxx, hotfix/xxx
if [[ "$BRANCH" =~ ^(feature|fix|docs|test|refactor|hotfix)/[a-zA-Z0-9_-]+$ ]] || \
   [[ "$BRANCH" =~ ^(feature|fix|docs|test|refactor)/PRD-[0-9]+-[a-z0-9-]+$ ]]; then
    echo -e "${GREEN}âœ… åˆ†æ”¯åç§°æœ‰æ•ˆ: $BRANCH${NC}"
elif [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == "master" ]]; then
    echo -e "${RED}âŒ ERROR: ç¦æ­¢ç›´æ¥æäº¤åˆ°ä¸»åˆ†æ”¯ï¼${NC}"
    echo "è¯·åˆ›å»ºfeatureåˆ†æ”¯è¿›è¡Œå¼€å‘ï¼š"
    echo "  git checkout -b feature/your-task-name"
    exit 1
else
    echo -e "${YELLOW}âš ï¸  WARNING: åˆ†æ”¯å‘½åä¸å¤Ÿè§„èŒƒ${NC}"
    echo "æ¨èæ ¼å¼: feature/task-name æˆ– feature/PRD-123-description"
    echo "å½“å‰åˆ†æ”¯: $BRANCH"
    # è­¦å‘Šä½†ä¸é˜»æ­¢
fi

# æ£€æŸ¥æäº¤ä¿¡æ¯é•¿åº¦
if [ ${#message} -lt 10 ]; then
    echo "âŒ æäº¤ä¿¡æ¯è¿‡çŸ­ï¼ˆè‡³å°‘10ä¸ªå­—ç¬¦ï¼‰"
    echo "å½“å‰é•¿åº¦: ${#message}"
    exit 1
fi

# æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ - æ”¯æŒPhaseæ ‡è®°
# æ ¼å¼1: [P0-7][action][T-XXX] description
# æ ¼å¼2: type(scope): description (ä¼ ç»Ÿæ ¼å¼)
if [[ "$message" =~ ^\[P[0-7]\]\[[a-z]+\](\[T-[0-9]+\])?\ .+ ]]; then
    # Phaseæ ¼å¼æäº¤
    echo "âœ… Phase-based commit format detected"

    # æå–å·¥å•å·ï¼ˆå¦‚æœæœ‰ï¼‰
    if [[ "$message" =~ \[T-([0-9]+)\] ]]; then
        TICKET="T-${BASH_REMATCH[1]}"
        # éªŒè¯å·¥å•æ˜¯å¦å­˜åœ¨
        if [ ! -f ".tickets/${TICKET}.todo" ] && [ ! -f ".tickets/${TICKET}.done" ]; then
            echo "âŒ ERROR: Ticket ${TICKET} not found in .tickets/"
            echo "Please create ticket first or check ticket number"
            exit 1
        fi
        echo "âœ… Ticket ${TICKET} verified"
    fi
elif [[ "$message" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?: ]]; then
    echo -e "${GREEN}âœ… ä¼ ç»Ÿæäº¤æ ¼å¼æ£€æµ‹é€šè¿‡${NC}"
    echo "æäº¤ä¿¡æ¯: $message"
else
    echo -e "${YELLOW}âš ï¸  æäº¤ä¿¡æ¯æ ¼å¼å»ºè®®${NC}"
    echo "æ¨èä½¿ç”¨ä»¥ä¸‹æ ¼å¼ä¹‹ä¸€ï¼š"
    echo "  1. type: description (å¦‚: feat: add login)"
    echo "  2. type(scope): description (å¦‚: fix(auth): resolve token issue)"
    echo ""
    echo "å½“å‰æäº¤ä¿¡æ¯: $message"
    # ä¸å¼ºåˆ¶ï¼Œç»§ç»­æ‰§è¡Œ
fi

# æ£€æŸ¥å½“å‰Phaseä¸æäº¤çš„ä¸€è‡´æ€§
if [ -f ".phase/current" ]; then
    CURRENT_PHASE=$(cat .phase/current)
    if [[ "$message" =~ ^\[P([0-7])\] ]]; then
        MSG_PHASE="P${BASH_REMATCH[1]}"
        if [ "$MSG_PHASE" != "$CURRENT_PHASE" ]; then
            echo "âš ï¸  Warning: Commit phase [$MSG_PHASE] doesn't match current phase [$CURRENT_PHASE]"
        fi
    fi
fi

echo "âœ… æäº¤ä¿¡æ¯æ£€æŸ¥é€šè¿‡"
exit 0
